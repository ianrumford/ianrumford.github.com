<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width initial-scale=1">

<meta property="og:title" content="Some notes on using Ruby handlers with mongrel2">
<title>Some notes on using Ruby handlers with mongrel2</title>
<meta property="og:description" content="The first version of mongrel was a well known, very quick and wellrespected web server.The author of mongrel1, Zed Shaw, has been working on version 2 for so...">
<meta property="og:url" content="http://www.rumford.name/mongrel/handler/ruby/2012/09/15/some-notes-on-using-ruby-handlers-with-mongrel2.html">
<meta property="og:site_name" content="An Ostler in IT">
<meta property="og:locale" content="en_UK">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ianrumford">
<meta name="twitter:creator" content="@ianrumford">
<meta name="twitter:title" content="Some notes on using Ruby handlers with mongrel2">
<meta name="twitter:description" content="The first version of mongrel was a well known, very quick and wellrespected web server.The author of mongrel1, Zed Shaw, has been working on version 2 for so...">
<meta name="twitter:url" content="http://www.rumford.name/mongrel/handler/ruby/2012/09/15/some-notes-on-using-ruby-handlers-with-mongrel2.html">

<meta name="keywords" content="IT Ostler Horses Courses">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://www.rumford.name/mongrel/handler/ruby/2012/09/15/some-notes-on-using-ruby-handlers-with-mongrel2.html">
<link rel="alternate" type="application/atom+xml" title="An Ostler in IT" href="http://www.rumford.name/feed.xml" />

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script language="Javascript" type="text/javascript">
function search_google()
{
  var query = document.getElementById("google-search").value;
  window.open("http://google.com/search?q=" + query
      + "%20site:" + "http://www.rumford.name");
}
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script type='text/javascript'>
var blocklink = ['http://humanorightswatch.org','http://o-o-6-o-o.com','http://darodar.com','http://blackhatworth.com','http://hulfingtonpost.com','http://bestwebsitesawards.com','http://darodar.com','http://buttons-for-website.com','http://ilovevitaly.co','http://semalt.com','http://priceg.com','http://simple-share-buttons.com','http://googlsucks.com','http://4webmasters.org','http://aliexpress.com','http://addons.mozilla.org/en-US/firefox/addon/ilovevitaly/','http://free-share-buttons.com','http://buttons-for-your-website.com','http://theguardlan.com','http://buy-cheap-online.info','http://best-seo-offer.com','http://4webmasters.org','http://trafficmonetize.org','http://howtostopreferralspam.eu','http://ilovevitaly.com','http://sanjosestartups.com','http://free-social-buttons.com','http://best-seo-offer.com','http://guardlink.org','http://www.event-tracking.com','http://www3.free-social-buttons.com','http://www1.free-social-buttons.com','http://www2.free-social-buttons.com','http://websites-reviews.com','http://floating-share-buttons.com','http://satellite.maps.ilovevitaly.com','http://free-social-buttons.com','http://www.event-tracking.com','http://erot.co'];
for (var b = blocklink.length; b--;) {
  if (document.referrer.match(blocklink[b]))
    window.location = "http://www.google.com";
}
</script>



<link type="application/atom+xml" rel="alternate" href="http://www.rumford.name/atom.xml" title="An Ostler in IT" />
</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">An Ostler in IT</a></h1>
    <h3 class="site-meta">Horses for Courses</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/"></a>
        
        
        
        <a class="page-link" href="/feed.xml"></a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 itemprop="name" class="post-title">Some notes on using Ruby handlers with mongrel2</h1>
    <meta itemprop="keywords" content="" />
    <p class="post-meta">
    Posted in
    
    <a href="/categories/#mongrel">mongrel</a>, 
    
    <a href="/categories/#handler">handler</a>, 
    
    <a href="/categories/#ruby">ruby</a>
     
    
    <time itemprop="datePublished" datetime="2012-09-15">
    on Sep 15, 2012
    </time>
    </p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <p>The first version of mongrel was a well known, very quick and well
respected web server.</p>

<p>The author of mongrel1, <a href="http://sheddingbikes.com/">Zed Shaw</a>, has been working on <a href="http://mongrel2.org/">version 2</a> for some time with the intention of addressing  the lessons he learnt developing mongrel1.</p>

<p>mongrel2 has some novel and compelling features that make it an ideal
and flexible centrepiece of a web environment.</p>

<!-- more -->

<h1 id="mongrel2-features">mongrel2 Features</h1>

<ul>
  <li>
    <p>excellent and quick http parsing</p>

    <p>The mongrels have correct and  fast http parsers written in C generated by <a href="http://www.complang.org/ragel/">Ragel</a>.</p>
  </li>
  <li>
    <p>http message processors (‘handlers’) are decoupled from mongrel2</p>

    <p>mongrel2 handlers do not execute in the mongrel2 address space and
 can be hosted / run on the same or a different host to mongrel2
 (anywhere network-reachable).</p>

    <p>Multiple instances of a handler can be configured and run for performance
 and / or reliability.</p>
  </li>
  <li>
    <p>use of ZeroMQ for the middleware layer</p>

    <p>One of mongrel2 most novel and compelling features is its use of
<a href="http://www.zeromq.org/">ZeroMQ</a> for the middleware
messaging layer for mongrel2 to handler communication.
ZeroMQ is a lightweight asynchronous message passing protocol implementation that presents the familiar socket interface.</p>
  </li>
  <li>
    <p>handlers can be written in most popular languages</p>

    <p>Using ZeroMQ enables  mongrel2 to be language-agnostic - as long as the
handler can “talk” ZeroMQ, it can communicate with mongrel2 successfully.
 ZeroMQ bindings already exist for most (all?) of the common scripting
 languages.</p>
  </li>
  <li>
    <p>easy to build reliable environments</p>

    <p>It would be straightforward to create a global lightweight mongrel
environment to serve current and future needs for intra and inter data
centre administration.</p>
  </li>
  <li>
    <p>frugal memory footprint</p>
  </li>
  <li>
    <p>source is available</p>

    <p>Usual suspect:  <a href="https://github.com/zedshaw/mongrel2">Github</a></p>
  </li>
</ul>

<h1 id="setting-up-mongrel2">Setting up mongrel2</h1>

<p>The mongrel2 <a href="http://mongrel2.org/static/mongrel2-manual.html">manual</a>
is very good and worth reading being both
comprehensive and well-written.</p>

<h2 id="prereqs">Prereqs</h2>

<p><a href="http://www.zeromq.org/">ZeroMQ</a> must be installed on the mongrel
server and on any server
running a handler. Some guidance on installing ZeroMQ can be found in another
<a href="http://ianrumford.github.com/blog/2012/09/12/installing-zeromq-2-dot-2-0-with-the-ruby-gem-on-ubuntu-12-dot-04/">post</a>.</p>

<p>The mongrel2 server needs some dependent packages; these work for me:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>sudo apt-get install libxml2-dev libxslt-dev<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="download">Download</h2>

<p>Download the
mongrel2 tarball from the <a href="https://github.com/zedshaw/mongrel2/tarball/v1.8.0">link</a> on <a href="https://github.com/zedshaw/mongrel2">Github</a>.</p>

<p>At the time of writing the latest version was 1.8.0.  (Note  the
link in the banner of the main 
<a href="http://www.mongrel2.org/">website</a> may be old.)</p>

<h2 id="build-and-install">Build and Install</h2>

<p>I recommend you read  the 
<a href="http://mongrel2.org/static/book-finalch3.html#x5-110002">installation</a>
chapter of
the manual but, briefly, its a standard, well-behaved make:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>wget https://github.com/zedshaw/mongrel2/tarball/v1.8.0
tar -xvf v1.8.0
<span class="nb">cd</span> ./zedshaw-mongrel2-bc721eb
make
sudo make install<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>mongrel2 installs into /usr/local</p>

<h1 id="configuration">Configuration</h1>

<p>Configuring mongrel2 for basic operation isn’t hard but again I would strongly encourage
you to read the 
<a href="http://mongrel2.org/static/book-finalch4.html#x6-210003">relevant</a>
chapter of
the manual - there is a wealth of information there.</p>

<p>Section 3.3 (‘Source 8’) give a simple example (given below) of a text-based
configuration and section 3.4 begins the explanation of what the
elements mean and do.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre>main <span class="o">=</span> Server<span class="o">(</span> 
    <span class="nv">uuid</span><span class="o">=</span><span class="s2">"f400bf85-4538-4f7a-8908-67e313d515c2"</span>, 
    <span class="nv">access_log</span><span class="o">=</span><span class="s2">"/logs/access.log"</span>, 
    <span class="nv">error_log</span><span class="o">=</span><span class="s2">"/logs/error.log"</span>, 
    <span class="nv">chroot</span><span class="o">=</span><span class="s2">"./"</span>, 
    <span class="nv">default_host</span><span class="o">=</span><span class="s2">"localhost"</span>, 
    <span class="nv">name</span><span class="o">=</span><span class="s2">"test"</span>, 
    <span class="nv">pid_file</span><span class="o">=</span><span class="s2">"/run/mongrel2.pid"</span>, 
    <span class="nv">port</span><span class="o">=</span>6767, 
    hosts <span class="o">=</span> <span class="o">[</span> 
        Host<span class="o">(</span><span class="nv">name</span><span class="o">=</span><span class="s2">"localhost"</span>, <span class="nv">routes</span><span class="o">={</span> 
            ’/tests/’: Dir<span class="o">(</span><span class="nv">base</span><span class="o">=</span>’tests/’, <span class="nv">index_file</span><span class="o">=</span>’index.html’, 
                             <span class="nv">default_ctype</span><span class="o">=</span>’text/plain’<span class="o">)</span> 
        <span class="o">})</span> 
    <span class="o">]</span> 
<span class="o">)</span> 
 
servers <span class="o">=</span> <span class="o">[</span>main]<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>mongrel2 has a  utility command <em>m2sh</em> to <em>load</em> a text-based
configuration into its internal (sqlite) database format.  For example,
if the above configuration were to be stored in <em>./config/test1.conf</em>, the
following command would  create the sqlite database in <em>./db/test1.sqlite</em>.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>m2sh load -config ./config/test1.conf --db ./db/test1.sqlite<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="starting-and-stopping-mongrel2">Starting and stopping mongrel2</h1>

<p>m2sh does the honours again, for example using the database created
above, mongrel2 could be started by this command:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>m2sh start --db ./db/test1.sqlite -host localhost -sudo<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>m2sh to stop as well:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>m2sh stop --db ./db/test1.sqlite -host localhost<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="example---a-ruby-data-acquisition-handler">Example - A Ruby data acquisition handler</h1>

<p>I was
interested in handlers written in Ruby and found some useful links <em>out there</em> especially one by Carson McDonald that gave me a great heads up
on writing a
<a href="http://www.ioncannon.net/programming/1384/example-mongrel2-handler-in-ruby/">mongrel2 handler in Ruby</a>.
Thanks Carson!</p>

<p>The context for my example is
data acquisition:   accepting HTTP requests with useful payloads from
many sources, extracting
the useful data and loading it into rows in a relational database
(MySQL) table.</p>

<p>In Carson’s code mongrel2 and the handler were collocated on the same
server, in mine they aren’t.  In my scenario, curl acts as the http  client sending requests to
mongrel2 running on one server (192.168.16.200; ports
9994 &amp; 9995) which
contacts a handler running on another server (ports 9994 &amp; 9995)
which in turn write to table in a mysql database running on another
server.</p>

<p>This topology shows the flexibility of running the various components
wherever is most appropriate; in fact, it may make more sense in this case to run
the handler on the database server.  You decide.</p>

<p>I don’t have any rigorous or quantative performance figures but even
on my desktop running all three servers as VirtualBox guests.
the solution processed a very respectable number of requests per
second.</p>

<p>Note I wouldn’t claim this code or setup is anywhere near production quality -
proof of concept only (as witness the debug statements I’ve left in).</p>

<h1 id="configure-mongrel2-for-the-data-acquisition-handler">Configure mongrel2 for the data acquisition handler</h1>

<p>Note 1: the configuration uses ports 9994 &amp; 9995 for the mongrel2 to handler
communication.</p>

<p>Note 2: mongrel2 does <em>not</em> need to know the dns name or
ip address of the handler’s server:  mongrel2 does <em>not</em> need to know
beforehand where the handler is running - the
handler connects to mongrel2, not the other way around.</p>

<p>Note 3: mongrel2 listens for client requests on port 6767 in this configuration;
change to e.g. 80 for the usual, conventional operation.</p>

<p>Note 4: The <em>send_ident</em> would usually be a  UUID but it can be
any string (but not very secure).</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre><span class="c"># mongrel2 config for data acquisition  handler storing into MySQL</span>

<span class="c"># Lots of ideas and code from Carson McDonald (http://www.ioncannon.net/programming/1384/example-mongrel2-handler-in-ruby/)</span>

<span class="c"># the connection to the handler</span>

<span class="c"># N.B.  use the IP address of the mongrel server </span>
<span class="c">#       becuase (remote) handler will bind to that IP</span>

handler_mysql <span class="o">=</span> Handler<span class="o">(</span><span class="nv">send_spec</span><span class="o">=</span><span class="s1">'tcp://192.168.16.200:9995'</span>, 
                        <span class="nv">send_ident</span><span class="o">=</span><span class="s1">'HANDLER-MYSQL-9995-9994'</span>, 
                        <span class="nv">recv_spec</span><span class="o">=</span><span class="s1">'tcp://192.168.16.200:9994'</span>, <span class="nv">recv_ident</span><span class="o">=</span><span class="s1">''</span><span class="o">)</span> 

<span class="c"># the host </span>

mongrel2 <span class="o">=</span> Host<span class="o">(</span><span class="nv">name</span><span class="o">=</span><span class="s2">"daq_mongrel2"</span>, <span class="nv">routes</span><span class="o">={</span>
  <span class="s1">'/mysql'</span>: handler_mysql 
<span class="o">})</span> 

<span class="c"># the server to run the host</span>

main <span class="o">=</span> Server<span class="o">(</span> 
  <span class="nv">uuid</span><span class="o">=</span><span class="s2">"2f62bd5-9e59-49cd-993c-3b6013c28f05"</span>, 
  <span class="nv">access_log</span><span class="o">=</span><span class="s2">"/logs/access.log"</span>, 
  <span class="nv">error_log</span><span class="o">=</span><span class="s2">"/logs/error.log"</span>, 
  <span class="nv">chroot</span><span class="o">=</span><span class="s2">"./"</span>, 
  <span class="nv">pid_file</span><span class="o">=</span><span class="s2">"/run/mongrel2.pid"</span>, 
  <span class="nv">default_host</span><span class="o">=</span><span class="s2">"daq_mongrel2"</span>, 
  <span class="nv">name</span><span class="o">=</span><span class="s2">"main"</span>, 
  <span class="nv">port</span><span class="o">=</span>6767, 
  <span class="nv">hosts</span><span class="o">=[</span>mongrel2] 
<span class="o">)</span> 

settings <span class="o">=</span> <span class="o">{</span><span class="s2">"zeromq.threads"</span>: 1<span class="o">}</span> 

servers <span class="o">=</span> <span class="o">[</span>main]<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="start-mongrel2">Start mongrel2</h1>

<p>On the mongrel server, cd to (e.g.) the <em>chroot</em> folder and save the above in <em>./config/ruby_data_capture1.conf</em>
 and load into into
the sqlite database:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>m2sh load -config ./config/ruby_data_capture1.conf --db ./db/ruby_data_capture1.sqlite<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Note the <em>chroot</em> statement in the configuration, when mongrel2 starts
it will chroot to that directory.</p>

<p>Start mongrel2</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>m2sh start --db ./db/ruby_data_capture1.sqlite -host daq_mongrel2 -sudo<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>You will be prompted for your password.</p>

<p>One mongrel2 has started ok, you will be able to see it listening on
the two ports</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>netstat -antp

Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 192.168.16.200:9994     0.0.0.0:<span class="k">*</span>               LISTEN      -               
tcp        0      0 192.168.16.200:9995     0.0.0.0:<span class="k">*</span>               LISTEN      -               

etc<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Either mongrel2 or the handler can be started first.  Until mongrel2
has a client’s request for the handler, it will not attempt to contact it.</p>

<h1 id="starting-the-ruby-data-capture-handler">Starting the Ruby data capture handler</h1>

<p>On the handler server, save the following ruby script into e.g.
<em>ruby_data_capture1.rb</em>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre></td><td class="code"><pre><span class="c1"># mongrel2 data acquisition handler capturing data into MySQL</span>

<span class="c1"># Lots of ideas and code from Carson McDonald (http://www.ioncannon.net/programming/1384/example-mongrel2-handler-in-ruby/)</span>

<span class="nb">require</span> <span class="s1">'zmq'</span>
<span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'mysql2'</span>

<span class="n">eye</span> <span class="o">=</span> <span class="s1">'DAQ MySQL 1'</span>

<span class="n">mongrel2Server</span> <span class="o">=</span> <span class="s1">'192.168.16.200'</span>

<span class="n">recvPort</span> <span class="o">=</span> <span class="s1">'9995'</span>
<span class="n">respPort</span> <span class="o">=</span> <span class="s1">'9994'</span>

<span class="n">recvURL</span> <span class="o">=</span> <span class="s2">"tcp://</span><span class="si">#{</span><span class="n">mongrel2Server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">recvPort</span><span class="si">}</span><span class="s2">"</span>
<span class="n">respURL</span> <span class="o">=</span> <span class="s2">"tcp://</span><span class="si">#{</span><span class="n">mongrel2Server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">respPort</span><span class="si">}</span><span class="s2">"</span>

<span class="n">mysqlHost</span> <span class="o">=</span> <span class="s1">'mysqlvm1'</span>
<span class="n">mysqlUser</span> <span class="o">=</span> <span class="s1">'root'</span>
<span class="n">mysqlPass</span> <span class="o">=</span> <span class="s1">'sa'</span>

<span class="n">mysqlDBName</span> <span class="o">=</span> <span class="s1">'samples'</span> <span class="c1"># mysql database name</span>
<span class="n">mysqlTBName</span> <span class="o">=</span> <span class="s1">'sampledata'</span> <span class="c1"># mysql table name</span>

<span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> STARTED"</span><span class="p">)</span>

<span class="c1">#useMySQL = false  # dont drive MySQL</span>
<span class="n">useMySQL</span> <span class="o">=</span> <span class="kp">true</span>   <span class="c1"># drive MySQL</span>

<span class="n">dbConn</span> <span class="o">=</span> <span class="k">case</span> <span class="n">useMySQL</span>
         <span class="k">when</span> <span class="no">TrueClass</span> <span class="k">then</span>
           <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> CONNECTNG TO MYSQL db &gt;</span><span class="si">#{</span><span class="n">mysqlDBName</span><span class="si">}</span><span class="s2">&lt; table &gt;</span><span class="si">#{</span><span class="n">mysqlTBName</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>
           <span class="n">r</span> <span class="o">=</span> <span class="k">begin</span>

                 <span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">mysqlHost</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="n">mysqlDBName</span><span class="p">,</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">mysqlUser</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">mysqlPass</span><span class="p">)</span>
               <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
                 <span class="nb">puts</span><span class="p">(</span><span class="s2">"Exception on MySQL connection establishment e &gt;</span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>
                 <span class="k">raise</span>
               <span class="k">ensure</span>
                 <span class="c1">#con.close if con</span>
               <span class="k">end</span>
           <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> CONNECTED TO MYSQL db &gt;</span><span class="si">#{</span><span class="n">mysqlDBName</span><span class="si">}</span><span class="s2">&lt; table &gt;</span><span class="si">#{</span><span class="n">mysqlTBName</span><span class="si">}</span><span class="s2">&lt; con &gt;</span><span class="si">#{</span><span class="n">r</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">&lt; &gt;</span><span class="si">#{</span><span class="n">r</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>
           <span class="n">r</span>
         <span class="k">else</span>
           <span class="kp">nil</span>
         <span class="k">end</span>

<span class="n">handler_thread</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  
  <span class="n">handler_ctx</span> <span class="o">=</span> <span class="no">ZMQ</span><span class="o">::</span><span class="no">Context</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  
  <span class="n">receive_queue</span> <span class="o">=</span> <span class="n">handler_ctx</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="no">ZMQ</span><span class="o">::</span><span class="no">PULL</span><span class="p">)</span>
  <span class="n">receive_queue</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">recvURL</span><span class="p">)</span>
  
  <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> RECV X1 recvURL &gt;</span><span class="si">#{</span><span class="n">recvURL</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>
  
  <span class="n">response_publisher</span> <span class="o">=</span> <span class="n">handler_ctx</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="no">ZMQ</span><span class="o">::</span><span class="no">PUB</span><span class="p">)</span>
  <span class="n">response_publisher</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">respURL</span><span class="p">)</span>

  <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> RESP X1 respURL &gt;</span><span class="si">#{</span><span class="n">respURL</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>
  
  <span class="n">response_publisher</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="no">ZMQ</span><span class="o">::</span><span class="no">IDENTITY</span><span class="p">,</span> <span class="s2">"82209006-86FF-4982-B5EA-D1E29E55D481"</span><span class="p">)</span>
  
  <span class="n">stop_queue</span> <span class="o">=</span> <span class="n">handler_ctx</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="no">ZMQ</span><span class="o">::</span><span class="no">PULL</span><span class="p">)</span>
  <span class="n">stop_queue</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s2">"ipc://shutdown_queue"</span><span class="p">)</span>
  
  <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> STOP X1"</span><span class="p">)</span>
  
  <span class="n">stopped</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">until</span> <span class="n">stopped</span> <span class="k">do</span>
    <span class="n">selected_queue</span> <span class="o">=</span> <span class="no">ZMQ</span><span class="p">.</span><span class="nf">select</span><span class="p">([</span><span class="n">receive_queue</span><span class="p">,</span> <span class="n">stop_queue</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">selected_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stop_queue</span> <span class="c1"># Anything on the stop_queue ends processing</span>
      <span class="n">stop_queue</span><span class="p">.</span><span class="nf">close</span>
      <span class="n">receive_queue</span><span class="p">.</span><span class="nf">close</span>
      <span class="n">response_publisher</span><span class="p">.</span><span class="nf">close</span>
      <span class="n">handler_ctx</span><span class="p">.</span><span class="nf">close</span>
      <span class="n">stopped</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">else</span>
      <span class="c1"># Request comes in as "UUID ID PATH SIZE:HEADERS,SIZE:BODY,"</span>
      <span class="n">sender_uuid</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">request_path</span><span class="p">,</span> <span class="n">request_message</span> <span class="o">=</span> <span class="n">receive_queue</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
      <span class="n">len</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">request_message</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">headers</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">len</span><span class="p">.</span><span class="nf">to_i</span><span class="p">])</span>
      <span class="n">len</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[(</span><span class="n">len</span><span class="p">.</span><span class="nf">to_i</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nf">.</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">len</span><span class="p">.</span><span class="nf">to_i</span><span class="p">]</span>

<span class="c1">#=begin</span>
      <span class="k">begin</span>
        <span class="n">client_id_size</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%d"</span><span class="p">,</span> <span class="n">client_id</span><span class="p">).</span><span class="nf">size</span>
        <span class="n">request_query</span> <span class="o">=</span> <span class="n">request_message</span><span class="p">[</span><span class="s1">'QUERY'</span><span class="p">]</span>
        <span class="n">post_uri</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">'URI'</span><span class="p">]</span>
        <span class="n">post_pattern</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">'PATTERN'</span><span class="p">]</span>
      <span class="k">end</span>
<span class="c1">#=end</span>
      <span class="n">post_values</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">[</span><span class="o">*</span><span class="n">body</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">,</span><span class="s1">'='</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)]</span>
      
      <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> RECV X3 post_values &gt;</span><span class="si">#{</span><span class="n">post_values</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">&lt; &gt;</span><span class="si">#{</span><span class="n">post_values</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span> 
      
      <span class="n">useMySQL</span> <span class="o">&amp;&amp;</span> <span class="k">begin</span>
                    
                    <span class="n">keyNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'('</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">r</span> <span class="o">=</span> <span class="n">post_values</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="s1">','</span><span class="p">]</span><span class="si">}</span><span class="s2">.flatten; r.pop; r.join}"</span><span class="p">,</span> <span class="s1">')'</span><span class="p">].</span><span class="nf">join</span> 
                    
                    <span class="c1"># can quote ints - MySQL will cast      </span>

                    <span class="n">keyValues</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'('</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">r</span> <span class="o">=</span> <span class="n">post_values</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="p">[</span><span class="s1">'"'</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">,</span> <span class="s1">','</span><span class="p">]</span><span class="si">}</span><span class="s2">.flatten; r.pop; r.join}"</span><span class="p">,</span> <span class="s1">')'</span><span class="p">].</span><span class="nf">join</span>                    

                    <span class="n">insertCommand</span> <span class="o">=</span> <span class="s2">"INSERT INTO </span><span class="si">#{</span><span class="n">mysqlTBName</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">keyNames</span><span class="si">}</span><span class="s2"> VALUES </span><span class="si">#{</span><span class="n">keyValues</span><span class="si">}</span><span class="s2">;"</span>
                    
                    <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> INSERT keyNames &gt;</span><span class="si">#{</span><span class="n">keyNames</span><span class="si">}</span><span class="s2">&lt; keyValues &gt;</span><span class="si">#{</span><span class="n">keyValues</span><span class="si">}</span><span class="s2"> insertCommand &gt;</span><span class="si">#{</span><span class="n">insertCommand</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>      
                    
                    <span class="kp">true</span> <span class="o">&amp;&amp;</span> <span class="k">begin</span>
                      <span class="n">dbConn</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">insertCommand</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>                
                    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
                       <span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> MySQL INSERT EXCEPTION e &gt;</span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>
                      <span class="k">raise</span>
                    <span class="k">end</span>
                    
                  <span class="k">end</span>
      
      <span class="c1">#puts("#{eye} RECV X2 sender_uuid &gt;#{sender_uuid}&lt; client_id &gt;#{client_id_size}&lt; &gt;#{client_id}&lt; request_path &gt;#{request_path}&lt; request_query &gt;#{request_query}&lt; request_message &gt;#{request_message.class}&lt; &gt;#{request_message}&lt;")</span>
      
      <span class="k">if</span> <span class="n">headers</span><span class="p">[</span><span class="s1">'METHOD'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'JSON'</span> <span class="n">and</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">body</span><span class="p">)[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'disconnect'</span>
        <span class="k">next</span> <span class="c1"># A client has disconnected, might want to do something here...</span>
      <span class="k">end</span>
      
      <span class="c1"># Response goes out as "UUID SIZE:ID ID ID, BODY"</span>
      <span class="c1">#content_body = "Hello world!"</span>
      <span class="n">content_body</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> client_id &gt;</span><span class="si">#{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">&lt;</span><span class="se">\n</span><span class="s2">"</span>
      <span class="c1">#response_value = "#{sender_uuid} 1:#{client_id}, HTTP/1.1 200 OK\r\nContent-Length: #{content_body.size}\r\n\r\n#{content_body}"</span>
      <span class="n">response_value</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">sender_uuid</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">client_id_size</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">, HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">Content-Length: </span><span class="si">#{</span><span class="n">content_body</span><span class="p">.</span><span class="nf">size</span><span class="si">}</span><span class="se">\r\n\r\n</span><span class="si">#{</span><span class="n">content_body</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">response_publisher</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">response_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="no">ZMQ</span><span class="o">::</span><span class="no">Context</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">stop_push_queue</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="no">ZMQ</span><span class="o">::</span><span class="no">PUSH</span><span class="p">)</span>
<span class="nb">trap</span><span class="p">(</span><span class="s1">'INT'</span><span class="p">)</span> <span class="k">do</span> <span class="c1"># Send a message to shutdown on SIGINT</span>
  <span class="n">stop_push_queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="s2">"ipc://shutdown_queue"</span><span class="p">)</span>
  <span class="n">stop_push_queue</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s2">"shutdown"</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">handler_thread</span><span class="p">.</span><span class="nf">join</span>

<span class="n">stop_push_queue</span><span class="p">.</span><span class="nf">close</span>

<span class="nb">puts</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">eye</span><span class="si">}</span><span class="s2"> FINSIHED"</span><span class="p">)</span>

<span class="cp">__END__</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Start the handler as you’d expect:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>ruby ./ruby_data_capture1.rb<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>You will see some initial diagnostics but then it will go quiet.</p>

<h1 id="create-the-mysql-database-and-table">Create the MySQL database and table</h1>

<p>Needs only be done once of course.  I use a simple Ruby script e.g.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/ruby</span>

<span class="nb">require</span> <span class="s1">'mysql2'</span>

<span class="n">mysqlHost</span> <span class="o">=</span> <span class="s1">'mysqlvm1'</span>
<span class="n">mysqlUser</span> <span class="o">=</span> <span class="s1">'root'</span>
<span class="n">mysqlPass</span> <span class="o">=</span> <span class="s1">'sa'</span>

<span class="n">mysqlDBName</span> <span class="o">=</span> <span class="s1">'samples'</span>
<span class="n">mysqlTBName</span> <span class="o">=</span> <span class="s1">'sampledata'</span>

<span class="c1">#puts("\n"*10)</span>

<span class="n">createTBTextNom</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">"EOH"</span><span class="sh">
        (
         id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
         name VARCHAR(100),
         age INT,
         sex VARCHAR(1),
         dose INT,
         responsea INT,
         responseb INT,
         weight INT,
         colour VARCHAR(20),
         state VARCHAR(10)
       )
</span><span class="no">EOH</span>

<span class="n">createTBText</span> <span class="o">=</span> <span class="n">createTBTextNom</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span>
<span class="n">createTBText</span> <span class="o">=</span> <span class="n">createTBTextNom</span>
<span class="n">createTBText</span> <span class="o">=</span> <span class="n">createTBTextNom</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">).</span><span class="nf">compact</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">).</span><span class="nf">join</span>

<span class="nb">puts</span><span class="p">(</span><span class="s2">"CREATNG TABLE &gt;</span><span class="si">#{</span><span class="n">createTBText</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>

<span class="k">begin</span>
  <span class="n">dbConn</span> <span class="o">=</span> <span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">mysqlHost</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="n">mysqlDBName</span><span class="p">,</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">mysqlUser</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">mysqlPass</span><span class="p">)</span>
  <span class="n">dbConn</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="s2">"DROP TABLE IF EXISTS </span><span class="si">#{</span><span class="n">mysqlTBName</span><span class="si">}</span><span class="s2">;"</span><span class="p">)</span>
  <span class="n">dbConn</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="s2">"CREATE TABLE IF NOT EXISTS </span><span class="si">#{</span><span class="n">mysqlTBName</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">createTBText</span><span class="si">}</span><span class="s2">;"</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span><span class="p">(</span><span class="s2">"e &gt;</span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>
  <span class="c1">#puts e.error</span>
<span class="k">ensure</span>
  <span class="c1">#con.close if con</span>
<span class="k">end</span>

<span class="nb">puts</span><span class="p">(</span><span class="s2">"CREATED TABLE &gt;</span><span class="si">#{</span><span class="n">createTBText</span><span class="si">}</span><span class="s2">&lt;"</span><span class="p">)</span>

<span class="cp">__END__</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="fire-some-client-requests-at-mongrel2">Fire some client requests at mongrel2</h1>

<p>I have a simple script with a number of curls in e.g.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c">#!/bin/sh -e</span>
curl http://192.168.16.200:6767/mysql/samples/1 -d <span class="s1">'age=41'</span> -d <span class="s1">'name=joe'</span> -d <span class="s1">'colour=red'</span> -d <span class="s1">'state=ill'</span> -d <span class="s1">'sex=F'</span> -d <span class="s1">'weight=98'</span> -d <span class="s1">'dose=82'</span> -d <span class="s1">'responsea=20'</span> -d <span class="s1">'responseb=19'</span>
curl http://192.168.16.200:6767/mysql/samples/2 -d <span class="s1">'age=14'</span> -d <span class="s1">'name=jane'</span> -d <span class="s1">'colour=blue'</span> -d <span class="s1">'state=nomore'</span> -d <span class="s1">'sex=F'</span> -d <span class="s1">'weight=138'</span> -d <span class="s1">'dose=3'</span> -d <span class="s1">'responsea=31'</span> -d <span class="s1">'responseb=36'</span>
curl http://192.168.16.200:6767/mysql/samples/3 -d <span class="s1">'age=98'</span> -d <span class="s1">'name=fred'</span> -d <span class="s1">'colour=red'</span> -d <span class="s1">'state=ok'</span> -d <span class="s1">'sex=M'</span> -d <span class="s1">'weight=179'</span> -d <span class="s1">'dose=9'</span> -d <span class="s1">'responsea=13'</span> -d <span class="s1">'responseb=19'</span>
curl http://192.168.16.200:6767/mysql/samples/4 -d <span class="s1">'age=73'</span> -d <span class="s1">'name=jane'</span> -d <span class="s1">'colour=blue'</span> -d <span class="s1">'state=ill'</span> -d <span class="s1">'sex=M'</span> -d <span class="s1">'weight=74'</span> -d <span class="s1">'dose=72'</span> -d <span class="s1">'responsea=6'</span> -d <span class="s1">'responseb=56'</span>
curl http://192.168.16.200:6767/mysql/samples/5 -d <span class="s1">'age=64'</span> -d <span class="s1">'name=lucy'</span> -d <span class="s1">'colour=yellow'</span> -d <span class="s1">'state=find'</span> -d <span class="s1">'sex=M'</span> -d <span class="s1">'weight=13'</span> -d <span class="s1">'dose=69'</span> -d <span class="s1">'responsea=44'</span> -d <span class="s1">'responseb=40'</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>On the handler server, you will see the diagnostic <em>puts</em> e.g.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre>DAQ MySQL 1 INSERT keyNames &gt;<span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span>&lt; keyValues &gt;<span class="o">(</span><span class="s2">"41"</span>,<span class="s2">"joe"</span>,<span class="s2">"red"</span>,<span class="s2">"ill"</span>,<span class="s2">"F"</span>,<span class="s2">"98"</span>,<span class="s2">"82"</span>,<span class="s2">"20"</span>,<span class="s2">"19"</span><span class="o">)</span> insertCommand &gt;INSERT INTO sampledata <span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span> VALUES <span class="o">(</span><span class="s2">"41"</span>,<span class="s2">"joe"</span>,<span class="s2">"red"</span>,<span class="s2">"ill"</span>,<span class="s2">"F"</span>,<span class="s2">"98"</span>,<span class="s2">"82"</span>,<span class="s2">"20"</span>,<span class="s2">"19"</span><span class="o">)</span>;
DAQ MySQL 1 RECV X3 post_values &gt;Hash&lt; &gt;<span class="o">{</span><span class="s2">"age"</span><span class="o">=</span>&gt;<span class="s2">"14"</span>, <span class="s2">"name"</span><span class="o">=</span>&gt;<span class="s2">"jane"</span>, <span class="s2">"colour"</span><span class="o">=</span>&gt;<span class="s2">"blue"</span>, <span class="s2">"state"</span><span class="o">=</span>&gt;<span class="s2">"nomore"</span>, <span class="s2">"sex"</span><span class="o">=</span>&gt;<span class="s2">"F"</span>, <span class="s2">"weight"</span><span class="o">=</span>&gt;<span class="s2">"138"</span>, <span class="s2">"dose"</span><span class="o">=</span>&gt;<span class="s2">"3"</span>, <span class="s2">"responsea"</span><span class="o">=</span>&gt;<span class="s2">"31"</span>, <span class="s2">"responseb"</span><span class="o">=</span>&gt;<span class="s2">"36"</span><span class="o">}</span>&lt;
DAQ MySQL 1 INSERT keyNames &gt;<span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span>&lt; keyValues &gt;<span class="o">(</span><span class="s2">"14"</span>,<span class="s2">"jane"</span>,<span class="s2">"blue"</span>,<span class="s2">"nomore"</span>,<span class="s2">"F"</span>,<span class="s2">"138"</span>,<span class="s2">"3"</span>,<span class="s2">"31"</span>,<span class="s2">"36"</span><span class="o">)</span> insertCommand &gt;INSERT INTO sampledata <span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span> VALUES <span class="o">(</span><span class="s2">"14"</span>,<span class="s2">"jane"</span>,<span class="s2">"blue"</span>,<span class="s2">"nomore"</span>,<span class="s2">"F"</span>,<span class="s2">"138"</span>,<span class="s2">"3"</span>,<span class="s2">"31"</span>,<span class="s2">"36"</span><span class="o">)</span>;
DAQ MySQL 1 RECV X3 post_values &gt;Hash&lt; &gt;<span class="o">{</span><span class="s2">"age"</span><span class="o">=</span>&gt;<span class="s2">"98"</span>, <span class="s2">"name"</span><span class="o">=</span>&gt;<span class="s2">"fred"</span>, <span class="s2">"colour"</span><span class="o">=</span>&gt;<span class="s2">"red"</span>, <span class="s2">"state"</span><span class="o">=</span>&gt;<span class="s2">"ok"</span>, <span class="s2">"sex"</span><span class="o">=</span>&gt;<span class="s2">"M"</span>, <span class="s2">"weight"</span><span class="o">=</span>&gt;<span class="s2">"179"</span>, <span class="s2">"dose"</span><span class="o">=</span>&gt;<span class="s2">"9"</span>, <span class="s2">"responsea"</span><span class="o">=</span>&gt;<span class="s2">"13"</span>, <span class="s2">"responseb"</span><span class="o">=</span>&gt;<span class="s2">"19"</span><span class="o">}</span>&lt;
DAQ MySQL 1 INSERT keyNames &gt;<span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span>&lt; keyValues &gt;<span class="o">(</span><span class="s2">"98"</span>,<span class="s2">"fred"</span>,<span class="s2">"red"</span>,<span class="s2">"ok"</span>,<span class="s2">"M"</span>,<span class="s2">"179"</span>,<span class="s2">"9"</span>,<span class="s2">"13"</span>,<span class="s2">"19"</span><span class="o">)</span> insertCommand &gt;INSERT INTO sampledata <span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span> VALUES <span class="o">(</span><span class="s2">"98"</span>,<span class="s2">"fred"</span>,<span class="s2">"red"</span>,<span class="s2">"ok"</span>,<span class="s2">"M"</span>,<span class="s2">"179"</span>,<span class="s2">"9"</span>,<span class="s2">"13"</span>,<span class="s2">"19"</span><span class="o">)</span>;
DAQ MySQL 1 RECV X3 post_values &gt;Hash&lt; &gt;<span class="o">{</span><span class="s2">"age"</span><span class="o">=</span>&gt;<span class="s2">"73"</span>, <span class="s2">"name"</span><span class="o">=</span>&gt;<span class="s2">"jane"</span>, <span class="s2">"colour"</span><span class="o">=</span>&gt;<span class="s2">"blue"</span>, <span class="s2">"state"</span><span class="o">=</span>&gt;<span class="s2">"ill"</span>, <span class="s2">"sex"</span><span class="o">=</span>&gt;<span class="s2">"M"</span>, <span class="s2">"weight"</span><span class="o">=</span>&gt;<span class="s2">"74"</span>, <span class="s2">"dose"</span><span class="o">=</span>&gt;<span class="s2">"72"</span>, <span class="s2">"responsea"</span><span class="o">=</span>&gt;<span class="s2">"6"</span>, <span class="s2">"responseb"</span><span class="o">=</span>&gt;<span class="s2">"56"</span><span class="o">}</span>&lt;
DAQ MySQL 1 INSERT keyNames &gt;<span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span>&lt; keyValues &gt;<span class="o">(</span><span class="s2">"73"</span>,<span class="s2">"jane"</span>,<span class="s2">"blue"</span>,<span class="s2">"ill"</span>,<span class="s2">"M"</span>,<span class="s2">"74"</span>,<span class="s2">"72"</span>,<span class="s2">"6"</span>,<span class="s2">"56"</span><span class="o">)</span> insertCommand &gt;INSERT INTO sampledata <span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span> VALUES <span class="o">(</span><span class="s2">"73"</span>,<span class="s2">"jane"</span>,<span class="s2">"blue"</span>,<span class="s2">"ill"</span>,<span class="s2">"M"</span>,<span class="s2">"74"</span>,<span class="s2">"72"</span>,<span class="s2">"6"</span>,<span class="s2">"56"</span><span class="o">)</span>;
DAQ MySQL 1 RECV X3 post_values &gt;Hash&lt; &gt;<span class="o">{</span><span class="s2">"age"</span><span class="o">=</span>&gt;<span class="s2">"64"</span>, <span class="s2">"name"</span><span class="o">=</span>&gt;<span class="s2">"lucy"</span>, <span class="s2">"colour"</span><span class="o">=</span>&gt;<span class="s2">"yellow"</span>, <span class="s2">"state"</span><span class="o">=</span>&gt;<span class="s2">"find"</span>, <span class="s2">"sex"</span><span class="o">=</span>&gt;<span class="s2">"M"</span>, <span class="s2">"weight"</span><span class="o">=</span>&gt;<span class="s2">"13"</span>, <span class="s2">"dose"</span><span class="o">=</span>&gt;<span class="s2">"69"</span>, <span class="s2">"responsea"</span><span class="o">=</span>&gt;<span class="s2">"44"</span>, <span class="s2">"responseb"</span><span class="o">=</span>&gt;<span class="s2">"40"</span><span class="o">}</span>&lt;
DAQ MySQL 1 INSERT keyNames &gt;<span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span>&lt; keyValues &gt;<span class="o">(</span><span class="s2">"64"</span>,<span class="s2">"lucy"</span>,<span class="s2">"yellow"</span>,<span class="s2">"find"</span>,<span class="s2">"M"</span>,<span class="s2">"13"</span>,<span class="s2">"69"</span>,<span class="s2">"44"</span>,<span class="s2">"40"</span><span class="o">)</span> insertCommand &gt;INSERT INTO sampledata <span class="o">(</span>age,name,colour,state,sex,weight,dose,responsea,responseb<span class="o">)</span> VALUES <span class="o">(</span><span class="s2">"64"</span>,<span class="s2">"lucy"</span>,<span class="s2">"yellow"</span>,<span class="s2">"find"</span>,<span class="s2">"M"</span>,<span class="s2">"13"</span>,<span class="s2">"69"</span>,<span class="s2">"44"</span>,<span class="s2">"40"</span><span class="o">)</span>;<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>On the MySQL server, in a mysql session, you will be able to see the
row count increase and the contents of the rows e.g.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>use samples;
<span class="k">select </span>count<span class="o">(</span>s<span class="o">)</span> from sampledata;
<span class="k">select</span> <span class="k">*</span> from sampledata;<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="final-words">Final Words</h1>

<p>This is / was a fairly trivial - albeit useful - example of how
mongrel2 can be used.</p>

<p>But it does demonstrate clearly the flexability and utility of the
mongrel2 architecture, especially Zed’s <em>great idea</em> of using
ZeroMQ for the middleware, messaging layer allowing for
language-agnostics handlers and whatever topology works best.</p>

  </article>
  <hr />
</div>


<section class="pager">
  <ul>
    
    <li class="previous"><a href="/2012/09/12/installing-zeromq-2-dot-2-0-with-the-ruby-gem-on-ubuntu-12-dot-04.html" title="Installing ZeroMQ 2.2.0 with the Ruby gem on Ubuntu 12.04">&larr; Older</a></li>
    
    
    <li class="next"><a href="/2012/09/15/a-service-oriented-administrative-architecture.html" title="A service-oriented administrative architecture">Newer &rarr;</a></li>
    
  </ul>
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://www.rumford.name/2012/09/12/installing-zeromq-2-dot-2-0-with-the-ruby-gem-on-ubuntu-12-dot-04.html';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://www.rumford.name/2012/09/15/a-service-oriented-administrative-architecture.html';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



<div id="disqus_thread"></div>

<script type="text/javascript">

  var disqus_developer = 1;

var disqus_shortname ='';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    <section class="pager">
  
  
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Whistlejacket" src="/images/whistlejacket-circle-128px-2.png" alt="Whistlejacket"/>
  <span>Ian Rumford's whisperings</span>
  <br />

  

  You can contact me via: <br />

  
  <a href="mailto:ian@rumford.name" title="mailto: ian@rumford.name"><i class="fa fa-envelope-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://github.com/ianrumford" title="GithubID: ianrumford"><i class="fa fa-github-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://twitter.com/ianrumford" title="TwitterID: ianrumford"><i class="fa fa-twitter-square fa-3x"></i></a>
  

  

</div>

<div class="sidebar-module">
  <h4>Site Search</h4>
  <form onsubmit="search_google()" >
    <input type="text" id="google-search" placeholder="Google search" />
    <input type="submit" name="sa" value="Go" />
  </form>
</div>


<div class="sidebar-module"> <!-- sidebar-module-inset">-->
  <h4>Copyright Notice</h4>

  

  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
    <img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png">
  </a>
  <br />
  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Attribution-NonCommercial-ShareAlike</a>

  

</div>


<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html" title="Testing Individual Elixir Doctests" rel="bookmark">Testing Individual Elixir Doctests</a>
  </li>
  
  <li>
  <a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html" title="Metaprogramming Without Macros" rel="bookmark">Metaprogramming Without Macros</a>
  </li>
  
  <li>
  <a href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html" title="Sharing and Reusing Elixir Callback Functions between Modules" rel="bookmark">Sharing and Reusing Elixir Callback Functions between Modules</a>
  </li>
  
  <li>
  <a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html" title="Pattern Matching to Polymorphism - an Unexpected Journey" rel="bookmark">Pattern Matching to Polymorphism - an Unexpected Journey</a>
  </li>
  
  <li>
  <a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html" title="Adding a Map API to a GenServer or Module with Agent-held State" rel="bookmark">Adding a Map API to a GenServer or Module with Agent-held State</a>
  </li>
  
</div>


<div class="sidebar-module">
  <h4>Tags</h4>
  
    <a href="/tags/#hello world" title="hello world" rel="1">hello world</a> &nbsp;
  
    <a href="/tags/#octopress" title="octopress" rel="1">octopress</a> &nbsp;
  
    <a href="/tags/#jekyll" title="jekyll" rel="1">jekyll</a> &nbsp;
  
    <a href="/tags/#blog" title="blog" rel="1">blog</a> &nbsp;
  
    <a href="/tags/#emacs" title="emacs" rel="2">emacs</a> &nbsp;
  
    <a href="/tags/#Ubuntu" title="Ubuntu" rel="1">Ubuntu</a> &nbsp;
  
    <a href="/tags/#precise" title="precise" rel="2">precise</a> &nbsp;
  
    <a href="/tags/#pangolin" title="pangolin" rel="1">pangolin</a> &nbsp;
  
    <a href="/tags/#12.04" title="12.04" rel="1">12.04</a> &nbsp;
  
    <a href="/tags/#clojure" title="clojure" rel="1">clojure</a> &nbsp;
  
    <a href="/tags/#leinginen" title="leinginen" rel="1">leinginen</a> &nbsp;
  
    <a href="/tags/#slime" title="slime" rel="1">slime</a> &nbsp;
  
    <a href="/tags/#swank" title="swank" rel="1">swank</a> &nbsp;
  
    <a href="/tags/#ubuntu" title="ubuntu" rel="1">ubuntu</a> &nbsp;
  
    <a href="/tags/#ruby" title="ruby" rel="1">ruby</a> &nbsp;
  
    <a href="/tags/#windows" title="windows" rel="1">windows</a> &nbsp;
  
    <a href="/tags/#ole" title="ole" rel="1">ole</a> &nbsp;
  
    <a href="/tags/#property" title="property" rel="1">property</a> &nbsp;
  
    <a href="/tags/#values" title="values" rel="1">values</a> &nbsp;
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2017" > <a href="/archives/#2017">2017</a></li>
  
  
  
  
  
  
  
  
  
  <li id="2016" > <a href="/archives/#2016">2016</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2014" > <a href="/archives/#2014">2014</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2013" > <a href="/archives/#2013">2013</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2012" > <a href="/archives/#2012">2012</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


</div>



  

  <footer class="site-footer">

  <p>Copyright &copy; <a href="/">An Ostler in IT</a></p>
  <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> 
  on 
  
  <a href="https://github.com/">Github</a>
  
  | Theme <a href="https://github.com/yulijia/freshman21/">Freshman21</a> Design by <a href="http://yulijia.net">Lijia Yu</a>
  | Adapted by Ian Rumford  


  <div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
    <a title="Back To Top"><img src="/images/topbutton.png"/></a>
  </div>

  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/totop.js"></script>  



</footer>


</div>

</body>

</html>
