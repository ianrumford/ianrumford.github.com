<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width initial-scale=1">

<meta property="og:title" content="Some syntactic sugar for Clojure's threading macros">
<title>Some syntactic sugar for Clojure's threading macros</title>
<meta property="og:description" content="  TL;DR: threading all the things  Update: 1Sep15  Whilst writing I discovered this post has not been updated after I’dreceived some feedback from Shaun Park...">
<meta property="og:url" content="http://www.rumford.name/clojure/sugar/threading/macros/2014/10/24/some-syntactic-sugar-for-clojure-threading-macros.html">
<meta property="og:site_name" content="An Ostler in IT">
<meta property="og:locale" content="en_UK">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ianrumford">
<meta name="twitter:creator" content="@ianrumford">
<meta name="twitter:title" content="Some syntactic sugar for Clojure's threading macros">
<meta name="twitter:description" content="  TL;DR: threading all the things  Update: 1Sep15  Whilst writing I discovered this post has not been updated after I’dreceived some feedback from Shaun Park...">
<meta name="twitter:url" content="http://www.rumford.name/clojure/sugar/threading/macros/2014/10/24/some-syntactic-sugar-for-clojure-threading-macros.html">

<meta name="keywords" content="IT Ostler Horses Courses">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://www.rumford.name/clojure/sugar/threading/macros/2014/10/24/some-syntactic-sugar-for-clojure-threading-macros.html">
<link rel="alternate" type="application/atom+xml" title="An Ostler in IT" href="http://www.rumford.name/feed.xml" />

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script language="Javascript" type="text/javascript">
function search_google()
{
  var query = document.getElementById("google-search").value;
  window.open("http://google.com/search?q=" + query
      + "%20site:" + "http://www.rumford.name");
}
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script type='text/javascript'>
var blocklink = ['http://humanorightswatch.org','http://o-o-6-o-o.com','http://darodar.com','http://blackhatworth.com','http://hulfingtonpost.com','http://bestwebsitesawards.com','http://darodar.com','http://buttons-for-website.com','http://ilovevitaly.co','http://semalt.com','http://priceg.com','http://simple-share-buttons.com','http://googlsucks.com','http://4webmasters.org','http://aliexpress.com','http://addons.mozilla.org/en-US/firefox/addon/ilovevitaly/','http://free-share-buttons.com','http://buttons-for-your-website.com','http://theguardlan.com','http://buy-cheap-online.info','http://best-seo-offer.com','http://4webmasters.org','http://trafficmonetize.org','http://howtostopreferralspam.eu','http://ilovevitaly.com','http://sanjosestartups.com','http://free-social-buttons.com','http://best-seo-offer.com','http://guardlink.org','http://www.event-tracking.com','http://www3.free-social-buttons.com','http://www1.free-social-buttons.com','http://www2.free-social-buttons.com','http://websites-reviews.com','http://floating-share-buttons.com','http://satellite.maps.ilovevitaly.com','http://free-social-buttons.com','http://www.event-tracking.com','http://erot.co'];
for (var b = blocklink.length; b--;) {
  if (document.referrer.match(blocklink[b]))
    window.location = "http://www.google.com";
}
</script>



<link type="application/atom+xml" rel="alternate" href="http://www.rumford.name/atom.xml" title="An Ostler in IT" />
</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">An Ostler in IT</a></h1>
    <h3 class="site-meta">Horses for Courses</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/"></a>
        
        
        
        <a class="page-link" href="/feed.xml"></a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 itemprop="name" class="post-title">Some syntactic sugar for Clojure's threading macros</h1>
    <meta itemprop="keywords" content="" />
    <p class="post-meta">
    Posted in
    
    <a href="/categories/#clojure">clojure</a>, 
    
    <a href="/categories/#sugar">sugar</a>, 
    
    <a href="/categories/#threading">threading</a>, 
    
    <a href="/categories/#macros">macros</a>
     
    
    <time itemprop="datePublished" datetime="2014-10-24">
    on Oct 24, 2014
    </time>
    </p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <blockquote>
  <p>TL;DR: threading all the things</p>
</blockquote>

<blockquote>
  <p>Update: 1Sep15</p>

  <p>Whilst writing I discovered this post has not been updated after I’d
received some feedback from Shaun Parker. No idea what happened.
Sorry Shaun! You might want to jump straight to the “Update 1Sep15”
section, and have a look at my some-as→ macro.</p>
</blockquote>

<h1 id="introductiona-idorgheadline1a">Introduction<a id="orgheadline1"></a></h1>

<p>The other day I was writing a <a href="http://clojure.org">Clojure</a> <a href="http://clojuredocs.org/clojure_core/clojure.core/let">let</a> block to
transform a map. It
was a pretty usual <a href="http://clojure.org">Clojure</a> <em>pipeline</em> of functions,
a use case <a href="http://clojure.org">Clojure</a> excels at. The <em>pipeline</em> included a
<a href="http://clojuredocs.org/clojure_core/clojure.core/cond">cond</a>, a couple of
<a href="http://clojuredocs.org/clojure_core/clojure.core/map">maps</a>, some of my own functions, 
and finally an <a href="http://clojuredocs.org/clojure_core/clojure.core/assoc">assoc</a> and <a href="http://clojuredocs.org/clojure_core/clojure.core/dissoc">dissoc</a> to “update” the input map with the
result of the <em>pipeline</em> and delete some redundant keys.</p>

<p>Even though <a href="http://clojure.org">Clojure</a> syntax is quite spare there was
quite a bit of inevitable clutter in  the
code and it struck me the code would be cleaner and clearer if I
could use the <a href="http://clojuredocs.org/clojure_core/clojure.core/&gt;-">thread first</a> (→) <a href="http://clojuredocs.org/clojure_core/clojure.core/defmacro">macro</a>.</p>

<p>If you grok macros you can probably guess the rest of this post (likely you
will have seen the title and probably said to yourself “Oh yeah, that’s
obvious, nothing to see here” and moved along ☺ )</p>

<!-- more -->

<h1 id="threading-macrosa-idorgheadline8a">Threading Macros<a id="orgheadline8"></a></h1>

<h2 id="threading-macros---thread-first-and-thread-lasta-idorgheadline2a">Threading Macros - “thread first” and “thread last”<a id="orgheadline2"></a></h2>

<p><a href="http://clojure.org">Clojure</a> core has a family of threading macros
including the “thread first” ones of →, some→,
as→, and cond→, and their equivalent <a href="http://clojuredocs.org/clojure_core/clojure.core/&gt;-&gt;">thread last</a> (-») ones.</p>

<p>I’m not going to explain the threading macros in
depth as these have been well covered already - see for example this very nice
<a href="http://debasishg.blogspot.co.uk/2010/04/thrush-in-clojure.html">post</a> by <a href="https://plus.google.com/+DebasishGhosh/posts">Debasish Ghosh</a>
(btw Debasish’s book <a href="http://manning.com/ghosh/">DSLs in Action</a> is worth your money).</p>

<p>Simply put: the threading macros allow a <em>pipeline</em> of functions to be
written in visually clean and clear way — pre-empting the need to write a
perhaps deep inside-to-outside functional form — by <em>weaving</em> the result
of the previous function into the current function as either the first
(“thread first”) or last (“thread last”) argument.</p>

<p>The example below of using “thread last” to sum the balances of a bank’s savings account has been taken from
<a href="http://debasishg.blogspot.co.uk/2010/04/thrush-in-clojure.html">Debasish’s post</a> . I have reworked his
example slightly and added some narrative comments to make it completely clear what is
going on:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="c1">;; Debasish's example slighty reworked
;; For original see http://debasishg.blogspot.co.uk/2010/04/thrush-in-clojure.html
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">all-accounts</span><span class="w">
  </span><span class="p">[{</span><span class="no">:no</span><span class="w"> </span><span class="mi">101</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"debasish"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="ss">'savings</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">100</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">102</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"john p."</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="ss">'checking</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">200</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">103</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"me"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="ss">'checking</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">-500</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">104</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"you"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="ss">'savings</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">750</span><span class="p">}])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-using-thread-last</span><span class="w">
  </span><span class="p">(</span><span class="w">
   </span><span class="c1">;; use the thread-last macro
</span><span class="w">   </span><span class="n">-&gt;&gt;</span><span class="w">

   </span><span class="c1">;; ... and start from the collection of all accounts
</span><span class="w">   </span><span class="n">all-accounts</span><span class="w">

   </span><span class="c1">;; ... select only the savings accounts
</span><span class="w">   </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="ss">'savings</span><span class="p">))</span><span class="w">

   </span><span class="c1">;; ... get the balances from all the saving accounts
</span><span class="w">   </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... and add up all their balances
</span><span class="w">   </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nb">+</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"savings-accounts-balance-sum-using-thread-last"</span><span class="w">
                </span><span class="n">savings-accounts-balance-sum-using-thread-last</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-using-thread-last</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="threading-macros---whats-not-to-likea-idorgheadline3a">Threading Macros - what’s not to like?<a id="orgheadline3"></a></h2>

<p>Nothing really although there are limitations of course. For example to thread
a <a href="http://clojuredocs.org/clojure_core/clojure.core/map">map</a> needs “thread last” and
<a href="http://clojuredocs.org/clojure_core/clojure.core/assoc">assoc</a> requires “thread first”, but
you can’t mix first and last together directly.</p>

<p>Although “thread first” and “thread last” cover a wide range of use cases, there are
times where you have to go through hoops to incorporate code that
requires the current value of the <em>pipeline</em> as other than the first or
last argument, or maybe need to use the value multiple times in
multiple subforms.</p>

<h2 id="threading-macros---using-a-partiala-idorgheadline4a">Threading Macros - using a partial<a id="orgheadline4"></a></h2>

<p>There are ways around the limitations of course and one way is to use
<a href="http://clojuredocs.org/clojure_core/clojure.core/partial">partial</a> with “thread first” to supply the 
argument as the <em>last</em> argument to the function.</p>

<p>This <em>horrid</em> example
using “thread first” with lots of partials is bonkers but does demonstrate
the point:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="c1">;; Using partials with thread-first
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-using-thread-first</span><span class="w">
  </span><span class="p">(</span><span class="w">
   </span><span class="c1">;; use the thread-first macro
</span><span class="w">   </span><span class="nb">-&gt;</span><span class="w">

   </span><span class="c1">;; ... and start from the collection of all accounts
</span><span class="w">   </span><span class="n">all-accounts</span><span class="w">

   </span><span class="c1">;; ... select only the savings accounts
</span><span class="w">   </span><span class="p">((</span><span class="nb">partial</span><span class="w"> </span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="ss">'savings</span><span class="p">)))</span><span class="w">

   </span><span class="c1">;; ... get the balances from all the saving accounts
</span><span class="w">   </span><span class="p">((</span><span class="nb">partial</span><span class="w"> </span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="p">))</span><span class="w">

   </span><span class="c1">;; ... and add up all their balances
</span><span class="w">   </span><span class="p">((</span><span class="nb">partial</span><span class="w"> </span><span class="nb">apply</span><span class="w"> </span><span class="nb">+</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"savings-accounts-balance-sum-using-thread-first"</span><span class="w"> 
                </span><span class="n">savings-accounts-balance-sum-using-thread-first</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-using-thread-first</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Note each <a href="http://clojuredocs.org/clojure_core/clojure.core/partial">partial</a> call is the first (and only) form
inside another form; the “thread first” macro will weave the input
to the partial as the second value in the outer form.  (Else the macro would weave the previous result
into the partial declaration itself.)</p>

<h2 id="threading-macros---using-an-in-line-functiona-idorgheadline5a">Threading Macros - using an in-line function<a id="orgheadline5"></a></h2>

<p>More generally, you can always escape the confines of the first or last
constraint by using an in-line function.</p>

<p>The following example sums the balances of all the <em>checking</em> accounts
in deficit, applying 10%
interest, to find the total owed to the bank.  It uses an in-line function to
apply the interest.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></td><td class="code"><pre><span class="c1">;; Calculate the total balance of all the checking accounts in deficit
</span><span class="w">
</span><span class="c1">;; applies interest to any in deficit
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">deficit-accounts-balance-sum-using-interest-function</span><span class="w">
  </span><span class="p">(</span><span class="w">
   </span><span class="c1">;; use the thread-last macro
</span><span class="w">   </span><span class="n">-&gt;&gt;</span><span class="w">

   </span><span class="c1">;; ... and start from the collection of all accounts
</span><span class="w">   </span><span class="n">all-accounts</span><span class="w">

   </span><span class="c1">;; ... select only the checking accounts
</span><span class="w">   </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="ss">'checking</span><span class="p">))</span><span class="w">

   </span><span class="c1">;; ... select the accounts in deficit
</span><span class="w">   </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="no">:balance</span><span class="w"> </span><span class="n">%</span><span class="p">)))</span><span class="w">

   </span><span class="c1">;; add 10% interest to any in deficit
</span><span class="w">   </span><span class="c1">;; interest rate is first argument; second (last) is the deficit accounts
</span><span class="w">   </span><span class="p">((</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">interest-rate</span><span class="w"> </span><span class="n">deficit-accounts</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="nb">map</span><span class="w">
       </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">deficit-account</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">balance</span><span class="w"> </span><span class="p">(</span><span class="no">:balance</span><span class="w"> </span><span class="n">deficit-account</span><span class="p">)</span><span class="w">
               </span><span class="n">interest</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">interest-rate</span><span class="w"> </span><span class="n">balance</span><span class="p">)]</span><span class="w">
           </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">deficit-account</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="n">interest</span><span class="p">))))</span><span class="w">
       </span><span class="n">deficit-accounts</span><span class="p">))</span><span class="w">
       </span><span class="c1">;; interest rate is 10%
</span><span class="w">       </span><span class="mf">0.1</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... get the balances from all the deficit accounts
</span><span class="w">   </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... and add up all their balances to get net balance
</span><span class="w">   </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nb">+</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"deficit-accounts-balance-sum-using-interest-function"</span><span class="w"> 
                </span><span class="n">deficit-accounts-balance-sum-using-interest-function</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mf">-550.0</span><span class="w"> </span><span class="n">deficit-accounts-balance-sum-using-interest-function</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Note the in-line function declaration is the first form inside another
form (for the same reason as
the partials above were).</p>

<h2 id="threading-macros---capturing-the-result-of-the-previous-stepa-idorgheadline6a">Threading Macros - capturing the result of the previous step<a id="orgheadline6"></a></h2>

<p>In the above examples the steps were calls to core functions:
<a href="http://clojuredocs.org/clojure_core/clojure.core/filter">filter</a>, <a href="http://clojuredocs.org/clojure_core/clojure.core/map">map</a> and
<a href="http://clojuredocs.org/clojure_core/clojure.core/apply">apply</a>.</p>

<p>But the step can be a call to a macro and the macro will be passed the
current value of the form being evaluated by the threading macro.</p>

<p>In the example below, a simple macro <em>show-the-argument</em> will print the
current evaluated form and return it to continue the evaluation.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></td><td class="code"><pre><span class="c1">;; using a simple macro to show what's passed to each step in the pipeline
</span><span class="w">
</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">show-the-argument</span><span class="w">
  </span><span class="p">[</span><span class="n">argument</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">argument</span><span class="p">))</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">do</span><span class="w">
     </span><span class="o">~</span><span class="n">argument</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-and-show-the-argument</span><span class="w">
  </span><span class="p">(</span><span class="w">
   </span><span class="c1">;; use the thread-last macro
</span><span class="w">   </span><span class="n">-&gt;&gt;</span><span class="w">

   </span><span class="c1">;; ... and start from the collection of all accounts
</span><span class="w">   </span><span class="n">all-accounts</span><span class="w">

   </span><span class="c1">;; show the argument
</span><span class="w">   </span><span class="p">(</span><span class="nf">show-the-argument</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... select only the savings accounts
</span><span class="w">   </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="ss">'savings</span><span class="p">))</span><span class="w">

   </span><span class="c1">;; show the argument
</span><span class="w">   </span><span class="p">(</span><span class="nf">show-the-argument</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... get the balances from all the saving accounts
</span><span class="w">   </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; show the argument
</span><span class="w">   </span><span class="p">(</span><span class="nf">show-the-argument</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... and add up all their balances
</span><span class="w">   </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nb">+</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"savings-accounts-balance-sum-and-show-the-argument"</span><span class="w"> 
                </span><span class="n">savings-accounts-balance-sum-and-show-the-argument</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-and-show-the-argument</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>If you look at the prints, you’ll see something like the below for the
output for the post <em>filter</em> call to <em>show-the-argument</em> (I’ve
reformatted to aid clarity):</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">filter</span><span class="w">
 </span><span class="p">(</span><span class="nf">fn*</span><span class="w"> </span><span class="p">[</span><span class="n">p1__1419</span><span class="o">#</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">p1__1419</span><span class="o">#</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">quote</span><span class="w"> </span><span class="n">savings</span><span class="p">)))</span><span class="w">
 </span><span class="p">(</span><span class="nf">show-the-argument</span><span class="w"> </span><span class="n">all-accounts</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>You can see how “thread last” has woven the previous call to
<em>show-the-argument</em> (after <strong>all-accounts</strong>) into the <em>filter</em> form. The calls to
<em>show-the-argument</em> will be  evaluated after
“thread last” has presented its evaluated form for compilation.</p>

<h2 id="threading-macros---thread-first-leta-idorgheadline7a">Threading Macros - “thread-first-let”<a id="orgheadline7"></a></h2>

<p><em>show-the-argument</em> demonstrates how simple it is in a macro to grab hold of the current
form being evaluated and do something with it.</p>

<p>Let’s do that then. The  macro
“thread-first-let” below takes
the <em>argument</em> together with some body forms, and returns a new form that assigns the argument to a
<a href="http://clojuredocs.org/clojure_core/clojure.core/let">let</a> <a href="http://clojuredocs.org/clojure_core/clojure.core/gensym">gensym</a> local called
<strong>x#</strong> and evaluates the body forms in the
context of the <a href="http://clojuredocs.org/clojure_core/clojure.core/let">let</a> so the body forms can use <strong>x#</strong> anywhere needed.</p>

<p>The macro includes a println to shows the form returned by
“thread-first-let” to the compiler:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="c1">;; Using the "thread-first-let" macro create a let and assigns the current form to x#
;; and evaluates the body in the let context, with x# available in the body
</span><span class="w">
</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">thread-first-let</span><span class="w">
  </span><span class="p">[</span><span class="n">argument</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">let-form</span><span class="o">#</span><span class="w"> </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="o">~</span><span class="ss">'x#</span><span class="w"> </span><span class="o">~</span><span class="n">argument</span><span class="p">]</span><span class="w">
                     </span><span class="p">(</span><span class="o">~@</span><span class="n">body</span><span class="p">))]</span><span class="w">
    </span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">let-form</span><span class="o">#</span><span class="p">))</span><span class="w">
    </span><span class="o">`</span><span class="p">(</span><span class="nf">do</span><span class="w">
       </span><span class="o">~</span><span class="n">let-form</span><span class="o">#</span><span class="p">)))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Let’s reprise to the <em>horrid</em> example above where I used
partials with “thread first” and use “there-first-let”
instead.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="c1">;; Using "thread-first-let" inside a "thread-first"
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-using-thread-first-let</span><span class="w">
  </span><span class="p">(</span><span class="w">
   </span><span class="c1">;; use the thread-first macro
</span><span class="w">   </span><span class="nb">-&gt;</span><span class="w">

   </span><span class="c1">;; ... and start from the collection of all accounts
</span><span class="w">   </span><span class="n">all-accounts</span><span class="w">

   </span><span class="c1">;; ... select only the savings accounts
</span><span class="w">   </span><span class="p">(</span><span class="nf">thread-first-let</span><span class="w"> </span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="ss">'savings</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="o">#</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... get the balances from all the saving accounts
</span><span class="w">   </span><span class="p">(</span><span class="nf">thread-first-let</span><span class="w"> </span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="n">x</span><span class="o">#</span><span class="p">)</span><span class="w">

   </span><span class="c1">;; ... and add up all their balances
</span><span class="w">   </span><span class="p">(</span><span class="nf">thread-first-let</span><span class="w"> </span><span class="nb">apply</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="o">#</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"savings-accounts-balance-sum-using-thread-first-let"</span><span class="w">
                </span><span class="n">savings-accounts-balance-sum-using-thread-first-let</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="n">savings-accounts-balance-sum-using-thread-first-let</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>One of the prints from “thread-first-let” shows the final form of the
<em>filter</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="p">(</span><span class="nf">clojure.core/let</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="o">#</span><span class="w"> </span><span class="n">all-accounts</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="p">(</span><span class="nf">fn*</span><span class="w"> </span><span class="p">[</span><span class="n">p1__1431</span><span class="o">#</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">p1__1431</span><span class="o">#</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">quote</span><span class="w"> </span><span class="n">savings</span><span class="p">)))</span><span class="w"> </span><span class="n">x</span><span class="o">#</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The takeaway here is that  after the <strong>thread-first-let</strong> the code is exactly the same
as you would write outside of a core threading macro, and you have the
freedom to use the argument (<strong>x#</strong>) wherever and whenever you need, not
just once and / or “last”.</p>

<h1 id="final-wordsa-idorgheadline9a">Final Words<a id="orgheadline9"></a></h1>

<p>“thread-first-let” is a very simple seven line macro allowing arbitrary code to participate in
the core threading macros making the whole <em>pipeline</em>  as clean as clear as
possible.</p>

<p>It not hard to see how this simple idea could taken forward to define
macros to support “thread-last”, or even “packaged” macros
such as <em>thread-first-map</em>.</p>

<p>The more general point is how even a trivial use of macros makes for a
welcome improvement in keeping the code clean and clear, and really
does bring home how tractable and malleable <a href="http://clojuredocs.org/clojure_core/clojure.core/defmacro">macros</a> make <a href="http://clojure.org">Clojure</a>.</p>

<h1 id="update-1sep15a-idorgheadline14a">Update 1Sep15<a id="orgheadline14"></a></h1>

<h2 id="feedback-from-shawn-parker-on-the-asrarr-macroa-idorgheadline10a">Feedback from Shawn Parker on the as→ macro<a id="orgheadline10"></a></h2>

<p>Shaun Parker was kind enough to email me and recommend I take a closer
look at the as→ macro.  I must admit I was not too familiar
with that member of the threading family; its true to say that
“thread-first-let” is a derivative form of as→.</p>

<p>Shaun provided a couple of more idiomatic reworkings of the accounts
example using as→ where the name used is <strong>$</strong>.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="c1">;; Shaun's examples of using the as-&gt; macro
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">all-accounts</span><span class="w">
  </span><span class="p">[{</span><span class="no">:no</span><span class="w"> </span><span class="mi">101</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"debasish"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:savings</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">100</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">102</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"john p."</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:checking</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">200</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">103</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"me"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:checking</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">-500</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">104</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"you"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:savings</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mi">750</span><span class="p">}])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">shaun_as1</span><span class="w"> </span><span class="p">(</span><span class="nf">as-&gt;</span><span class="w"> </span><span class="n">all-accounts</span><span class="w"> </span><span class="n">$</span><span class="w">
       </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:savings</span><span class="p">)</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
       </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
       </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="n">$</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"shaun_as1"</span><span class="w"> </span><span class="n">shaun_as1</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="n">shaun_as1</span><span class="p">))</span><span class="w">

</span><span class="c1">;; example with adding another account, showing mixed threading
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">shaun_as2</span><span class="w"> </span><span class="p">(</span><span class="nf">as-&gt;</span><span class="w"> </span><span class="n">all-accounts</span><span class="w"> </span><span class="n">$</span><span class="w">
                 </span><span class="p">(</span><span class="nb">conj</span><span class="w"> </span><span class="n">$</span><span class="w"> </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">105</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"shaun"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:savings</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mf">100000.42</span><span class="p">})</span><span class="w">
                 </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:savings</span><span class="p">)</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
                 </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
                 </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="n">$</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"shaun_as2"</span><span class="w"> </span><span class="n">shaun_as2</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mf">100850.42</span><span class="w"> </span><span class="n">shaun_as2</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="the-core-somerarr-macroa-idorgheadline11a">The Core some→ macro<a id="orgheadline11"></a></h2>

<p>On of the reasons I hadn’t used as→ that much was because my
“go to” threading macro has been usually some→.</p>

<p>The latter is very
similar to the normal “thread-first” (→) macro but
<strong>additionally</strong> the pipeline is aborted if the result of the previous
step is <em>nil</em>; early termination. (some→ compiles each step in the pipeline to an <strong>if</strong> statement)</p>

<p>If you look at the code (1.7.0) for some→ is a awesome tribute to
recursion, conciseness and clarity, I keep thinking “where’s all the code?”</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">some-&gt;</span><span class="w">
  </span><span class="s">"When expr is not nil, threads it into the first form (via -&gt;),
  and when that result is not nil, through the next etc"</span><span class="w">
  </span><span class="p">{</span><span class="no">:added</span><span class="w"> </span><span class="s">"1.5"</span><span class="p">}</span><span class="w">
  </span><span class="p">[</span><span class="n">expr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">forms</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">g</span><span class="w"> </span><span class="p">(</span><span class="nb">gensym</span><span class="p">)</span><span class="w">
        </span><span class="n">pstep</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="w"> </span><span class="o">`</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">nil?</span><span class="w"> </span><span class="o">~</span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="o">~</span><span class="n">g</span><span class="w"> </span><span class="o">~</span><span class="n">step</span><span class="p">)))]</span><span class="w">
    </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="o">~</span><span class="n">g</span><span class="w"> </span><span class="o">~</span><span class="n">expr</span><span class="w">
           </span><span class="o">~@</span><span class="p">(</span><span class="nb">interleave</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">pstep</span><span class="w"> </span><span class="n">forms</span><span class="p">))]</span><span class="w">
       </span><span class="o">~</span><span class="n">g</span><span class="p">)))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="the-core-asrarr-macroa-idorgheadline12a">The Core as→ macro<a id="orgheadline12"></a></h2>

<p>The as→ macro is similarly elegant:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">as-&gt;</span><span class="w">
  </span><span class="s">"Binds name to expr, evaluates the first form in the lexical context
  of that binding, then binds name to that result, repeating for each
  successive form, returning the result of the last form."</span><span class="w">
  </span><span class="p">{</span><span class="no">:added</span><span class="w"> </span><span class="s">"1.5"</span><span class="p">}</span><span class="w">
  </span><span class="p">[</span><span class="n">expr</span><span class="w"> </span><span class="nb">name</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">forms</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="o">~</span><span class="nb">name</span><span class="w"> </span><span class="o">~</span><span class="n">expr</span><span class="w">
         </span><span class="o">~@</span><span class="p">(</span><span class="nb">interleave</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat</span><span class="w"> </span><span class="nb">name</span><span class="p">)</span><span class="w"> </span><span class="n">forms</span><span class="p">)]</span><span class="w">
     </span><span class="o">~</span><span class="nb">name</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="my-attempt-at-a-some-asrarr-macroa-idorgheadline13a">My attempt at a some-as→ macro<a id="orgheadline13"></a></h2>

<p>I got to thinking if would be good to have the flexibility of
as→ as to how / where the current value will be used in
the current step, together with the early termination behaviour of some→.</p>

<p>Here is what I came up with:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">some-as-&gt;</span><span class="w">
  </span><span class="s">"Conflation of some-&gt; and as-&gt;"</span><span class="w">
  </span><span class="p">[</span><span class="n">expr</span><span class="w"> </span><span class="nb">name</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">forms</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">pstep</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="w">
                </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">step-value</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="ss">'if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="ss">'nil?</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="p">)</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="o">~</span><span class="n">step</span><span class="p">)]</span><span class="w">
                   </span><span class="n">step-value</span><span class="o">#</span><span class="p">))]</span><span class="w">
    </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="o">~</span><span class="nb">name</span><span class="w"> </span><span class="o">~</span><span class="n">expr</span><span class="w">
           </span><span class="o">~@</span><span class="p">(</span><span class="nb">interleave</span><span class="w"> </span><span class="p">(</span><span class="nb">repeat</span><span class="w"> </span><span class="nb">name</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">pstep</span><span class="w"> </span><span class="n">forms</span><span class="p">))]</span><span class="w">
       </span><span class="o">~</span><span class="nb">name</span><span class="p">)))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Let try Shaun’s examples with some-as→ just to check nothing
has gone wrong; early termination wont be invoked here:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="c1">;; Shaauns' example using some-as-&gt;
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">shaun_as1a</span><span class="w"> </span><span class="p">(</span><span class="nf">some-as-&gt;</span><span class="w"> </span><span class="n">all-accounts</span><span class="w"> </span><span class="n">$</span><span class="w">
       </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:savings</span><span class="p">)</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
       </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
       </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="n">$</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"shaun_as1a"</span><span class="w"> </span><span class="n">shaun_as1a</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">850</span><span class="w"> </span><span class="n">shaun_as1a</span><span class="p">))</span><span class="w">

</span><span class="c1">;; example with adding another account, showing mixed threading
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">shaun_as2a</span><span class="w"> </span><span class="p">(</span><span class="nf">some-as-&gt;</span><span class="w"> </span><span class="n">all-accounts</span><span class="w"> </span><span class="n">$</span><span class="w">
                 </span><span class="p">(</span><span class="nb">conj</span><span class="w"> </span><span class="n">$</span><span class="w"> </span><span class="p">{</span><span class="no">:no</span><span class="w"> </span><span class="mi">105</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"shaun"</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:savings</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="mf">100000.42</span><span class="p">})</span><span class="w">
                 </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:savings</span><span class="p">)</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
                 </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:balance</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">
                 </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="n">$</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"shaun_as2a"</span><span class="w"> </span><span class="n">shaun_as2a</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mf">100850.42</span><span class="w"> </span><span class="n">shaun_as2a</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Ok, an (contrived) example to demonstrate early termination being invoked:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="c1">;; Example of using some-as-&gt;
</span><span class="w">
</span><span class="c1">;; Without the early termination feature of some-&gt; this code would stack
;; trace as symbol fails when given a nil value
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">some_as_ex1</span><span class="w"> </span><span class="p">(</span><span class="nf">some-as-&gt;</span><span class="w"> </span><span class="n">all-accounts</span><span class="w"> </span><span class="n">$</span><span class="w">

                   </span><span class="c1">;; find accounts with my first name - there are none!
</span><span class="w">                   </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:name</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="s">"ian"</span><span class="p">)</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">

                   </span><span class="c1">;; taking the first of empty collection will return nil
</span><span class="w">                   </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w">

                   </span><span class="c1">;; extract my name
</span><span class="w">                   </span><span class="c1">;; but this step and subsequent ones will not be executed
</span><span class="w">                   </span><span class="p">(</span><span class="no">:name</span><span class="w"> </span><span class="n">$</span><span class="p">)</span><span class="w"> 

                   </span><span class="c1">;; create a symbol of my name
</span><span class="w">                   </span><span class="c1">;; symbol will stack trace if given a nil value
</span><span class="w">                   </span><span class="p">(</span><span class="nb">symbol</span><span class="w"> </span><span class="n">$</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"some_as_ex1"</span><span class="w"> </span><span class="n">some_as_ex1</span><span class="p">))</span><span class="w">

</span><span class="c1">;; check the answer
</span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="n">some_as_ex1</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>


  </article>
  <hr />
</div>


<section class="pager">
  <ul>
    
    <li class="previous"><a href="/clojure/transducers/reducers/2014/08/08/Some-trivial-examples-of-using-Clojure-Transducers.html" title="Some trivial examples of using Clojure Transducers">&larr; Older</a></li>
    
    
    <li class="next"><a href="/elixir/pipe/clojure/thread-first/macro/2016/07/24/writing-your-own-elixir-pipe-operator.html" title="Writing your own Elixir pipe operator">Newer &rarr;</a></li>
    
  </ul>
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://www.rumford.name/clojure/transducers/reducers/2014/08/08/Some-trivial-examples-of-using-Clojure-Transducers.html';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://www.rumford.name/elixir/pipe/clojure/thread-first/macro/2016/07/24/writing-your-own-elixir-pipe-operator.html';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



<div id="disqus_thread"></div>

<script type="text/javascript">

  var disqus_developer = 1;

var disqus_shortname ='';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    <section class="pager">
  
  
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Whistlejacket" src="/images/whistlejacket-circle-128px-2.png" alt="Whistlejacket"/>
  <span>Ian Rumford's whisperings</span>
  <br />

  

  You can contact me via: <br />

  
  <a href="mailto:ian@rumford.name" title="mailto: ian@rumford.name"><i class="fa fa-envelope-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://github.com/ianrumford" title="GithubID: ianrumford"><i class="fa fa-github-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://twitter.com/ianrumford" title="TwitterID: ianrumford"><i class="fa fa-twitter-square fa-3x"></i></a>
  

  

</div>

<div class="sidebar-module">
  <h4>Site Search</h4>
  <form onsubmit="search_google()" >
    <input type="text" id="google-search" placeholder="Google search" />
    <input type="submit" name="sa" value="Go" />
  </form>
</div>


<div class="sidebar-module"> <!-- sidebar-module-inset">-->
  <h4>Copyright Notice</h4>

  

  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
    <img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png">
  </a>
  <br />
  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Attribution-NonCommercial-ShareAlike</a>

  

</div>


<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html" title="Testing Individual Elixir Doctests" rel="bookmark">Testing Individual Elixir Doctests</a>
  </li>
  
  <li>
  <a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html" title="Metaprogramming Without Macros" rel="bookmark">Metaprogramming Without Macros</a>
  </li>
  
  <li>
  <a href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html" title="Sharing and Reusing Elixir Callback Functions between Modules" rel="bookmark">Sharing and Reusing Elixir Callback Functions between Modules</a>
  </li>
  
  <li>
  <a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html" title="Pattern Matching to Polymorphism - an Unexpected Journey" rel="bookmark">Pattern Matching to Polymorphism - an Unexpected Journey</a>
  </li>
  
  <li>
  <a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html" title="Adding a Map API to a GenServer or Module with Agent-held State" rel="bookmark">Adding a Map API to a GenServer or Module with Agent-held State</a>
  </li>
  
</div>


<div class="sidebar-module">
  <h4>Tags</h4>
  
    <a href="/tags/#hello world" title="hello world" rel="1">hello world</a> &nbsp;
  
    <a href="/tags/#octopress" title="octopress" rel="1">octopress</a> &nbsp;
  
    <a href="/tags/#jekyll" title="jekyll" rel="1">jekyll</a> &nbsp;
  
    <a href="/tags/#blog" title="blog" rel="1">blog</a> &nbsp;
  
    <a href="/tags/#emacs" title="emacs" rel="2">emacs</a> &nbsp;
  
    <a href="/tags/#Ubuntu" title="Ubuntu" rel="1">Ubuntu</a> &nbsp;
  
    <a href="/tags/#precise" title="precise" rel="2">precise</a> &nbsp;
  
    <a href="/tags/#pangolin" title="pangolin" rel="1">pangolin</a> &nbsp;
  
    <a href="/tags/#12.04" title="12.04" rel="1">12.04</a> &nbsp;
  
    <a href="/tags/#clojure" title="clojure" rel="1">clojure</a> &nbsp;
  
    <a href="/tags/#leinginen" title="leinginen" rel="1">leinginen</a> &nbsp;
  
    <a href="/tags/#slime" title="slime" rel="1">slime</a> &nbsp;
  
    <a href="/tags/#swank" title="swank" rel="1">swank</a> &nbsp;
  
    <a href="/tags/#ubuntu" title="ubuntu" rel="1">ubuntu</a> &nbsp;
  
    <a href="/tags/#ruby" title="ruby" rel="1">ruby</a> &nbsp;
  
    <a href="/tags/#windows" title="windows" rel="1">windows</a> &nbsp;
  
    <a href="/tags/#ole" title="ole" rel="1">ole</a> &nbsp;
  
    <a href="/tags/#property" title="property" rel="1">property</a> &nbsp;
  
    <a href="/tags/#values" title="values" rel="1">values</a> &nbsp;
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2017" > <a href="/archives/#2017">2017</a></li>
  
  
  
  
  
  
  
  
  
  <li id="2016" > <a href="/archives/#2016">2016</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2014" > <a href="/archives/#2014">2014</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2013" > <a href="/archives/#2013">2013</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2012" > <a href="/archives/#2012">2012</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


</div>



  

  <footer class="site-footer">

  <p>Copyright &copy; <a href="/">An Ostler in IT</a></p>
  <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> 
  on 
  
  <a href="https://github.com/">Github</a>
  
  | Theme <a href="https://github.com/yulijia/freshman21/">Freshman21</a> Design by <a href="http://yulijia.net">Lijia Yu</a>
  | Adapted by Ian Rumford  


  <div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
    <a title="Back To Top"><img src="/images/topbutton.png"/></a>
  </div>

  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/totop.js"></script>  



</footer>


</div>

</body>

</html>
