<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width initial-scale=1">

<meta property="og:title" content="Some trivial examples of using Clojure Reducers">
<title>Some trivial examples of using Clojure Reducers</title>
<meta property="og:description" content="  TL;DR: Reducers are all about maximising performance.The Clojure Reducers library(“reducers”) was announced by Clojure’s authorRich Hickey in May 2012 inth...">
<meta property="og:url" content="http://www.rumford.name/clojure/reducers/parallel/map/reduce/2013/08/25/some-trivial-examples-of-using-clojure-reducers.html">
<meta property="og:site_name" content="An Ostler in IT">
<meta property="og:locale" content="en_UK">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ianrumford">
<meta name="twitter:creator" content="@ianrumford">
<meta name="twitter:title" content="Some trivial examples of using Clojure Reducers">
<meta name="twitter:description" content="  TL;DR: Reducers are all about maximising performance.The Clojure Reducers library(“reducers”) was announced by Clojure’s authorRich Hickey in May 2012 inth...">
<meta name="twitter:url" content="http://www.rumford.name/clojure/reducers/parallel/map/reduce/2013/08/25/some-trivial-examples-of-using-clojure-reducers.html">

<meta name="keywords" content="IT Ostler Horses Courses">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://www.rumford.name/clojure/reducers/parallel/map/reduce/2013/08/25/some-trivial-examples-of-using-clojure-reducers.html">
<link rel="alternate" type="application/atom+xml" title="An Ostler in IT" href="http://www.rumford.name/feed.xml" />

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script language="Javascript" type="text/javascript">
function search_google()
{
  var query = document.getElementById("google-search").value;
  window.open("http://google.com/search?q=" + query
      + "%20site:" + "http://www.rumford.name");
}
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script type='text/javascript'>
var blocklink = ['http://humanorightswatch.org','http://o-o-6-o-o.com','http://darodar.com','http://blackhatworth.com','http://hulfingtonpost.com','http://bestwebsitesawards.com','http://darodar.com','http://buttons-for-website.com','http://ilovevitaly.co','http://semalt.com','http://priceg.com','http://simple-share-buttons.com','http://googlsucks.com','http://4webmasters.org','http://aliexpress.com','http://addons.mozilla.org/en-US/firefox/addon/ilovevitaly/','http://free-share-buttons.com','http://buttons-for-your-website.com','http://theguardlan.com','http://buy-cheap-online.info','http://best-seo-offer.com','http://4webmasters.org','http://trafficmonetize.org','http://howtostopreferralspam.eu','http://ilovevitaly.com','http://sanjosestartups.com','http://free-social-buttons.com','http://best-seo-offer.com','http://guardlink.org','http://www.event-tracking.com','http://www3.free-social-buttons.com','http://www1.free-social-buttons.com','http://www2.free-social-buttons.com','http://websites-reviews.com','http://floating-share-buttons.com','http://satellite.maps.ilovevitaly.com','http://free-social-buttons.com','http://www.event-tracking.com','http://erot.co'];
for (var b = blocklink.length; b--;) {
  if (document.referrer.match(blocklink[b]))
    window.location = "http://www.google.com";
}
</script>



<link type="application/atom+xml" rel="alternate" href="http://www.rumford.name/atom.xml" title="An Ostler in IT" />
</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">An Ostler in IT</a></h1>
    <h3 class="site-meta">Horses for Courses</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/"></a>
        
        
        
        <a class="page-link" href="/feed.xml"></a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 itemprop="name" class="post-title">Some trivial examples of using Clojure Reducers</h1>
    <meta itemprop="keywords" content="" />
    <p class="post-meta">
    Posted in
    
    <a href="/categories/#clojure">clojure</a>, 
    
    <a href="/categories/#reducers">reducers</a>, 
    
    <a href="/categories/#parallel">parallel</a>, 
    
    <a href="/categories/#map">map</a>, 
    
    <a href="/categories/#reduce">reduce</a>
     
    
    <time itemprop="datePublished" datetime="2013-08-25">
    on Aug 25, 2013
    </time>
    </p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <blockquote>
  <p>TL;DR: <strong>Reducers</strong> are all about maximising performance.</p>
</blockquote>

<p>The <a href="http:///clojure.org">Clojure</a> <a href="https://github.com/clojure/clojure/blob/master/src/clj/clojure/core/reducers.clj">Reducers</a> library
(<strong>“reducers”</strong>) was announced by <a href="http:///clojure.org">Clojure’s</a> author
<a href="https://twitter.com/richhickey">Rich Hickey</a> in May 2012 in
<a href="http://clojure.com/blog/2012/05/08/reducers-a-library-and-model-for-collection-processing.html">this</a> blog post. He  followed up a week later with
a <a href="http://clojure.com/blog/2012/05/15/anatomy-of-reducer.html">second</a> post.</p>

<p>These posts were very well written and densely packed with volumes
 of information and both really benefit from being pored over and
multiple re-reading. Their approach was one of trying to convey an
<em>understanding</em> of reducers together with some examples of how to
<em>use</em> them.</p>

<p>Both posts covered a lot of ground, introducing the (new) <strong>reducers</strong> way
of thinking about <em>map, filter &amp; reduce</em> for collections, aided by new terminology to
explain the new ideas.</p>

<p><strong>Reducers</strong> also use heavily Clojure’s support for
dynamically generating functions (in fact, a function generating a
function that in turn generates a third function) so you need to have a clear grasp of
how that works as well.</p>

<p>The second post  also explained how <em>reduce</em> had been changed (in v1.4) to allow collections to support directly reduction using the <strong>CollReduce</strong> protocol.</p>

<p>Quite a lot to take in and the mental jigsaw puzzle quite hard to
piece together at times.</p>

<p>There have been other posts explaining <strong>reducers</strong> (especially good is
this slideshare from <a href="http://www.slideshare.net/borgesleonardo/clojure-reducers-cljsyd-aug-2012?ref=http://www.leonardoborges.com/writings/presentations/">Leonardo Borges</a>) but all have
followed the approach of, and examples from, Rich’s original posts i.e.
<em>understand</em> and then <em>use</em>.</p>

<p>Sometimes though is easier to consolidate your <em>understanding</em> after
having <em>used</em> something successfully. As I’ve been poring over Rich’s
and other
posts, I been writing some examples for precisely that reason
and thought I’d present a  “narrative”  of some trivial example to illustrate the use
of  <strong>reducers</strong>.</p>

<p>I’m will be deliberately avoiding as much “theory” and new terminology  as I can
and just concentrating on some practical, if trivial, examples, labouring points sometimes
to ensure clarity.</p>

<!-- more -->

<h1 id="the-examples-collection">The Examples Collection</h1>

<p>Many of the following examples will use the same collection which
describes the population of a very (very!) small village.  The village
has four families, some families have two parents, others one; and
each family between one and three children.  One family lives in the North, and one each in the South, East and West.</p>

<p><em>This is stylised, artificial and contrived data designed to be easily understandable to most and in no way intended to suggest any family structures, conventions or arrangements as socially preferable.  Just saying.</em></p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="c1">;; The Families in the Village
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">village</span><span class="w">
  </span><span class="p">[</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:north</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"smith"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"sue"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">37</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:parent</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:north</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"smith"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"stan"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:m</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:parent</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:north</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"smith"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"simon"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:m</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:north</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"smith"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"sadie"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
   
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:south</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"jill"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:parent</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:south</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"jeff"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:m</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:parent</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:south</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"jackie"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:south</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"jason"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:south</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"june"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">

   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:west</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"brown"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"billie"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:parent</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:west</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"brown"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"brian"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:m</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:west</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"brown"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"bettie"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
   
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:east</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"williams"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"walter"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:m</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:parent</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="no">:east</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"williams"</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"wanda"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
   </span><span class="p">])</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="code-is-on-github">Code is on Github</h1>

<p>The code can be found <a href="https://gist.github.com/ianrumford/6333358">here</a>.</p>

<p>Note the <strong>reducers</strong> library is referred to as <em>r</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="w">  </span><span class="p">[</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.core.reducers</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">r</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">clojure.string</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">string</span><span class="p">]]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="example-1---how-many-children-in-the-village">Example 1 - how many children in the village?</h1>

<p>An obvious way to do this would be to <em>map</em>  each child to the value 1, else 0.  The total number of children is then the simple addition of the 1s &amp; 0s results of the map operation.</p>

<h2 id="example-1---create-the-reducers-map-function-to-return-1-if-a-child-else-0">Example 1 - create the reducers map function to return 1 if a child, else 0</h2>

<p>But, with <strong>reducers</strong>, you don’t use <em>map</em> in the same way as <strong>core</strong>
map because the <strong>reducers</strong> <em>map</em> function (i.e. r/map below) returns
another function to be used together with a collection and
<em>reduce</em>.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; Example 1 - create the reducers map function to return 1 if a child, else 0
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex1-map-children-to-value-1</span><span class="w"> </span><span class="p">(</span><span class="nf">r/map</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:child</span><span class="w"> </span><span class="p">(</span><span class="no">:role</span><span class="w"> </span><span class="n">%</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-1---use-reduce-to-add-up-all-the-mapped-values">Example 1 - use reduce to add up all the mapped values</h2>

<p>The <em>reduce</em> function has to be used to perform (action) the mapping and then add up the mapped 1 &amp; 0 values.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 1 - use reduce to add up all the mapped values
</span><span class="p">(</span><span class="nf">r/reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nf">ex1-map-children-to-value-1</span><span class="w"> </span><span class="n">village</span><span class="p">))</span><span class="w">
</span><span class="c1">;;=&gt;
</span><span class="mi">8</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>An important point to emphasise here is  the <strong>reducers</strong> <em>map</em>
function only “prepares” the resulting collection to be consumed by
the <em>reduce</em>; the <em>map</em> itself doesn’t do anything off its own bat to the contents of
the collection and needs <em>reduce</em> to “drive” the mapping.</p>

<h1 id="example-2---how-many-children-in-the-brown-family">Example 2 - how many children in the Brown family?</h1>

<p>Ok, how about finding how many children just in the Brown family? Again,
an obvious way to do this would be to select ( <em>filter</em>) the members of the
Brown family, and use the same <em>map</em> function as Example 1 
(<em>ex1-map-children-to-value-1</em>)  to count the children.</p>

<h2 id="example-2---select-the-members-of-the-brown-family">Example 2 - select the members of the Brown family</h2>

<p>Just like <em>map</em>, <strong>reducers</strong> has a <em>filter</em> function that returns another function that can be used with <em>reduce</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; Example 2 - select the members of the Brown family
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex2-select-the-brown-family</span><span class="w"> </span><span class="p">(</span><span class="nf">r/filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="s">"brown"</span><span class="w"> </span><span class="p">(</span><span class="nf">string/lower-case</span><span class="w"> </span><span class="p">(</span><span class="no">:family</span><span class="w"> </span><span class="n">%</span><span class="p">)))))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-2---compose-a-composite-function-to-select-the-brown-family-and-map-children-to-1">Example 2 - compose a composite function to select the Brown family and map children to 1</h2>

<p>The functions returned by <strong>reducers</strong> <em>map</em> and <em>filter</em> can be composed in the usual Clojure way to create a multi-step transformation. So we can create a transformation <em>pipeline</em> function to perform first the <em>ex2-select-the-brown-family</em> and then <em>ex1-map children to 1</em> :</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; compose a composite function to select the Brown family and map children to 1
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex2-pipeline</span><span class="w"> </span><span class="p">(</span><span class="nb">comp</span><span class="w"> </span><span class="n">ex1-map-children-to-value-1</span><span class="w"> </span><span class="n">ex2-select-the-brown-family</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-2---using-reduce-to-add-up-all-the-brown-children">Example 2 - using reduce to add up all the Brown children</h2>

<p>The pipeline function (<em>ex2-pipeline</em>) then can be used with  <em>reduce</em> to find (add) the number of children in the Brown family:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 2 - using reduce to add up all the  Brown children
</span><span class="p">(</span><span class="nf">r/reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nf">ex2-pipeline</span><span class="w"> </span><span class="n">village</span><span class="p">))</span><span class="w">
</span><span class="c1">;;=&gt;
</span><span class="mi">2</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Its worth noting that although this is a multi-step transformation
pipeline (i.e <em>filter</em> then <em>map</em>), the <em>reduce</em> does <em>not</em> need to create any
intermediate collections as would be the case when using <strong>core</strong> <em>map</em>
and <em>filter</em>.  This is a useful performance boost.</p>

<h1 id="example-3---how-many-childrens-names-start-with-j">Example 3 - how many children’s names start with J?</h1>

<p>We already know the answer:  just the 3 children in the <em>Jones</em> family.</p>

<p>Algorithmically, this is a three step pipeline: <em>filter</em> on children, a filter on
names beginning with “j” and then a count of how many children in the result.</p>

<h2 id="example-3---selecting-filtering-just-the-children">Example 3 - selecting (filtering) just the children</h2>

<p>A very simple filter will select just the children:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; Example 3 - selecting (filtering) just the children
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex3-select-children</span><span class="w"> </span><span class="p">(</span><span class="nf">r/filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:child</span><span class="w"> </span><span class="p">(</span><span class="no">:role</span><span class="w"> </span><span class="n">%</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-3---selecting-names-beginning-with-j">Example 3 - selecting names beginning with “j”</h2>

<p>Again, this is a very simple filter:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; Example 3 - selecting names beginning with "j"
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex3-select-names-beginning-with-j</span><span class="w"> </span><span class="p">(</span><span class="nf">r/filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="s">"j"</span><span class="w"> </span><span class="p">(</span><span class="nf">string/lower-case</span><span class="w"> </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="p">(</span><span class="no">:name</span><span class="w"> </span><span class="n">%</span><span class="p">))))))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-3---mapping-the--entries-in-a-collection-to-1">Example 3 - mapping the  entries in a collection to 1</h2>

<p>In Example 1 we created the <em>map</em> function <em>ex1-map-children-to-value-1</em> to
enable <em>reduce</em> to count the number of children.</p>

<p>But the need to count the number
of entries in a collection using <em>reduce</em>, after a pipeline possibly involving many filters and mappers, is
a common one.  This is straightforward to do,  in the final stage of the pipeline use a  <em>map</em> function to transform each entry to
value 1:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; Example 3 - mapping the  entries in a collection to 1
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex0-map-to-value-1</span><span class="w"> </span><span class="p">(</span><span class="nf">r/map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-3---create-the-three-step-pipeline-function">Example 3 - create the three step pipeline function</h2>

<p>As in Example 2, the three-step pipeline can be composed simply:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 3 - create the three step pipeline function
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex3-pipeline</span><span class="w"> </span><span class="p">(</span><span class="nb">comp</span><span class="w"> </span><span class="n">ex0-map-to-value-1</span><span class="w">
                        </span><span class="n">ex3-select-names-beginning-with-j</span><span class="w">
                        </span><span class="n">ex3-select-children</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Its worth labouring the point that composing custom pipelines from
simply individual <em>filters</em> and <em>mappers</em> is very powerful.</p>

<h2 id="example-3---reduce-the-village-with-the-pipeline-function">Example 3 - reduce the village with the pipeline function</h2>

<p>The final reduction should now be familiar and the result will be the number of children whose names begin with “j”:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 3 - reduce the village with the pipeline function
</span><span class="p">(</span><span class="nf">r/reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nf">ex3-pipeline</span><span class="w"> </span><span class="n">village</span><span class="p">))</span><span class="w">
</span><span class="c1">;; =&gt;
</span><span class="mi">3</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="example-4---making-a-collection-of-the-children-whose-names-start-with-j">Example 4 - making a collection of the children whose names start with J?</h1>

<p>Sometimes though you will want the actually collection itself.</p>

<h2 id="example-4---a-pipeline-to-just-filter-children-with-names-starting-with-j">Example 4 - a pipeline to just filter children with names starting with “j”</h2>

<p>Since we want the actual entries, rather than count them, we need a  pure filter pipeline, similar to Example 3 but one that <strong>doesn’t</strong> use the <em>ex-map-to-value-1</em> mapper:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c1">;; Example 4 - a pipeline to just filter children with names starting with "j"
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex4-pipeline</span><span class="w"> </span><span class="p">(</span><span class="nb">comp</span><span class="w"> </span><span class="n">ex3-select-names-beginning-with-j</span><span class="w">
                        </span><span class="n">ex3-select-children</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-4---create-a-vector-with-the-j-children">Example 4 - create a vector with the “j” children</h2>

<p>Creating a vector a <em>vector</em> of the children who’s names start with J can be done simply using <em>into</em>.</p>

<p>Under the covers <em>into</em> uses <em>reduce</em> so making the vector is just a matter of applying the <em>ex4-pipeline</em> function to <em>village</em>  and then using <em>into</em> to build the vector.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c1">;; Example 4 - create a vector with the "j" children
</span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">ex4-pipeline</span><span class="w"> </span><span class="n">village</span><span class="p">))</span><span class="w">
</span><span class="c1">;; =&gt;
</span><span class="p">[{</span><span class="no">:age</span><span class="w"> </span><span class="mi">19</span><span class="n">,</span><span class="w"> </span><span class="no">:home</span><span class="w"> </span><span class="no">:south,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"jackie"</span><span class="n">,</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f,</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:age</span><span class="w"> </span><span class="mi">16</span><span class="n">,</span><span class="w"> </span><span class="no">:home</span><span class="w"> </span><span class="no">:south,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"jason"</span><span class="n">,</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f,</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:age</span><span class="w"> </span><span class="mi">14</span><span class="n">,</span><span class="w"> </span><span class="no">:home</span><span class="w"> </span><span class="no">:south,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"june"</span><span class="n">,</span><span class="w"> </span><span class="no">:sex</span><span class="w"> </span><span class="no">:f,</span><span class="w"> </span><span class="no">:family</span><span class="w"> </span><span class="s">"jones"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="no">:child</span><span class="p">}]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="example-5---average-age-of-children-on-or-below-the-equator">Example 5 - average age of children on or below the equator</h1>

<p>A more involved, but still straightforward, example to finish this section:  what is the average age of the children who live on or below the equator? By equator I mean where <em>home</em> is East, South or West.</p>

<p>To do this, the value of <em>home</em> will be mapped to a latitude and longitude.  For example West will be <em>:lat 0 :lng -180</em> and South is <em>:lat -90 :lng 0</em>.</p>

<h2 id="example-5---select-the-children">Example 5 - select the children</h2>

<p>We can re-use the <em>ex3-select-children</em> filter again.</p>

<h2 id="example-5---map-home-to-latitude-and-longitude">Example 5 - map home to latitude and longitude</h2>

<p>A simple mapper to add latitude and longitude depending on the value of <em>:home</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c1">;; Example 5 - map :home to latitude and longitude
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex5-map-home-to-latitude-and-longitude</span><span class="w">
  </span><span class="p">(</span><span class="nf">r/map</span><span class="w">
   </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nf">condp</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:home</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
       </span><span class="no">:north</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="no">:lat</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="no">:lng</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
       </span><span class="no">:south</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="no">:lat</span><span class="w"> </span><span class="mi">-90</span><span class="w"> </span><span class="no">:lng</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
       </span><span class="no">:west</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="no">:lat</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="no">:lng</span><span class="w"> </span><span class="mi">-180</span><span class="p">)</span><span class="w">
       </span><span class="no">:east</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="no">:lat</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="no">:lng</span><span class="w"> </span><span class="mi">180</span><span class="p">)))))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-5---select-people-on-or-below-the-equator-ie-latitude--0">Example 5 - select people on or below the equator i.e. latitude &lt;= 0</h2>

<p>People on or below the equator have a latitude with maximum value of 0:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; Example 5 - select people on or below the equator i.e. latitude &lt;= 0
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex5-select-on-or-below-equator</span><span class="w"> </span><span class="p">(</span><span class="nf">r/filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="no">:lat</span><span class="w"> </span><span class="n">%</span><span class="p">)))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-5---count-the-number-of-children-on-or-below-the-equator">Example 5 - count the number of children on or below the equator</h2>

<p>To find the average age, we need to know the number of children.</p>

<p>Note, rather than creating a composite pipeline function, in this example the individual stages of the pipeline have been used explicitly:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c1">;; Example 5 - count the number of children on or below the equator
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex5-no-children-on-or-below-the-equator</span><span class="w">
  </span><span class="p">(</span><span class="nf">r/reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="mi">0</span><span class="w">
          </span><span class="p">(</span><span class="nf">ex0-map-to-value-1</span><span class="w">
           </span><span class="p">(</span><span class="nf">ex5-select-people-on-or-below-equator</span><span class="w">
            </span><span class="p">(</span><span class="nf">ex5-map-home-to-latitude-and-longitude</span><span class="w">
             </span><span class="p">(</span><span class="nf">ex3-select-children</span><span class="w"> </span><span class="n">village</span><span class="p">))))))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-5---sum-the-ages-of-children">Example 5 - sum the ages of children</h2>

<p>To sum the ages require the <em>ex0-map-to-value-1</em> to be replaced by a function to select the age value (<em>ex5-select-age</em>):</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c1">;; Example 5 - sum the ages of children
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex5-select-age</span><span class="w"> </span><span class="p">(</span><span class="nf">r/map</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="no">:age</span><span class="w"> </span><span class="n">%</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex5-sum-of-ages-of-children-on-or-below-the-equator</span><span class="w">
  </span><span class="p">(</span><span class="nf">r/reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="mi">0</span><span class="w">
          </span><span class="p">(</span><span class="nf">ex5-select-age</span><span class="w">
           </span><span class="p">(</span><span class="nf">ex5-select-people-on-or-below-equator</span><span class="w">
            </span><span class="p">(</span><span class="nf">ex5-map-home-to-latitude-and-longitude</span><span class="w">
             </span><span class="p">(</span><span class="nf">ex3-select-children</span><span class="w"> </span><span class="n">village</span><span class="p">))))))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-5---calculate-the-average-age-of-children-on-or-below-the-equator">Example 5 - calculate the average age of children on or below the equator</h2>

<p>For completeness, the final  step is the  division to calculate the average age:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 5 - calculate the average age of children on or below the equator
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex5-averge-age-of-children-on-or-below-the-equator</span><span class="w"> </span><span class="p">(</span><span class="nb">float</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">ex5-sum-of-ages-of-children-on-or-below-the-equator</span><span class="w"> </span><span class="n">ex5-no-children-on-or-below-the-equator</span><span class="w"> </span><span class="p">)))</span><span class="w">
</span><span class="c1">;; =&gt;
</span><span class="mf">17.3</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="that-was-fun-but-why-bother">That was fun but why bother?</h1>

<p>The elimination of intermediate collections in <strong>reducers</strong> multi-step pipelines is a very useful performance boost, and 
the <strong>reducers</strong> way of thinking about and processing collections is an interesting mindset change, but are they worth the bother?</p>

<p>The answer lies in a peer function of <em>reduce</em> called <em>fold</em>. When
<em>fold</em> can be used, it will <strong>automatically</strong> parallelise the
processing of the collection, taking advantage of multiple CPU cores.</p>

<p>Where <em>reduce</em> has been used above, <em>fold</em> can be used instead. <strong>NOTE THOUGH</strong> <em>fold</em> has slightly different arguments; at its simplest it does not have / need the initial value.</p>

<p>If needed, <em>fold</em> will drop down to <em>reduce</em> if it can’t parallelise.</p>

<p>In fact, <em>fold</em> breaks the collection down into chunks (currently
defaulting to 512) and processes (<em>reduces</em>) each chunk in parallel. When a chunk
has been processed, its results have to be <strong>combined</strong> with the
results of the other processed chunks.</p>

<p>Bit of unavoidable theory, to maintain the order
of the results the <em>map</em> and <em>filter</em> functions used by <em>fold</em> must
be <a href="http://en.wikipedia.org/wiki/Associative_property">associative</a>. Associativity means simply that how results
are “grouped” together is unimportant e.g. for arithmetic
addition (+) then 1 + (2 + 3) === (1 + 2) + 3 === (1 + 2 + 3). Not all operators are
associative though.</p>

<h1 id="example-6---comparing-the-performance-of-reduce-and-fold">Example 6 - comparing the performance of reduce and fold</h1>

<p>Lets time the addition of the ages from Example 5 using <em>reduce</em> and <em>fold</em>.</p>

<h2 id="example-6---time-reduce-adding-up-example-5s-ages">Example 6 - time reduce adding up Example 5’s ages</h2>

<p>Lets time <em>reduce</em> first:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="c1">;; Example 6 - time reduce adding up Example 5's ages
</span><span class="p">(</span><span class="nb">time</span><span class="w"> </span><span class="p">(</span><span class="nf">r/reduce</span><span class="w"> </span><span class="nb">+</span><span class="w">
                </span><span class="p">(</span><span class="nf">ex5-select-age</span><span class="w">
                 </span><span class="p">(</span><span class="nf">ex5-select-people-on-or-below-equator</span><span class="w">
                  </span><span class="p">(</span><span class="nf">ex5-map-home-to-latitude-and-longitude</span><span class="w">
                   </span><span class="p">(</span><span class="nf">ex3-select-children</span><span class="w"> </span><span class="n">village</span><span class="p">))))))</span><span class="w">
</span><span class="c1">;; =&gt;
</span><span class="s">"Elapsed time: 0.091714 msecs"</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="example-6---time-fold-adding-up-example-5s-ages">Example 6 - time fold adding up Example 5’s ages</h1>

<p>Now <em>fold</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="c1">;; Example 6 - time fold adding up Example 5's ages
</span><span class="p">(</span><span class="nb">time</span><span class="w"> </span><span class="p">(</span><span class="nf">r/fold</span><span class="w"> </span><span class="nb">+</span><span class="w">
              </span><span class="p">(</span><span class="nf">ex5-select-age</span><span class="w">
               </span><span class="p">(</span><span class="nf">ex5-select-people-on-or-below-equator</span><span class="w">
                </span><span class="p">(</span><span class="nf">ex5-map-home-to-latitude-and-longitude</span><span class="w">
                 </span><span class="p">(</span><span class="nf">ex3-select-children</span><span class="w"> </span><span class="n">village</span><span class="p">))))))</span><span class="w">
</span><span class="c1">;; =&gt;
</span><span class="s">"Elapsed time: 0.185448 msecs"</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>So <em>fold</em> took twice as long as <em>reduce</em> in this example because (I guess) the <em>fold</em> <em>“red tape”</em> (e.g. <em>chunking</em> and <em>combining</em>) outweighed the benefit gained from performing the computation in parallel.  No free lunch.</p>

<h1 id="example-7---all-the-relatives-visit-the-village">Example 7 - all the relatives visit the village!</h1>

<p>Every year all the relatives of the families in the village visit and
the population of the village swells enormously. <em>Stick with me on
this :-)</em></p>

<h2 id="example-7---make-some-visitors">Example 7 - make some visitors</h2>

<p>Lets define some functions to create an influx of visitors. <em>Note, no attempt has been made to ensure this randomly generated data makes any sort of real world sense - it could include e.g. a child of age 100.</em></p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="c1">;; Example 7 - make some visitors
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-fn-random-name</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">rand-nth</span><span class="w"> </span><span class="p">[</span><span class="s">"chris"</span><span class="w"> </span><span class="s">"jim"</span><span class="w"> </span><span class="s">"mark"</span><span class="w"> </span><span class="s">"jon"</span><span class="w"> </span><span class="s">"lisa"</span><span class="w"> </span><span class="s">"kate"</span><span class="w"> </span><span class="s">"jay"</span><span class="w"> </span><span class="s">"june"</span><span class="w"> </span><span class="s">"julie"</span><span class="w"> </span><span class="s">"laura"</span><span class="p">])))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-fn-random-family</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">rand-nth</span><span class="w"> </span><span class="p">[</span><span class="s">"smith"</span><span class="w"> </span><span class="s">"jones"</span><span class="w"> </span><span class="s">"brown"</span><span class="w"> </span><span class="s">"williams"</span><span class="w"> </span><span class="s">"taylor"</span><span class="w"> </span><span class="s">"davies"</span><span class="p">])))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-fn-random-home</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">rand-nth</span><span class="w"> </span><span class="p">[</span><span class="no">:north</span><span class="w"> </span><span class="no">:south</span><span class="w"> </span><span class="no">:east</span><span class="w"> </span><span class="no">:west</span><span class="p">])))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-fn-random-sex</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">rand-nth</span><span class="w"> </span><span class="p">[</span><span class="no">:m</span><span class="w"> </span><span class="no">:f</span><span class="p">])))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-fn-random-role</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">rand-nth</span><span class="w"> </span><span class="p">[</span><span class="no">:child</span><span class="w"> </span><span class="no">:parent</span><span class="p">])))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-fn-random-age</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">100</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-visitor-template</span><span class="w">
  </span><span class="p">{</span><span class="no">:home</span><span class="w"> </span><span class="n">ex7-fn-random-home</span><span class="w">
   </span><span class="no">:family</span><span class="w"> </span><span class="n">ex7-fn-random-family</span><span class="w">
   </span><span class="no">:name</span><span class="w"> </span><span class="n">ex7-fn-random-name</span><span class="w">
   </span><span class="no">:age</span><span class="w"> </span><span class="n">ex7-fn-random-age</span><span class="w">
   </span><span class="no">:sex</span><span class="w"> </span><span class="n">ex7-fn-random-sex</span><span class="w">
   </span><span class="no">:role</span><span class="w"> </span><span class="n">ex7-fn-random-role</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">ex7-make-visitor</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[[</span><span class="n">k</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="n">ex7-visitor-template</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="nf">v</span><span class="p">)])))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">ex7-make-visitors</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">take</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="nf">repeatedly</span><span class="w"> </span><span class="n">ex7-make-visitor</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex7-visitors</span><span class="w"> </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">ex7-make-visitors</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-7---count-the-visiting-brown-children-using-reduce">Example 7 - count the visiting Brown children using reduce</h2>

<p>Lets reprise Example 2 and time how long it takes to count the visiting
Brown children using <strong>reducers</strong> <em>reduce</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 7 - count the visiting Brown children using reduce
</span><span class="p">(</span><span class="nb">time</span><span class="w"> </span><span class="p">(</span><span class="nf">r/reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nf">ex2-pipeline</span><span class="w"> </span><span class="n">ex7-visitors</span><span class="p">)))</span><span class="w">
</span><span class="c1">;; =&gt;
</span><span class="s">"Elapsed time: 238.448041 msecs"</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-7---count-the-visiting-brown-children-using-fold">Example 7 - count the visiting Brown children using fold</h2>

<p>Ok, lets try the same using <em>fold</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 7 - count the visiting Brown children using fold
;;(time (r/fold + (ex2-pipeline ex7-visitors)))
;; =&gt;
</span><span class="s">"Elapsed time: 59.6259 msecs"</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Nearly four times faster! (My workstation has four cores.)  <em>The exact timing values should be taken with a pinch of salt though as this wasn’t a rigorous benchmark.  But the improvement is undeniable.</em></p>

<h2 id="example-7---count-the-visiting-brown-children-using-core-map-filter-and-reduce">Example 7 - count the visiting Brown children using core map, filter and reduce</h2>

<p>How do the <strong>reducers</strong> fare against <strong>core</strong> map, filter and reduce?</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c1">;; Example 7 - count the visiting Brown children using core map, filter and reduce
</span><span class="p">(</span><span class="nb">time</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="mi">0</span><span class="w">
              </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:child</span><span class="w"> </span><span class="p">(</span><span class="no">:role</span><span class="w"> </span><span class="n">%</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
                   </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="s">"brown"</span><span class="w"> </span><span class="p">(</span><span class="nf">string/lower-case</span><span class="w"> </span><span class="p">(</span><span class="no">:family</span><span class="w"> </span><span class="n">%</span><span class="p">)))</span><span class="w"> </span><span class="n">ex7-visitors</span><span class="p">))))</span><span class="w">

</span><span class="c1">;; =&gt;
</span><span class="s">"Elapsed time: 223.55717 msecs"</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The <strong>core</strong> <em>reduce</em> and <strong>reducers</strong> <em>reduce</em> timings are pretty much the same; as you might expect since only one intermediate collection would be created by the <strong>core</strong> versions and very little else has changed.</p>

<h1 id="what-else-can-you-do-with-fold">What else can you do with fold?</h1>

<p>Bit more theory.</p>

<p>I mentioned above that <em>fold</em> breaks the collection into chunks, the default chunk size is 512, and each chunk is processed in parallel.</p>

<p>But this raises a question:  how does <em>fold</em> know how to <em>combine</em> the processed chunks to produce the final results?</p>

<p>Because <em>fold</em> can take also the chunk size and  a <em>combiner</em> function as arguments, as well as the usual <em>reducing</em> function and collection.</p>

<p>To demonstrate, here is the  <em>fold</em> from Example 7:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; A simple fold where both the reducer and combiner is +
</span><span class="p">(</span><span class="nf">r/fold</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nf">ex2-pipeline</span><span class="w"> </span><span class="n">ex7-visitors</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>In the above the <strong>+</strong> operator (function) was both the <em>reducer</em> <strong>and</strong> <em>combiner</em>.  No chunk size was given.</p>

<p>A completely specified call to <em>fold</em> could look like this:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">(</span><span class="nf">r/fold</span><span class="w"> </span><span class="n">the-chunk-size</span><span class="w"> </span><span class="p">(</span><span class="nf">r/monoid</span><span class="w"> </span><span class="n">the-combiner-function</span><span class="w"> </span><span class="n">the-init-function</span><span class="p">)</span><span class="w"> </span><span class="n">the-reducer-function</span><span class="w"> </span><span class="n">the-collection</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The reducer function could be <strong>+</strong> but is more likely to some custom logic.</p>

<p>The call to the <em>monoid</em> function is a convenient way of creating a
properly formed combination function that <em>fold</em> can use. <em>monoid</em>
takes two arguments, the first being your <em>combiner</em> function, and the
second being the function that will create the <strong>init</strong> value when it
is called with no arguments. (In the previous examples the init value
to <em>reduce</em> was 0)</p>

<p>Or, if your <em>combiner</em> will generate the <strong>init</strong> value, it can be used directly:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">(</span><span class="nf">r/fold</span><span class="w"> </span><span class="n">the-chunk-size</span><span class="w"> </span><span class="n">the-combiner-function-with-init</span><span class="w"> </span><span class="n">the-reducer-function</span><span class="w"> </span><span class="n">the-collection</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>An example may help to clarify.</p>

<h1 id="example-8---find-the-average-age-of-visiting-children-with-names-beginning-j">Example 8 - find the average age of visiting children with names beginning “j”</h1>

<p>In this example, we’ll calculate the average age of all visiting children with names beginning “j”.  But in just one fold, not like the two-step calculation of average age in Example 5.</p>

<h2 id="example-8---create-a-collection-of-visiting-children-with-name-beginning-with-j">Example 8 - create a collection of visiting children with name beginning with “j”</h2>

<p>To select  visiting children with names starting with “j” we can use exactly the same pipeline from Example 4, apply it to the visitors and store the collection <em>into</em> a vector:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1">;; Example 8 - create a collection of vistsors with name beginning with "j"
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex8-visitors-collection</span><span class="w"> </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nf">ex4-pipeline</span><span class="w"> </span><span class="p">(</span><span class="nf">ex7-make-visitors</span><span class="w"> </span><span class="mi">1000000</span><span class="p">))))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><em>I don’t understand why but fold seems to need a “real” collection else it doesn’t seem to call the combiner.  Answers on a postcard please.</em></p>

<h2 id="example-8---create-the-reducer-to-sum-the-ages-and-number-of-people-in-that-chunk">Example 8 - create the reducer to sum the ages and number of people in that chunk</h2>

<p>The <em>reducer</em> function adds up how many people have been seen in that chunk and also sums their age:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="c1">;; Example 8 - create the reducer to sum the ages and number of people in that chunk
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">ex8-reducer</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="w">
    </span><span class="p">{</span><span class="no">:total-people</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="no">:total-people</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="c1">;; add 1 to number of people seen
</span><span class="w">     </span><span class="no">:total-age</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="no">:age</span><span class="p">))}))</span><span class="w">  </span><span class="err">;;</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">ages</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="example-8---create-the-combiner-to-calculate-the-average-age">Example 8 - create the combiner to calculate the average age</h2>

<p>The <em>combiner</em> takes the results of two processed chunks and calculates the average age.</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="c1">;; Example 8 - create the combiner to calculate the average age
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">ex8-combiner</span><span class="w">
  </span><span class="p">([]</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="c1">;; note this is the init value for each reduced chunk
</span><span class="w">  </span><span class="p">([</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"EX8 CMB FN2 a &gt;%s&lt; b &gt;%s&lt;"</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="p">)))</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">total-people</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="no">:total-people</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="no">:total-people</span><span class="p">))</span><span class="w">
           </span><span class="n">total-age</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="no">:total-age</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="no">:total-age</span><span class="p">))</span><span class="w">
           </span><span class="n">average-age</span><span class="w"> </span><span class="p">(</span><span class="nb">float</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">total-age</span><span class="w"> </span><span class="n">total-people</span><span class="p">))</span><span class="w">
           </span><span class="p">]</span><span class="w">
       </span><span class="p">{</span><span class="no">:total-people</span><span class="w"> </span><span class="n">total-people</span><span class="w">
        </span><span class="no">:total-age</span><span class="w"> </span><span class="n">total-age</span><span class="w">
        </span><span class="no">:average-age</span><span class="w"> </span><span class="n">average-age</span><span class="p">})))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Note, when called with no arguments, it returns the <em>init</em> value for the reduction of each chunk (an empty hash-map here).</p>

<h2 id="example-8---run-the-fold-to-perform-the-average-calculation">Example 8 - run the fold to perform the average calculation</h2>

<p>The average age can now be calculated by running the <em>fold</em>:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1">;; Example 8 - run the fold to perform the average calculation
</span><span class="p">(</span><span class="nf">r/fold</span><span class="w"> </span><span class="n">ex8-combiner-fn2</span><span class="w"> </span><span class="n">ex8-reducer-fn2</span><span class="w">  </span><span class="n">ex8-visitors-collection</span><span class="p">)</span><span class="w">
</span><span class="c1">;; =&gt;
</span><span class="p">{</span><span class="no">:total-people</span><span class="w"> </span><span class="mi">28</span><span class="n">,</span><span class="w"> </span><span class="no">:total-age</span><span class="w"> </span><span class="mi">1314</span><span class="n">,</span><span class="w"> </span><span class="no">:average-age</span><span class="w"> </span><span class="mf">46.92857</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Note, the calculation of the average age in the <em>combiner</em> rather than
the <em>reducer</em> was an artificial distinction for illustration, the
processing could have been performed in one function. One reason why,
when doing arithmetic, a separate <em>combiner</em> often isn’t
necessary. However, one can conceive of some “final logic” that could and should
only be performed in a <em>combiner</em>.</p>

<h1 id="final-words">Final Words</h1>

<p>Some very trivial examples that only scratch the surface of the potential
of <strong>reducers</strong>.</p>

<p>Once you <em>get</em> <strong>reducers</strong> you realise they are
<a href="http://www.infoq.com/presentations/Simple-Made-Easy">simple if perhaps not easy at first</a>.  But once you get
the hang of them, they feel as comfortable and accessible to use as
their <strong>core</strong> equivalents.</p>

<p>The performance benefits from being able to easily parallelise the
processing of collections is undeniable; for very little reworking of
the code, performance can be improved
significantly.</p>

<p>I particularly like how sophisticated, multi-step transformation
pipelines can be composed from individual <em>mappers</em> and <em>filters</em> and used with very little overhead (no need
to create intermediate collections.)</p>


  </article>
  <hr />
</div>


<section class="pager">
  <ul>
    
    <li class="previous"><a href="/ruby/riemann/jmx/hadoop/hbase/2013/01/15/a-ruby-jmx-feed-for-riemann.html" title="A Ruby JMX Feed for Riemann">&larr; Older</a></li>
    
    
    <li class="next"><a href="/clojure/java/jruby/ruby/red/bridge/2013/09/20/calling-jruby-from-java-and-clojure-using-red-bridge.html" title="Calling  JRuby from Java and Clojure using Red Bridge">Newer &rarr;</a></li>
    
  </ul>
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://www.rumford.name/ruby/riemann/jmx/hadoop/hbase/2013/01/15/a-ruby-jmx-feed-for-riemann.html';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://www.rumford.name/clojure/java/jruby/ruby/red/bridge/2013/09/20/calling-jruby-from-java-and-clojure-using-red-bridge.html';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



<div id="disqus_thread"></div>

<script type="text/javascript">

  var disqus_developer = 1;

var disqus_shortname ='';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    <section class="pager">
  
  
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Whistlejacket" src="/images/whistlejacket-circle-128px-2.png" alt="Whistlejacket"/>
  <span>Ian Rumford's whisperings</span>
  <br />

  

  You can contact me via: <br />

  
  <a href="mailto:ian@rumford.name" title="mailto: ian@rumford.name"><i class="fa fa-envelope-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://github.com/ianrumford" title="GithubID: ianrumford"><i class="fa fa-github-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://twitter.com/ianrumford" title="TwitterID: ianrumford"><i class="fa fa-twitter-square fa-3x"></i></a>
  

  

</div>

<div class="sidebar-module">
  <h4>Site Search</h4>
  <form onsubmit="search_google()" >
    <input type="text" id="google-search" placeholder="Google search" />
    <input type="submit" name="sa" value="Go" />
  </form>
</div>


<div class="sidebar-module"> <!-- sidebar-module-inset">-->
  <h4>Copyright Notice</h4>

  

  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
    <img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png">
  </a>
  <br />
  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Attribution-NonCommercial-ShareAlike</a>

  

</div>


<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html" title="Testing Individual Elixir Doctests" rel="bookmark">Testing Individual Elixir Doctests</a>
  </li>
  
  <li>
  <a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html" title="Metaprogramming Without Macros" rel="bookmark">Metaprogramming Without Macros</a>
  </li>
  
  <li>
  <a href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html" title="Sharing and Reusing Elixir Callback Functions between Modules" rel="bookmark">Sharing and Reusing Elixir Callback Functions between Modules</a>
  </li>
  
  <li>
  <a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html" title="Pattern Matching to Polymorphism - an Unexpected Journey" rel="bookmark">Pattern Matching to Polymorphism - an Unexpected Journey</a>
  </li>
  
  <li>
  <a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html" title="Adding a Map API to a GenServer or Module with Agent-held State" rel="bookmark">Adding a Map API to a GenServer or Module with Agent-held State</a>
  </li>
  
</div>


<div class="sidebar-module">
  <h4>Tags</h4>
  
    <a href="/tags/#hello world" title="hello world" rel="1">hello world</a> &nbsp;
  
    <a href="/tags/#octopress" title="octopress" rel="1">octopress</a> &nbsp;
  
    <a href="/tags/#jekyll" title="jekyll" rel="1">jekyll</a> &nbsp;
  
    <a href="/tags/#blog" title="blog" rel="1">blog</a> &nbsp;
  
    <a href="/tags/#emacs" title="emacs" rel="2">emacs</a> &nbsp;
  
    <a href="/tags/#Ubuntu" title="Ubuntu" rel="1">Ubuntu</a> &nbsp;
  
    <a href="/tags/#precise" title="precise" rel="2">precise</a> &nbsp;
  
    <a href="/tags/#pangolin" title="pangolin" rel="1">pangolin</a> &nbsp;
  
    <a href="/tags/#12.04" title="12.04" rel="1">12.04</a> &nbsp;
  
    <a href="/tags/#clojure" title="clojure" rel="1">clojure</a> &nbsp;
  
    <a href="/tags/#leinginen" title="leinginen" rel="1">leinginen</a> &nbsp;
  
    <a href="/tags/#slime" title="slime" rel="1">slime</a> &nbsp;
  
    <a href="/tags/#swank" title="swank" rel="1">swank</a> &nbsp;
  
    <a href="/tags/#ubuntu" title="ubuntu" rel="1">ubuntu</a> &nbsp;
  
    <a href="/tags/#ruby" title="ruby" rel="1">ruby</a> &nbsp;
  
    <a href="/tags/#windows" title="windows" rel="1">windows</a> &nbsp;
  
    <a href="/tags/#ole" title="ole" rel="1">ole</a> &nbsp;
  
    <a href="/tags/#property" title="property" rel="1">property</a> &nbsp;
  
    <a href="/tags/#values" title="values" rel="1">values</a> &nbsp;
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2017" > <a href="/archives/#2017">2017</a></li>
  
  
  
  
  
  
  
  
  
  <li id="2016" > <a href="/archives/#2016">2016</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2014" > <a href="/archives/#2014">2014</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2013" > <a href="/archives/#2013">2013</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2012" > <a href="/archives/#2012">2012</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


</div>



  

  <footer class="site-footer">

  <p>Copyright &copy; <a href="/">An Ostler in IT</a></p>
  <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> 
  on 
  
  <a href="https://github.com/">Github</a>
  
  | Theme <a href="https://github.com/yulijia/freshman21/">Freshman21</a> Design by <a href="http://yulijia.net">Lijia Yu</a>
  | Adapted by Ian Rumford  


  <div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
    <a title="Back To Top"><img src="/images/topbutton.png"/></a>
  </div>

  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/totop.js"></script>  



</footer>


</div>

</body>

</html>
