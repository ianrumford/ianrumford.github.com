<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width initial-scale=1">

<meta property="og:title" content="Sharing and Reusing Elixir Callback Functions between Modules">
<title>Sharing and Reusing Elixir Callback Functions between Modules</title>
<meta property="og:description" content="  TL;DR: Sharing and Reusing Functions in Elixir is easy. Unless its a Callback.There’s a problem?Using a public Elixir function defined in one module(e.g. D...">
<meta property="og:url" content="http://www.rumford.name/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html">
<meta property="og:site_name" content="An Ostler in IT">
<meta property="og:locale" content="en_UK">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ianrumford">
<meta name="twitter:creator" content="@ianrumford">
<meta name="twitter:title" content="Sharing and Reusing Elixir Callback Functions between Modules">
<meta name="twitter:description" content="  TL;DR: Sharing and Reusing Functions in Elixir is easy. Unless its a Callback.There’s a problem?Using a public Elixir function defined in one module(e.g. D...">
<meta name="twitter:url" content="http://www.rumford.name/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html">

<meta name="keywords" content="IT Ostler Horses Courses">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://www.rumford.name/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html">
<link rel="alternate" type="application/atom+xml" title="An Ostler in IT" href="http://www.rumford.name/feed.xml" />

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script language="Javascript" type="text/javascript">
function search_google()
{
  var query = document.getElementById("google-search").value;
  window.open("http://google.com/search?q=" + query
      + "%20site:" + "http://www.rumford.name");
}
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script type='text/javascript'>
var blocklink = ['http://humanorightswatch.org','http://o-o-6-o-o.com','http://darodar.com','http://blackhatworth.com','http://hulfingtonpost.com','http://bestwebsitesawards.com','http://darodar.com','http://buttons-for-website.com','http://ilovevitaly.co','http://semalt.com','http://priceg.com','http://simple-share-buttons.com','http://googlsucks.com','http://4webmasters.org','http://aliexpress.com','http://addons.mozilla.org/en-US/firefox/addon/ilovevitaly/','http://free-share-buttons.com','http://buttons-for-your-website.com','http://theguardlan.com','http://buy-cheap-online.info','http://best-seo-offer.com','http://4webmasters.org','http://trafficmonetize.org','http://howtostopreferralspam.eu','http://ilovevitaly.com','http://sanjosestartups.com','http://free-social-buttons.com','http://best-seo-offer.com','http://guardlink.org','http://www.event-tracking.com','http://www3.free-social-buttons.com','http://www1.free-social-buttons.com','http://www2.free-social-buttons.com','http://websites-reviews.com','http://floating-share-buttons.com','http://satellite.maps.ilovevitaly.com','http://free-social-buttons.com','http://www.event-tracking.com','http://erot.co'];
for (var b = blocklink.length; b--;) {
  if (document.referrer.match(blocklink[b]))
    window.location = "http://www.google.com";
}
</script>



<link type="application/atom+xml" rel="alternate" href="http://www.rumford.name/atom.xml" title="An Ostler in IT" />
</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">An Ostler in IT</a></h1>
    <h3 class="site-meta">Horses for Courses</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/"></a>
        
        
        
        <a class="page-link" href="/feed.xml"></a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 itemprop="name" class="post-title">Sharing and Reusing Elixir Callback Functions between Modules</h1>
    <meta itemprop="keywords" content="" />
    <p class="post-meta">
    Posted in
    
    <a href="/categories/#elixir">elixir</a>, 
    
    <a href="/categories/#siariwyd">siariwyd</a>, 
    
    <a href="/categories/#callback">callback</a>, 
    
    <a href="/categories/#function">function</a>, 
    
    <a href="/categories/#share">share</a>, 
    
    <a href="/categories/#reuse">reuse</a>
     
    
    <time itemprop="datePublished" datetime="2016-11-17">
    on Nov 17, 2016
    </time>
    </p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <blockquote>
  <p>TL;DR: Sharing and Reusing Functions in Elixir is easy. Unless its a Callback.</p>
</blockquote>

<h1 id="theres-a-problema-idorgheadline1a">There’s a problem?<a id="orgheadline1"></a></h1>

<p>Using a public <a href="http://elixir-lang.org/">Elixir</a> function defined in one module
(e.g. <em>DonorA</em>) in another (e.g. <em>Recipient1</em>)  is easy: just call it with the
fully qualified name:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">DonorA</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">donor_a_fun_j</span> <span class="k">do</span>
    <span class="ss">:donor_a_fun_j</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">defmodule</span> <span class="no">Recipient1</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">recipient_a_fun_p</span> <span class="k">do</span>
    <span class="no">DonorA</span><span class="o">.</span><span class="n">donor_a_fun_j</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Proof of the pudding:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">test_donor_a_recipient_1_donor_a_fun_j"</span> <span class="k">do</span>
  <span class="n">assert</span> <span class="ss">:donor_a_fun_j</span> <span class="o">=</span> <span class="no">Recipient1</span><span class="o">.</span><span class="n">recipient_a_fun_p</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><em>Fine. Good. Job Done. End of Post. Thanks for reading.</em></p>

<p>No wait …</p>

<!-- more -->

<p>If you get fed up having to type the fully qualified name all the time
you can <a href="http://elixir-lang.org/docs/stable/elixir/Kernel.SpecialForms.html#import/2">import</a> the donor function(s) into the recipient module.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">Recipient2</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">DonorA</span>
  <span class="k">def</span> <span class="n">recipient_2_fun_p</span> <span class="k">do</span>
    <span class="n">donor_a_fun_j</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">test_donor_a_recipient_2_donor_a_fun_j"</span> <span class="k">do</span>
  <span class="n">assert</span> <span class="ss">:donor_a_fun_j</span> <span class="o">=</span> <span class="no">Recipient2</span><span class="o">.</span><span class="n">recipient_2_fun_p</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><em>Yawn! Trivial stuff! Where’s the beef???</em></p>

<p>When you <a href="http://elixir-lang.org/docs/stable/elixir/Kernel.SpecialForms.html#import/2">import</a> a function, the recipient module
can only use the function internally – it is private – and will <strong>not</strong> be visible externally -
for that you need to <a href="http://elixir-lang.org/docs/stable/elixir/Kernel.html#defdelegate/2">defdelegate</a>:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">Recipient3</span> <span class="k">do</span>
  <span class="k">defdelegate</span> <span class="n">donor_a_fun_j</span><span class="p">(),</span> <span class="ss">to:</span> <span class="no">DonorA</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">test_donor_a_recipient_3_donor_a_fun_j"</span> <span class="k">do</span>
  <span class="n">assert</span> <span class="ss">:donor_a_fun_j</span> <span class="o">=</span> <span class="no">Recipient3</span><span class="o">.</span><span class="n">donor_a_fun_j</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><em>Oh do get on with it! We all know that!</em></p>

<h1 id="lets-try-that-with-some-callback-functionsa-idorgheadline2a">Lets try that with some callback functions<a id="orgheadline2"></a></h1>

<p>If your donor and recipient modules are
<a href="http://elixir-lang.org/getting-started/mix-otp/genserver.html">GenServers</a> they will have one or more
`handle_call/3` or `handle_cast/2` callbacks, usually “front-ended” by a <em>client</em> API functions.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">DonorBGenServer</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="k">def</span> <span class="n">donor_b_genserver_state_get</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:state_get</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="n">handle_call</span><span class="p">(</span><span class="ss">:state_get</span><span class="p">,</span> <span class="n">_fromref</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">defmodule</span> <span class="no">DonorCGenServer</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="k">def</span> <span class="n">donor_c_genserver_state_put</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">{</span><span class="ss">:state_put</span><span class="p">,</span> <span class="n">new_state</span><span class="p">})</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="n">handle_call</span><span class="p">({</span><span class="ss">:state_put</span><span class="p">,</span> <span class="n">new_state</span><span class="p">},</span> <span class="n">_fromref</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># return the old state but update to the new_state</span>
    <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Lets <a href="http://elixir-lang.org/docs/stable/elixir/Kernel.html#defdelegate/2">defdelegate</a> the <em>client</em> API 
and `handle_call/3` functions into a new GenServer recipient module:</p>

<blockquote>
  <p>The `handle_call/3` functions have to be visible externally so GenServer can call them so import wont work.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">Recipient4GenServer</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="c1"># client API functions</span>
  <span class="k">defdelegate</span> <span class="n">donor_b_genserver_state_get</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">DonorBGenServer</span>
  <span class="k">defdelegate</span> <span class="n">donor_c_genserver_state_put</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_state</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">DonorCGenServer</span>
  <span class="c1"># handle_call functions</span>
  <span class="k">defdelegate</span> <span class="n">handle_call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">fromref</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">DonorBGenServer</span>
  <span class="k">defdelegate</span> <span class="n">handle_call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">fromref</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">DonorCGenServer</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Lets check the <strong>state_get</strong> <em>client</em> API call.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">test_donors_bc_genserver_recipient_4_state_get"</span> <span class="k">do</span>
  <span class="n">state</span> <span class="o">=</span> <span class="ss">:initial_state</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Recipient4GenServer</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
  <span class="n">assert</span> <span class="o">^</span><span class="n">state</span> <span class="o">=</span> <span class="no">Recipient4GenServer</span><span class="o">.</span><span class="n">donor_b_genserver_state_get</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Yep.  How about the <strong>state_put</strong>?</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">test_donors_bc_genserver_recipient_4_state_put"</span> <span class="k">do</span>
  <span class="n">state</span> <span class="o">=</span> <span class="ss">:initial_state</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Recipient4GenServer</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
  <span class="n">assert_raise</span> <span class="no">FunctionClauseError</span><span class="p">,</span> <span class="k">fn</span> <span class="o">-&gt;</span>
    <span class="no">Recipient4GenServer</span><span class="o">.</span><span class="n">donor_c_genserver_state_put</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:new_state</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><em>Nope</em>. The error message is interesting:</p>

<blockquote>
  <p>(FunctionClauseError) no function clause matching in DonorBGenServer.handle_call/3</p>
</blockquote>

<p>Its looking in <strong>DonorBGenServer</strong> for the `handle_call/3` for
<strong>DonorCGenServer’s</strong> <strong>donor_c_genserver_state_put</strong>; the second
<em>defdelegate</em> for `handle_call/3` to <strong>DonorCGenServer</strong> has been ignored (as Elixir does).</p>

<blockquote>
  <p>Note although the test is wrapped in an assert_raise, the
FunctionClauseError is not caught. I don’t know why. Anybody?</p>
</blockquote>

<p>So whilst you can <em>defdelegate</em> callbacks to another module, it only
works when <strong>all</strong> of the implementations for a specific callback are in <strong>one</strong> <em>defdelegate-d</em> donor module.</p>

<p><em>Cor blimey! All this time wasted explaining the obvious! Tell us something new!</em></p>

<h1 id="sharing-and-reusing-callbacksa-idorgheadline3a">Sharing and Reusing Callbacks<a id="orgheadline3"></a></h1>

<p>There is nothing special about callback functions in the Elixir sense, the
“specialness” is the way the (e.g. GenServer) callback mechanism works: to allow
pattern matching to recognise them as different implementations of the
same callback function they have to be compiled together in the callback module.</p>

<p>So, if you need to use multiple callbacks from different modules you have
to <em>copy’n’paste</em> their sources into the callback module and then compile them all
together.</p>

<p><em>Or maybe not.</em></p>

<h1 id="cut-to-the-chase-siariwyda-idorgheadline4a">Cut to the Chase: Siariwyd<a id="orgheadline4"></a></h1>

<p><a href="https://hex.pm/packages/siariwyd">Siariwyd</a> allows you to
<em>register</em> (save) the implementations of callbacks defined in <em>donor</em> modules, and <em>include</em> them in
<em>recipient</em> modules at compilation time.</p>

<p>See the <a href="https://hexdocs.pm/siariwyd/api-reference.html">documentation</a> on <a href="https://hex.pm/">Hex</a> for the full
monty but here is a quick example following on from those above.</p>

<p>Lets define two new donors and <em>register</em> their `handle_call/3` implementations using <strong>Siariwyd</strong>:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">DonorPGenServer</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="kn">use</span> <span class="no">Plymio</span><span class="o">.</span><span class="no">Setup</span><span class="o">.</span><span class="no">Client</span><span class="o">.</span><span class="no">Minimal</span>

  <span class="c1"># register (save) the source for all handle_calls in the compiled file</span>
  <span class="kn">use</span> <span class="no">Siariwyd</span><span class="p">,</span> <span class="ss">register:</span> <span class="ss">:handle_call</span>

  <span class="k">def</span> <span class="n">donor_p_genserver_state_get</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:state_get</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_call</span><span class="p">(</span><span class="ss">:state_get</span><span class="p">,</span> <span class="n">_fromref</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">defmodule</span> <span class="no">DonorQGenServer</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="kn">use</span> <span class="no">Plymio</span><span class="o">.</span><span class="no">Setup</span><span class="o">.</span><span class="no">Client</span><span class="o">.</span><span class="no">Minimal</span>

  <span class="c1"># register (save) the source for all handle_calls in the compiled file</span>
  <span class="kn">use</span> <span class="no">Siariwyd</span><span class="p">,</span> <span class="ss">register:</span> <span class="ss">:handle_call</span>

  <span class="k">def</span> <span class="n">donor_q_genserver_state_put</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">{</span><span class="ss">:state_put</span><span class="p">,</span> <span class="n">new_state</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_call</span><span class="p">({</span><span class="ss">:state_put</span><span class="p">,</span> <span class="n">new_state</span><span class="p">},</span> <span class="n">_fromref</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># return the old state but update to the new_state</span>
    <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Now use <strong>Siariwyd</strong> to <em>include</em> the source of the donors’ `handle_call/3` implementations into the recipient:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">Recipient5GenServer</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>

  <span class="c1"># client API functions delegated as before</span>
  <span class="k">defdelegate</span> <span class="n">donor_p_genserver_state_get</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">DonorPGenServer</span>
  <span class="k">defdelegate</span> <span class="n">donor_q_genserver_state_put</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_state</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">DonorQGenServer</span>

  <span class="c1"># use Siariwyd to include the sources of the handle_call functions from the donor modules</span>
  <span class="kn">use</span> <span class="no">Siariwyd</span><span class="p">,</span> <span class="ss">module:</span> <span class="no">DonorPGenServer</span><span class="p">,</span> <span class="ss">include:</span> <span class="ss">:handle_call</span>
  <span class="kn">use</span> <span class="no">Siariwyd</span><span class="p">,</span> <span class="ss">module:</span> <span class="no">DonorQGenServer</span><span class="p">,</span> <span class="ss">include:</span> <span class="ss">:handle_call</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>We can now try the same test that failed above:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">test_donors_pq_genserver_recipient_5_state_get"</span> <span class="k">do</span>
  <span class="n">state</span> <span class="o">=</span> <span class="ss">:initial_state</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Recipient5GenServer</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
  <span class="n">assert</span> <span class="o">^</span><span class="n">state</span> <span class="o">=</span> <span class="no">Recipient5GenServer</span><span class="o">.</span><span class="n">donor_p_genserver_state_get</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">test</span> <span class="sd">"</span><span class="s2">test_donors_pq_genserver_recipient_5_state_put"</span> <span class="k">do</span>
  <span class="n">state</span> <span class="o">=</span> <span class="ss">:initial_state</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="no">Recipient5GenServer</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
  <span class="o">^</span><span class="n">state</span> <span class="o">=</span> <span class="no">Recipient5GenServer</span><span class="o">.</span><span class="n">donor_q_genserver_state_put</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:new_state</span><span class="p">)</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Sucess!</p>

<h1 id="few-more-things-to-notea-idorgheadline10a">Few More Things To Note<a id="orgheadline10"></a></h1>

<h2 id="saving-the-callbacks-implementation-definitionsa-idorgheadline5a">Saving the Callbacks’ Implementation Definitions<a id="orgheadline5"></a></h2>

<p>Siariwyd uses <a href="http://elixir-lang.org/docs/stable/elixir/Module.html">Module’s</a> <a href="http://elixir-lang.org/docs/stable/elixir/Module.html#module-compile-callbacks">compiler callback</a> <em>@on_definition</em> to collect
and save the callbacks’ <strong>implementation definitions</strong>.</p>

<p>A callback’s implementation definition is a map holding most of the
arguments passed to `Module` compiler callback @on_definition,
together with the `:file` and `:line` fields from the `env` argument.</p>

<p>BTW a <a href="http://ianrumford.github.io/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html">previous post of mine</a> goes into more
details on using <em>@on_definition</em> and how to persist data in the
module’s compiled (BEAM) file.</p>

<h2 id="default-is-to-include-all-implementations-for-all-registered-functionsa-idorgheadline6a">Default is to Include all Implementations for all Registered Functions<a id="orgheadline6"></a></h2>

<p>If neither `:include` nor `:register` options are given, the default is
to <em>include</em> <strong>all</strong> implementations for <strong>all</strong> registered functions in
the donor module. e.g.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kn">use</span> <span class="no">Siariwyd</span><span class="p">,</span> <span class="ss">module:</span> <span class="no">DonorPGenServer</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="filtering-the-included-implementationsa-idorgheadline7a">Filtering the Included Implementations<a id="orgheadline7"></a></h2>

<p>Optionally, Siariwyd can take a <em>filter</em> function to refine the
implementations to <em>include</em>. The filter function is passed an
<strong>implementation definition</strong> and must return <em>truthy</em> or <em>falsy</em>.</p>

<p>Here is a <em>silly</em> example filter where the handle_call responding to
<em>:state_put</em> is <strong>discarded</strong> (and all other register functions are also
<strong>discarded</strong>).</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="kn">use</span> <span class="no">Siariwyd</span><span class="p">,</span> <span class="ss">module:</span> <span class="no">DonorPGenServer</span><span class="p">,</span> <span class="ss">include:</span> <span class="ss">:handle_call</span><span class="p">,</span>
  <span class="ss">filter:</span> <span class="k">fn</span> 

  <span class="c1"># match handle_call definitions</span>
  <span class="p">%{</span><span class="ss">name:</span> <span class="ss">:handle_call</span><span class="p">,</span> <span class="ss">args:</span> <span class="n">args</span><span class="p">}</span> <span class="o">=</span> <span class="n">_implementation_definition</span> <span class="o">-&gt;</span>
  <span class="c1"># args is the list of quoted arguments to the implementation </span>
  <span class="c1"># e.g. handle_call(:state_get, fromref, state)</span>
  <span class="k">case</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">first</span> <span class="k">do</span>
    <span class="ss">:state_get</span> <span class="o">-&gt;</span> <span class="no">false</span>
    <span class="n">_</span> <span class="o">-&gt;</span> <span class="no">true</span>
  <span class="k">end</span>

  <span class="c1"># not handle_call - discard</span>
  <span class="n">_</span> <span class="o">-&gt;</span> <span class="no">false</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>If you run the tests in the <a href="https://github.com/ianrumford/siariwyd_examples">examples</a> to go with this post, you’ll see the
expected error: there is no longer a handle_call implementation
responding to <em>:state_get</em></p>

<blockquote>
  <p>(FunctionClauseError) no function clause matching in
Recipient6GenServer.handle_call/3
(siariwyd_examples) lib/recipient_6_genserver.ex:24: Recipient6GenServer.handle_call(:state_get, {#PID&lt;0.167.0&gt;, #Reference&lt;0.0.2.132&gt;}, :initial_state)</p>
</blockquote>

<h2 id="transforming-the-included-implementationsa-idorgheadline8a">Transforming the included implementations<a id="orgheadline8"></a></h2>

<p>Siariwyd optionally can take an  <em>mapper</em> function to transform the
original, donor implementation
before inclusion into the recipient. The <em>mapper</em> function is passed
an <strong>implementation definition</strong> and must return the definition,
normally with the `:ast` key updated.</p>

<p>A <em>mapper</em> function is more complicated because the definition must be
edited and the complete implementation rebuilt. Siariwyd provides a
convenience function `Siariwyd.reconstruct_function/1` to rebuild the
`:ast` from the (updated) definition.</p>

<p>Another silly example, this time to change the handle_call’s response from
<em>:state_get</em> to <em>:hello_world</em>. (The
<a href="https://github.com/ianrumford/siariwyd_examples">examples</a> has a full example showing how a new <em>client</em> API
function can use the <em>:hello_world</em> implementation.)</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></td><td class="code"><pre><span class="kn">use</span> <span class="no">Siariwyd</span><span class="p">,</span> <span class="ss">module:</span> <span class="no">DonorPGenServer</span><span class="p">,</span> <span class="ss">include:</span> <span class="ss">:handle_call</span><span class="p">,</span>
  <span class="ss">mapper:</span> <span class="k">fn</span> 

  <span class="c1"># select handle_call definition</span>
  <span class="p">%{</span><span class="ss">name:</span> <span class="ss">:handle_call</span><span class="p">,</span> <span class="ss">args:</span> <span class="n">args</span><span class="p">,</span> <span class="ss">ast:</span> <span class="n">ast</span><span class="p">}</span> <span class="o">=</span> <span class="n">implementation_definition</span> <span class="o">-&gt;</span>
  <span class="c1"># args is the list of quoted arguments to the implementation </span>
  <span class="c1"># e.g. handle_call(:state_get, fromref, state)</span>

  <span class="p">[</span><span class="n">arg</span> <span class="o">|</span> <span class="n">rest_args</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

  <span class="k">case</span> <span class="n">arg</span> <span class="k">do</span>
    <span class="ss">:state_get</span> <span class="o">-&gt;</span> 

      <span class="c1"># change the args to respond to :hello_world and reconstruct the implementation</span>
      <span class="n">implementation_definition</span>
      <span class="o">|&gt;</span> <span class="no">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="ss">:args</span><span class="p">,</span> <span class="p">[</span><span class="ss">:hello_world</span> <span class="o">|</span> <span class="n">rest_args</span><span class="p">])</span>
      <span class="c1"># reconstruct the complete implementation using the convenience function</span>
      <span class="o">|&gt;</span> <span class="no">Siariwyd</span><span class="o">.</span><span class="n">reconstruct_function</span>

    <span class="c1"># nothing to do</span>
    <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
  <span class="k">end</span>

  <span class="c1"># passthru</span>
  <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Again the <a href="https://github.com/ianrumford/siariwyd_examples">examples</a> has a test to show
the error for the “missing” handle_call for <em>:state_get</em>, and how a new <em>client</em> API
function <strong>recipient_7_hello_world</strong> calls the mapped <em>:state_get</em> handle_call.</p>

<h2 id="not-just-callbacksa-idorgheadline9a">Not just callbacks<a id="orgheadline9"></a></h2>

<p>Finally, although focused on callbacks, Siariwyd should work with any function that has multiple implementations that need to be compiled together.</p>

<h1 id="on-hex-and-githuba-idorgheadline11a">On Hex and Github<a id="orgheadline11"></a></h1>

<p><a href="https://hex.pm/packages/siariwyd">Siariwyd in on Hex</a>.</p>

<p><a href="https://github.com/ianrumford/siariwyd">Repo is on Github</a>.</p>

<p><a href="https://github.com/ianrumford/siariwyd_examples">Examples above are on Github</a>.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="nb">cd</span> /tmp
git clone git@github.com:ianrumford/siariwyd_examples.git
<span class="nb">cd </span>siariwyd_examples
mix <span class="nb">test</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>


  </article>
  <hr />
</div>


<section class="pager">
  <ul>
    
    <li class="previous"><a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html" title="Pattern Matching to Polymorphism - an Unexpected Journey">&larr; Older</a></li>
    
    
    <li class="next"><a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html" title="Metaprogramming Without Macros">Newer &rarr;</a></li>
    
  </ul>
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://www.rumford.name/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://www.rumford.name/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



<div id="disqus_thread"></div>

<script type="text/javascript">

  var disqus_developer = 1;

var disqus_shortname ='';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    <section class="pager">
  
  
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Whistlejacket" src="/images/whistlejacket-circle-128px-2.png" alt="Whistlejacket"/>
  <span>Ian Rumford's whisperings</span>
  <br />

  

  You can contact me via: <br />

  
  <a href="mailto:ian@rumford.name" title="mailto: ian@rumford.name"><i class="fa fa-envelope-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://github.com/ianrumford" title="GithubID: ianrumford"><i class="fa fa-github-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://twitter.com/ianrumford" title="TwitterID: ianrumford"><i class="fa fa-twitter-square fa-3x"></i></a>
  

  

</div>

<div class="sidebar-module">
  <h4>Site Search</h4>
  <form onsubmit="search_google()" >
    <input type="text" id="google-search" placeholder="Google search" />
    <input type="submit" name="sa" value="Go" />
  </form>
</div>


<div class="sidebar-module"> <!-- sidebar-module-inset">-->
  <h4>Copyright Notice</h4>

  

  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
    <img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png">
  </a>
  <br />
  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Attribution-NonCommercial-ShareAlike</a>

  

</div>


<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html" title="Testing Individual Elixir Doctests" rel="bookmark">Testing Individual Elixir Doctests</a>
  </li>
  
  <li>
  <a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html" title="Metaprogramming Without Macros" rel="bookmark">Metaprogramming Without Macros</a>
  </li>
  
  <li>
  <a href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html" title="Sharing and Reusing Elixir Callback Functions between Modules" rel="bookmark">Sharing and Reusing Elixir Callback Functions between Modules</a>
  </li>
  
  <li>
  <a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html" title="Pattern Matching to Polymorphism - an Unexpected Journey" rel="bookmark">Pattern Matching to Polymorphism - an Unexpected Journey</a>
  </li>
  
  <li>
  <a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html" title="Adding a Map API to a GenServer or Module with Agent-held State" rel="bookmark">Adding a Map API to a GenServer or Module with Agent-held State</a>
  </li>
  
</div>


<div class="sidebar-module">
  <h4>Tags</h4>
  
    <a href="/tags/#hello world" title="hello world" rel="1">hello world</a> &nbsp;
  
    <a href="/tags/#octopress" title="octopress" rel="1">octopress</a> &nbsp;
  
    <a href="/tags/#jekyll" title="jekyll" rel="1">jekyll</a> &nbsp;
  
    <a href="/tags/#blog" title="blog" rel="1">blog</a> &nbsp;
  
    <a href="/tags/#emacs" title="emacs" rel="2">emacs</a> &nbsp;
  
    <a href="/tags/#Ubuntu" title="Ubuntu" rel="1">Ubuntu</a> &nbsp;
  
    <a href="/tags/#precise" title="precise" rel="2">precise</a> &nbsp;
  
    <a href="/tags/#pangolin" title="pangolin" rel="1">pangolin</a> &nbsp;
  
    <a href="/tags/#12.04" title="12.04" rel="1">12.04</a> &nbsp;
  
    <a href="/tags/#clojure" title="clojure" rel="1">clojure</a> &nbsp;
  
    <a href="/tags/#leinginen" title="leinginen" rel="1">leinginen</a> &nbsp;
  
    <a href="/tags/#slime" title="slime" rel="1">slime</a> &nbsp;
  
    <a href="/tags/#swank" title="swank" rel="1">swank</a> &nbsp;
  
    <a href="/tags/#ubuntu" title="ubuntu" rel="1">ubuntu</a> &nbsp;
  
    <a href="/tags/#ruby" title="ruby" rel="1">ruby</a> &nbsp;
  
    <a href="/tags/#windows" title="windows" rel="1">windows</a> &nbsp;
  
    <a href="/tags/#ole" title="ole" rel="1">ole</a> &nbsp;
  
    <a href="/tags/#property" title="property" rel="1">property</a> &nbsp;
  
    <a href="/tags/#values" title="values" rel="1">values</a> &nbsp;
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2017" > <a href="/archives/#2017">2017</a></li>
  
  
  
  
  
  
  
  
  
  <li id="2016" > <a href="/archives/#2016">2016</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2014" > <a href="/archives/#2014">2014</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2013" > <a href="/archives/#2013">2013</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2012" > <a href="/archives/#2012">2012</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


</div>



  

  <footer class="site-footer">

  <p>Copyright &copy; <a href="/">An Ostler in IT</a></p>
  <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> 
  on 
  
  <a href="https://github.com/">Github</a>
  
  | Theme <a href="https://github.com/yulijia/freshman21/">Freshman21</a> Design by <a href="http://yulijia.net">Lijia Yu</a>
  | Adapted by Ian Rumford  


  <div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
    <a title="Back To Top"><img src="/images/topbutton.png"/></a>
  </div>

  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/totop.js"></script>  



</footer>


</div>

</body>

</html>
