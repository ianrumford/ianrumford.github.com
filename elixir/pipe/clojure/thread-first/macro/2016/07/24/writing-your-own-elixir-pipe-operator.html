<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width initial-scale=1">

<meta property="og:title" content="Writing your own Elixir pipe operator">
<title>Writing your own Elixir pipe operator</title>
<meta property="og:description" content="  TL;DR: Elixir - a language that positively celebrates the use of macrosI’ve been picking up some Elixir soI can try my hand at a new project I want to buil...">
<meta property="og:url" content="http://www.rumford.name/elixir/pipe/clojure/thread-first/macro/2016/07/24/writing-your-own-elixir-pipe-operator.html">
<meta property="og:site_name" content="An Ostler in IT">
<meta property="og:locale" content="en_UK">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ianrumford">
<meta name="twitter:creator" content="@ianrumford">
<meta name="twitter:title" content="Writing your own Elixir pipe operator">
<meta name="twitter:description" content="  TL;DR: Elixir - a language that positively celebrates the use of macrosI’ve been picking up some Elixir soI can try my hand at a new project I want to buil...">
<meta name="twitter:url" content="http://www.rumford.name/elixir/pipe/clojure/thread-first/macro/2016/07/24/writing-your-own-elixir-pipe-operator.html">

<meta name="keywords" content="IT Ostler Horses Courses">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://www.rumford.name/elixir/pipe/clojure/thread-first/macro/2016/07/24/writing-your-own-elixir-pipe-operator.html">
<link rel="alternate" type="application/atom+xml" title="An Ostler in IT" href="http://www.rumford.name/feed.xml" />

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script language="Javascript" type="text/javascript">
function search_google()
{
  var query = document.getElementById("google-search").value;
  window.open("http://google.com/search?q=" + query
      + "%20site:" + "http://www.rumford.name");
}
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script type='text/javascript'>
var blocklink = ['http://humanorightswatch.org','http://o-o-6-o-o.com','http://darodar.com','http://blackhatworth.com','http://hulfingtonpost.com','http://bestwebsitesawards.com','http://darodar.com','http://buttons-for-website.com','http://ilovevitaly.co','http://semalt.com','http://priceg.com','http://simple-share-buttons.com','http://googlsucks.com','http://4webmasters.org','http://aliexpress.com','http://addons.mozilla.org/en-US/firefox/addon/ilovevitaly/','http://free-share-buttons.com','http://buttons-for-your-website.com','http://theguardlan.com','http://buy-cheap-online.info','http://best-seo-offer.com','http://4webmasters.org','http://trafficmonetize.org','http://howtostopreferralspam.eu','http://ilovevitaly.com','http://sanjosestartups.com','http://free-social-buttons.com','http://best-seo-offer.com','http://guardlink.org','http://www.event-tracking.com','http://www3.free-social-buttons.com','http://www1.free-social-buttons.com','http://www2.free-social-buttons.com','http://websites-reviews.com','http://floating-share-buttons.com','http://satellite.maps.ilovevitaly.com','http://free-social-buttons.com','http://www.event-tracking.com','http://erot.co'];
for (var b = blocklink.length; b--;) {
  if (document.referrer.match(blocklink[b]))
    window.location = "http://www.google.com";
}
</script>



<link type="application/atom+xml" rel="alternate" href="http://www.rumford.name/atom.xml" title="An Ostler in IT" />
</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">An Ostler in IT</a></h1>
    <h3 class="site-meta">Horses for Courses</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/"></a>
        
        
        
        <a class="page-link" href="/feed.xml"></a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 itemprop="name" class="post-title">Writing your own Elixir pipe operator</h1>
    <meta itemprop="keywords" content="" />
    <p class="post-meta">
    Posted in
    
    <a href="/categories/#elixir">elixir</a>, 
    
    <a href="/categories/#pipe">pipe</a>, 
    
    <a href="/categories/#clojure">clojure</a>, 
    
    <a href="/categories/#thread-first">thread-first</a>, 
    
    <a href="/categories/#macro">macro</a>
     
    
    <time itemprop="datePublished" datetime="2016-07-24">
    on Jul 24, 2016
    </time>
    </p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <blockquote>
  <p>TL;DR: Elixir - a language that positively celebrates the use of macros</p>
</blockquote>

<p>I’ve been picking up some <a href="http://elixir-lang.org/">Elixir</a> so
I can try my hand at a new project I want to build using the
<a href="http://www.erlang.org/">Erlang/OTP</a> ecosystem.</p>

<p><a href="http://elixir-lang.org/">Elixir</a> uses <em>lots and lots</em> of
compile-time macros. The language’s pervasive use of macros
is unprecedented in my experience. Most (all?) of the core features of Elixir (its
<a href="http://elixir-lang.org/docs/v1.0/elixir/Kernel.SpecialForms.html">special forms</a>) are (non-overridable) macros
(e.g. the <a href="http://elixir-lang.org/docs/v1.0/elixir/Kernel.SpecialForms.html#case/2">case</a> statement)</p>

<p>Everybody likes and wants to use a language that has macros. But you
are not supposed to use them right? ☺  ☺  ☺</p>

<p>Possibly the single most
comment that has endeared me to <a href="http://elixir-lang.org/">Elixir</a> and its community
is a passage from 
<a href="https://twitter.com/chris_mccord">Chris McCord’s</a> great book <a href="https://pragprog.com/book/cmelixir/metaprogramming-elixir">Metaprogramming Elixir</a>.</p>

<blockquote>
  <p>Some of the greatest insights I’ve had with macros have been with
irresponsible code that I would never ship to production. There’s no
substitute for learning by experimentation.</p>

  <p>Write irresponsible code, experiment, and have fun. Use the insight
you gain to drive design decisions of things you would ship to a
production system.</p>
</blockquote>

<p>In the same vein as Chris’s <em>just-give-it-a-go-and-learn-some-lessons</em> meme, I recently watched <a href="https://twitter.com/ztellman">Zack Tellman’s</a>
talk
<a href="https://www.youtube.com/watch?v=o69H0MXCNxw">Some Things that Macros do</a>
at last year’s <a href="http://www.curry-on.org/">Curry On!</a> where he made the point that macro usage in <a href="http:///clojure.org">Clojure</a> has tended to be either
at the low-end, standard fare of boilerplate removal, or up at the high-end where the
<em>doyen</em> of <a href="http:///clojure.org">Clojure</a> macros
<a href="http://www.infoq.com/interviews/baldridge-core-async">core.async</a> towers.
Zack reckoned the gap between the two extremes offered plenty of
space for people to <em>experiment</em>  with macros.</p>

<p>So, with that thought, this post is my first <em>irresponsible experiment</em> in designing, writing
and using <a href="http://elixir-lang.org/">Elixir</a> macros. <em>Caveat Emptor</em></p>

<!-- more -->

<h1 id="elixirs-built-in-pipe--operatora-idorgheadline1a">Elixir’s built-in pipe |&gt; operator?<a id="orgheadline1"></a></h1>

<p>Of course anybody who has written even the merest snippet of Elixir knows it already
has a statement threading operator: the <a href="http://joearms.github.io/2013/05/31/a-week-with-elixir.html">famous</a> <a href="http://elixir-lang.org/docs/stable/elixir/#!Kernel.html#%7C%3E/2">pipe operator</a> <code class="highlighter-rouge">|&gt;</code></p>

<p>The <a href="http://elixir-lang.org/getting-started/enumerables-and-streams.html#the-pipe-operator">docs</a> say</p>

<blockquote>
  <p>it simply takes the output from the expression on its left side and
passes it as the first argument to the function call on its right
side.</p>
</blockquote>

<p>The <code class="highlighter-rouge">|&gt;</code> is really syntactic sugar that enables this code that creates
the string <strong>HelloWorld</strong></p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Stream</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sd">"</span><span class="s2">hello world"</span><span class="p">),</span> <span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>… to be written like this:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="sd">"</span><span class="s2">hello world"</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span> <span class="o">|&gt;</span> <span class="no">Stream</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>… or even like this where each <code class="highlighter-rouge">|&gt;</code> breaks
onto a new line.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="sd">"</span><span class="s2">hello world"</span> 
<span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span> 
<span class="o">|&gt;</span> <span class="no">Steam</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">)</span> 
<span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>No difference at all to the final, generated, code (and result) but
again a welcome boost to
visual clarity.</p>

<h1 id="elixir-metaprogramminga-idorgheadline4a">Elixir Metaprogramming<a id="orgheadline4"></a></h1>

<p>To explain how the <code class="highlighter-rouge">|&gt;</code> macro works needs a bit of an explanation of
how Elixir does code generation. Many people have already covered the
structure of an AST notably <a href="https://twitter.com/chris_mccord">Chris’s</a>
<a href="https://pragprog.com/book/cmelixir/metaprogramming-elixir">book</a> but also in many fine blogs
out there (see for example <a href="https://twitter.com/sasajuric">Sasa Juric’s</a> <a href="http://www.theerlangelist.com/2014/06/understanding-elixir-macros-part-1.html">series on
macros</a>). So I’m not going to delve too deep.</p>

<p>To set the scene, when you (run-time) metaprogram in <a href="https://www.ruby-lang.org">Ruby</a> you build the string
representation of the new code and call e.g.
<a href="http://ruby-doc.org/core-2.1.0/Module.html#method-i-class_eval">class_eval</a> to compile it.</p>

<p>Clojure, being a <a href="http://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a>, is <a href="https://en.wikipedia.org/wiki/Homoiconicity">homoiconic</a> so you’d
write a (compile-time) macro to construct <a href="https://en.wikipedia.org/wiki/S-expression">s-expressions</a> with the new code.</p>

<p>Elixir’s <em>lingua franca</em> of code generation is a quoted <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract
syntax tree</a> (<strong>AST</strong>). Elixir ASTs are <a href="https://en.wikipedia.org/wiki/Homoiconicity">homoiconic</a> and
<a href="https://en.wikipedia.org/wiki/Fractal">fractal-like</a>.</p>

<p>Elixir macros take an <a href="http://elixir-lang.org/getting-started/meta/quote-and-unquote.html">AST</a>, transform it and
return the transformed <a href="http://elixir-lang.org/getting-started/meta/quote-and-unquote.html">AST</a> which is then
compiled by the compiler.</p>

<h2 id="whats-in-an-asta-idorgheadline2a">What’s in an AST?<a id="orgheadline2"></a></h2>

<p>An Elixir <a href="http://elixir-lang.org/getting-started/meta/quote-and-unquote.html">AST</a> is a <a href="http://elixir-lang.org/getting-started/basic-types.html#tuples">tuple</a> with three elements:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span><span class="n">function</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">call</span><span class="p">,</span> <span class="n">function</span><span class="o">-</span><span class="n">metadata</span><span class="p">,</span> <span class="n">function</span><span class="o">-</span><span class="n">arguments</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<ol>
  <li>
    <p>The <em>function-to-call</em> is often an <a href="http://elixir-lang.org/getting-started/basic-types.html#atoms">atom</a> of the function
to call e.g. <em>:hd</em> (to take the head of a list), or it may be another AST for
example representing a call to a function in another module; .</p>
  </li>
  <li>
    <p>The <em>function-metadata</em> is “red tape” which I wont dwell on here.</p>
  </li>
  <li>
    <p>The <em>function-arguments</em> is an <a href="http://elixir-lang.org/getting-started/basic-types.html#linked-lists">list</a> containing the
arguments to the functions.  The arguments may be literals e.g. 42 or,
again, ASTs.</p>
  </li>
</ol>

<p>ASTs are regular, recursive structure including <a href="http://elixir-lang.org/getting-started/basic-types.html#tuples">tuples</a>,
<a href="http://elixir-lang.org/getting-started/basic-types.html#linked-lists">lists</a>, <a href="http://elixir-lang.org/getting-started/basic-types.html#atoms">atoms</a> and “literals” such
as <a href="http://elixir-lang.org/getting-started/binaries-strings-and-char-lists.html">strings</a>, <a href="http://elixir-lang.org/getting-started/basic-types.html#booleans">booleans</a> (i.e.
true or false)  and numbers (1, 2, etc)</p>

<h2 id="show-me-an-asta-idorgheadline3a">Show me an AST!<a id="orgheadline3"></a></h2>

<p>The AST for any code can be created using the
<a href="http://elixir-lang.org/getting-started/meta/quote-and-unquote.html">quote</a> function.</p>

<p>Try this in Elixir’s interactive repl <a href="http://elixir-lang.org/getting-started/introduction.html#interactive-mode">iex</a> to see the
AST for the first step of the example above, splitting the “hello world” string</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">iex</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sd">"</span><span class="s2">hello world"</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>and you’ll see a  simple AST showing the the <strong>Kernel</strong> function <em>.</em> (dot) being
used to call the <em>split</em> function in module <strong>String</strong> with the
argument “hello world”:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:String</span><span class="p">]},</span> <span class="ss">:split</span><span class="p">]},</span> <span class="p">[],</span> <span class="p">[</span><span class="sd">"</span><span class="s2">hello world"</span><span class="p">]}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>If you have a look at the AST generated when using the pipe operator i.e.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">iex</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">hello world"</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>and you should see something like this:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="p">{</span><span class="ss">:|</span><span class="o">&gt;</span><span class="p">,</span> 
 <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
 <span class="p">[</span><span class="sd">"</span><span class="s2">hello world"</span><span class="p">,</span> 
  <span class="p">{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:String</span><span class="p">]},</span> <span class="ss">:split</span><span class="p">]},</span> <span class="p">[],</span> <span class="p">[]}]}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>This AST is quite hard to parse by
eye, but if you stare at it for a while, you should be able to discern
its the  <code class="highlighter-rouge">|&gt;</code> operator being called with two arguments:</p>

<ol>
  <li>
    <p>The first argument is “<strong>hello world</strong>” string; and</p>
  </li>
  <li>
    <p>The second argument is essentially the same AST as above when 
Kernel <em>.</em> (dot) was used to call <em>split</em> in <strong>String</strong> but <strong>without</strong> 
the “<strong>hello world</strong>” string as the <strong>first</strong> argument i.e.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:String</span><span class="p">]},</span> <span class="ss">:split</span><span class="p">]},</span> <span class="p">[],</span> <span class="p">[]}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>To labour this point: the AST for the <code class="highlighter-rouge">|&gt;</code> has two arguments, one of
which is another AST.</p>

<h1 id="the--is-just-an-elixir-macroa-idorgheadline7a">The |&gt; is just an Elixir macro<a id="orgheadline7"></a></h1>

<p>The <code class="highlighter-rouge">|&gt;</code> operator is just a macro, and a very brief one at that with
only two lines using <strong>Macro</strong> <em>pipe</em> and <em>unpipe</em>.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="k">defmacro</span> <span class="n">left</span> <span class="o">|&gt;</span> <span class="n">right</span> <span class="k">do</span>
  <span class="p">[{</span><span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span><span class="o">|</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="no">Macro</span><span class="o">.</span><span class="n">unpipe</span><span class="p">({</span><span class="ss">:|</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">]})</span>
  <span class="ss">:lists</span><span class="o">.</span><span class="n">foldl</span> <span class="k">fn</span> <span class="p">{</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">},</span> <span class="n">acc</span> <span class="o">-&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>How does so little code do so much?</p>

<h2 id="the-macrounpipe-calla-idorgheadline5a">The Macro.unpipe call<a id="orgheadline5"></a></h2>

<p>Lets generate the AST for the complete <strong>HelloWorld</strong> pipeline</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1"># generate the ast for the complete HelloWorld pipeline</span>
<span class="n">iex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">pipeline_ast</span> <span class="o">=</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">hello world"</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span> <span class="o">|&gt;</span> <span class="no">Stream</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>you’ll see</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="p">{</span><span class="ss">:|</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
 <span class="p">[{</span><span class="ss">:|</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
   <span class="p">[{</span><span class="ss">:|</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
     <span class="p">[</span><span class="sd">"</span><span class="s2">hello world"</span><span class="p">,</span>
      <span class="p">{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:String</span><span class="p">]},</span> <span class="ss">:split</span><span class="p">]},</span> <span class="p">[],</span> <span class="p">[]}]},</span>
    <span class="p">{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:Stream</span><span class="p">]},</span> <span class="ss">:map</span><span class="p">]},</span> <span class="p">[],</span>
     <span class="p">[{</span><span class="ss">:&amp;</span><span class="p">,</span> <span class="p">[],</span>
       <span class="p">[{</span><span class="ss">:/</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
         <span class="p">[{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:String</span><span class="p">]},</span> <span class="ss">:capitalize</span><span class="p">]},</span>
           <span class="p">[],</span> <span class="p">[]},</span> <span class="m">1</span><span class="p">]}]}]}]},</span>
  <span class="p">{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:Enum</span><span class="p">]},</span> <span class="ss">:join</span><span class="p">]},</span> <span class="p">[],</span> <span class="p">[]}]}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Now run the <strong>Macro</strong> <em>unpipe</em> call on the pipeline_ast</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1"># run unpipe on the pipeline ast</span>
<span class="n">pipeline_tuples</span> <span class="o">=</span> <span class="no">Macro</span><span class="o">.</span><span class="n">unpipe</span><span class="p">(</span><span class="n">pipeline_ast</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>you’ll see a <a href="http://elixir-lang.org/getting-started/basic-types.html#linked-lists">list</a> - <em>pipeline_tuples</em> - with four
items which I’ve laid out and annotated below to try to highlight
the structure and contents.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="p">[</span>
  <span class="c1"># The "source" - a tuple with two elements, the first being the initial string</span>
  <span class="p">{</span><span class="sd">"</span><span class="s2">hello world"</span><span class="p">,</span> <span class="m">0</span><span class="p">},</span>

  <span class="c1"># This is the String.split step</span>
  <span class="c1"># Note it is also a 2tuple, the first being the ast for the call to</span>
  <span class="c1"># String.split *without* any args (i.e. the "hello world").</span>
  <span class="c1"># BTW the second element of the 2tuple is 0</span>
  <span class="p">{{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:String</span><span class="p">]},</span> <span class="ss">:split</span><span class="p">]},</span> <span class="p">[],</span> <span class="p">[]},</span> <span class="m">0</span><span class="p">},</span>

  <span class="c1"># This is the Stream.map step</span>
  <span class="c1"># As before its a 2tuple where the first element is the call to</span>
  <span class="c1"># Enum.map with *only* one argument: the call to String.capitalize.</span>
  <span class="c1"># So it is missing the first argument: the result of the String.split</span>
  <span class="p">{{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:Stream</span><span class="p">]},</span> <span class="ss">:map</span><span class="p">]},</span> <span class="p">[],</span>
    <span class="p">[{</span><span class="ss">:&amp;</span><span class="p">,</span> <span class="p">[],</span>
      <span class="p">[{</span><span class="ss">:/</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
        <span class="p">[{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:String</span><span class="p">]},</span> <span class="ss">:capitalize</span><span class="p">]},</span> <span class="p">[],</span>
          <span class="p">[]},</span> <span class="m">1</span><span class="p">]}]}]},</span> <span class="m">0</span><span class="p">}</span>

  <span class="c1"># The final step: the call to Enum.join</span>
  <span class="c1"># As before, a 2tuple and missing its first (and only) argument: the result of the Stream.map</span>
  <span class="p">{{{:</span><span class="o">.</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:__aliases__</span><span class="p">,</span> <span class="p">[</span><span class="ss">alias:</span> <span class="no">false</span><span class="p">],</span> <span class="p">[</span><span class="ss">:Enum</span><span class="p">]},</span> <span class="ss">:join</span><span class="p">]},</span> <span class="p">[],</span> <span class="p">[]},</span> <span class="m">0</span><span class="p">}</span>
<span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>To sum up:</p>

<ol>
  <li>
    <p>the list has for items;</p>
  </li>
  <li>
    <p>all items are tuples of size 2 (2tuples);</p>
  </li>
  <li>
    <p>the first element of each 2tuple is an AST;</p>
  </li>
  <li>
    <p>for the 2nd and subsequent tuples, the AST is <strong>missing its first argument</strong></p>
  </li>
  <li>
    <p>the second element of each 2tuple is 0; this is the position of the
<strong>previous</strong> AST in the arguments to the <strong>current</strong> AST i.e. <strong>its missing first argument</strong></p>
  </li>
</ol>

<h2 id="the-macropipe-calla-idorgheadline6a">The Macro.pipe call<a id="orgheadline6"></a></h2>

<p>The <strong>Macro</strong> <em>unpipe</em> call has done most of the heavy lifting.</p>

<p>If you take another peek at the <em>unpipe</em> statement in the <code class="highlighter-rouge">|&gt;</code> macro you’ll see
it destructures the <em>unpipe</em> result - <em>pipeline_tuples</em> in my example code above - to pick out the first 2tuple, and
drop its second element i.e 0 (the <em>index</em>):</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">iex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[{</span><span class="n">first_ast</span><span class="p">,</span> <span class="n">_index</span><span class="p">}</span> <span class="o">|</span> <span class="n">rest_tuples</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipeline_tuples</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The call to <strong>Macro</strong> <em>pipe</em> has the relatively simpler job of creating
as AST that looks like the code when =|&gt; has not been used i.e, from
the above,</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sd">"</span><span class="s2">hello world"</span><span class="p">),</span> <span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The call to <strong>Macro</strong> <em>pipe</em> in the <code class="highlighter-rouge">|&gt;</code> uses a call to Erlang’s <em>foldl</em>
which may not be familar to many who only know Elixir.  So I’m going
the rewrite this step using  the more familiar <strong>Enum</strong> <em>reduce</em></p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c1"># thread the asts together, the first being the inner most</span>
<span class="n">iex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">final_ast</span> <span class="o">=</span> <span class="n">rest_tuples</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">first_ast</span><span class="p">,</span> 
<span class="k">fn</span> <span class="p">{</span><span class="n">rest_ast</span><span class="p">,</span> <span class="n">rest_index</span><span class="p">},</span> <span class="n">this_ast</span> <span class="o">-&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">this_ast</span><span class="p">,</span> <span class="n">rest_ast</span><span class="p">,</span> <span class="n">rest_index</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The <em>pipe</em> inserts the <em>this_ast</em> (e.g “hello world”) as the
<em>rest_index</em> argument (e.g. 0th) in the <em>rest_ast</em> (e.g. the ast for
the call to String.split).</p>

<p>To see what the code for <em>final_ast</em> looks like, <strong>Macro</strong> <em>to_string</em>
will “convert” the AST back to Elixir</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">iex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">final_ast</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>and you should see:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="sd">"</span><span class="s2">Enum.join(Stream.map(String.split(\"</span><span class="n">hello</span> <span class="n">world</span><span class="p">\</span><span class="sd">"</span><span class="s2">), &amp;String.capitalize/1))"</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Voilá!</p>

<h1 id="too-many-pipesa-idorgheadline8a">Too many pipes!<a id="orgheadline8"></a></h1>

<blockquote>
  <p>Yeah well that’s all fine and awesome but, like, you know, too many
pipes dude, too many pipes!</p>
</blockquote>

<p>You may feel having to type
the <code class="highlighter-rouge">|&gt;</code> each time gets a bit old, after all you’ve already signalled
your intention of creating a thread-first pipeline. What I’d really
like to write is something like this:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="o">|&gt;</span> <span class="sd">"</span><span class="s2">hello world"</span> 
   <span class="no">String</span><span class="o">.</span><span class="n">split</span> 
   <span class="no">Stream</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">)</span> 
   <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Of course this will give the parser kittens because each <code class="highlighter-rouge">|&gt;</code> takes <strong>two</strong>
arguments: one on the left and one on the right!  Oh well. Lost cause? Maybe not?</p>

<h1 id="how-about-a-thread-first-macroa-idorgheadline9a">How about a “Thread First” macro?<a id="orgheadline9"></a></h1>

<p>Consider the same code but written like this using a familiar Elixir
<em><a href="http://elixir-lang.org/getting-started/case-cond-and-if.html#doend-blocks">do block</a></em> passed to a macro called <strong>thread-first</strong> (like a <strong>def</strong> with no
arguments and just a <em>do block</em>)</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="n">thread_first</span> <span class="k">do</span>
  <span class="sd">"</span><span class="s2">hello world"</span>
  <span class="no">String</span><span class="o">.</span><span class="n">split</span> 
  <span class="no">Stream</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">)</span> 
  <span class="no">Enum</span><span class="o">.</span><span class="n">join</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>What would a <strong>thread-first</strong> macro need to do to make this work?</p>

<p>You may have wondered why I took so much time explaining how <code class="highlighter-rouge">|&gt;</code> works.
Well its because its implementation holds the answer to my question - and it is really is quite simple.</p>

<p>We’ve already seen how to thread ASTs together using <strong>Macro</strong> <em>pipe</em>.
How can we produce a list of ASTs from the <em>do block</em> to feed <em>pipe</em>?</p>

<p>As you may or may not know a <em><a href="http://elixir-lang.org/getting-started/case-cond-and-if.html#doend-blocks">do block</a></em> is just the value of the <strong>:do</strong>
key in the <a href="http://elixir-lang.org/docs/stable/elixir/Keyword.html">Keyword</a> list passed as the last argument to the macro.</p>

<p>Lets have a stab at writing <strong>thread_first</strong>:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></td><td class="code"><pre><span class="k">defmacro</span> <span class="n">thread_first</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">do</span>

  <span class="c1"># get the statements' asts from the do block</span>
  <span class="p">[</span><span class="n">first_ast</span> <span class="o">|</span> <span class="n">rest_asts</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
  <span class="c1"># fetch the :do key</span>
  <span class="o">|&gt;</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">fetch!</span><span class="p">(</span><span class="ss">:do</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="k">case</span> <span class="k">do</span>

       <span class="c1"># if the do block has multiple statements it will be a __block__</span>
       <span class="c1"># and the statements' asts will be its args</span>
       <span class="p">{</span><span class="ss">:__block__</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">args</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">args</span>

       <span class="c1"># if only one statement in the do block the value of the :do:</span>
       <span class="c1"># key will be the statement's ast</span>
       <span class="n">ast</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">ast</span><span class="p">]</span>

     <span class="k">end</span>

  <span class="c1"># now use Macro.pipe to thread all the statements' asts together</span>
  <span class="c1"># and return the threaded ast</span>
  <span class="n">rest_asts</span>
  <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">first_ast</span><span class="p">,</span>
  <span class="k">fn</span> <span class="n">rest_ast</span><span class="p">,</span> <span class="n">this_ast</span> <span class="o">-&gt;</span>
    <span class="c1"># insert this_ast as the 0th argument of rest_ast</span>
    <span class="no">Macro</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">this_ast</span><span class="p">,</span> <span class="n">rest_ast</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
  <span class="k">end</span><span class="p">)</span>

<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="proof-of-the-puddinga-idorgheadline10a">Proof of the Pudding!<a id="orgheadline10"></a></h1>

<p>Lets do some quick tests.  First the original example creating the <strong>HelloWorld</strong> string.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">thread1: HelloWorld"</span> <span class="k">do</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">thread_first</span> <span class="k">do</span>
    <span class="sd">"</span><span class="s2">hello world"</span> 
    <span class="no">String</span><span class="o">.</span><span class="n">split</span> 
    <span class="no">Stream</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">capitalize</span><span class="o">/</span><span class="m">1</span><span class="p">)</span> 
    <span class="no">Enum</span><span class="o">.</span><span class="n">join</span>
  <span class="k">end</span>

  <span class="n">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="sd">"</span><span class="s2">HelloWorld"</span>

<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>It doesn’t make any sense really to have a single line <strong>do</strong> block but <strong>thread_first</strong> handles it:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">thread2: single-line do block"</span> <span class="k">do</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">thread_first</span> <span class="k">do</span>
    <span class="sd">"</span><span class="s2">hello world"</span> 
  <span class="k">end</span>

  <span class="n">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="sd">"</span><span class="s2">hello world"</span> 

<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>A daft example: a calculator</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">thread3: a calculator"</span> <span class="k">do</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">thread_first</span> <span class="k">do</span>

    <span class="m">42</span>
    <span class="o">+</span> <span class="m">5</span> <span class="c1"># 47</span>
    <span class="o">-</span> <span class="m">17</span> <span class="c1"># 30</span>
    <span class="n">rem</span> <span class="m">26</span> <span class="c1"># remainder is 4 </span>

  <span class="k">end</span>

  <span class="n">assert</span> <span class="m">4</span> <span class="o">==</span> <span class="n">result</span> 

<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="final-wordsa-idorgheadline11a">Final Words<a id="orgheadline11"></a></h1>

<p>A bit of fun but it demonstrates how easy it is to <strong>roll-your-own</strong> code using
<a href="http://elixir-lang.org/">Elixir’s</a> <a href="http://elixir-lang.org/getting-started/meta/macros.html">macros</a>.</p>

<p>My <strong>thread_first</strong> macro has only about 10 lines of actual code. That’s
not only a tribute to the power of Elixir’s macros but also the
standard library that includes utility modules such as <strong>Macro</strong> and <strong>Code</strong> that do so much of the
heavy lifting for you.</p>

<p>Bit of a fess-up. Those of you who know any <a href="http:///clojure.org">Clojure</a>
will have spotted fairly quickly that <strong>thread_first</strong> is equivalent to
<a href="https://clojuredocs.org/clojure.core/&gt;\&#x00ad;&gt;">Clojure’s own thread first macro</a>
→ which I’ve <a href="http://ianrumford.github.io/clojure/sugar/threading/macros/2014/10/24/some-syntactic-sugar-for-clojure-threading-macros.html">written about
here</a>.</p>

<h1 id="final-final-wordsa-idorgheadline12a">Final Final Words<a id="orgheadline12"></a></h1>

<p>People are generally “warned off” writing and using macros. Don’t be.  Use your own judgement when
they are necessary and when not.  And when they are, use them
effectively just like any other feature of Elixir.  And remember: Sometimes only a
macro will do.</p>

<h1 id="code-on-githuba-idorgheadline13a">Code on Github<a id="orgheadline13"></a></h1>

<p>There is not much to the
<a href="https://github.com/ianrumford/elixir-thread-first">code</a>  but its on
<a href="https://github.com/ianrumford/elixir-thread-first">Github</a>
if anybody wants it:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="nb">cd</span> /tmp
git clone git@github.com:ianrumford/elixir-thread-first.git
<span class="nb">cd </span>elixir-thread-first
mix <span class="nb">test</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>


  </article>
  <hr />
</div>


<section class="pager">
  <ul>
    
    <li class="previous"><a href="/clojure/sugar/threading/macros/2014/10/24/some-syntactic-sugar-for-clojure-threading-macros.html" title="Some syntactic sugar for Clojure's threading macros">&larr; Older</a></li>
    
    
    <li class="next"><a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html" title="Adding a Map API to a GenServer or Module with Agent-held State">Newer &rarr;</a></li>
    
  </ul>
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://www.rumford.name/clojure/sugar/threading/macros/2014/10/24/some-syntactic-sugar-for-clojure-threading-macros.html';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://www.rumford.name/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



<div id="disqus_thread"></div>

<script type="text/javascript">

  var disqus_developer = 1;

var disqus_shortname ='';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    <section class="pager">
  
  
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Whistlejacket" src="/images/whistlejacket-circle-128px-2.png" alt="Whistlejacket"/>
  <span>Ian Rumford's whisperings</span>
  <br />

  

  You can contact me via: <br />

  
  <a href="mailto:ian@rumford.name" title="mailto: ian@rumford.name"><i class="fa fa-envelope-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://github.com/ianrumford" title="GithubID: ianrumford"><i class="fa fa-github-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://twitter.com/ianrumford" title="TwitterID: ianrumford"><i class="fa fa-twitter-square fa-3x"></i></a>
  

  

</div>

<div class="sidebar-module">
  <h4>Site Search</h4>
  <form onsubmit="search_google()" >
    <input type="text" id="google-search" placeholder="Google search" />
    <input type="submit" name="sa" value="Go" />
  </form>
</div>


<div class="sidebar-module"> <!-- sidebar-module-inset">-->
  <h4>Copyright Notice</h4>

  

  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
    <img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png">
  </a>
  <br />
  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Attribution-NonCommercial-ShareAlike</a>

  

</div>


<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html" title="Testing Individual Elixir Doctests" rel="bookmark">Testing Individual Elixir Doctests</a>
  </li>
  
  <li>
  <a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html" title="Metaprogramming Without Macros" rel="bookmark">Metaprogramming Without Macros</a>
  </li>
  
  <li>
  <a href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html" title="Sharing and Reusing Elixir Callback Functions between Modules" rel="bookmark">Sharing and Reusing Elixir Callback Functions between Modules</a>
  </li>
  
  <li>
  <a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html" title="Pattern Matching to Polymorphism - an Unexpected Journey" rel="bookmark">Pattern Matching to Polymorphism - an Unexpected Journey</a>
  </li>
  
  <li>
  <a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html" title="Adding a Map API to a GenServer or Module with Agent-held State" rel="bookmark">Adding a Map API to a GenServer or Module with Agent-held State</a>
  </li>
  
</div>


<div class="sidebar-module">
  <h4>Tags</h4>
  
    <a href="/tags/#hello world" title="hello world" rel="1">hello world</a> &nbsp;
  
    <a href="/tags/#octopress" title="octopress" rel="1">octopress</a> &nbsp;
  
    <a href="/tags/#jekyll" title="jekyll" rel="1">jekyll</a> &nbsp;
  
    <a href="/tags/#blog" title="blog" rel="1">blog</a> &nbsp;
  
    <a href="/tags/#emacs" title="emacs" rel="2">emacs</a> &nbsp;
  
    <a href="/tags/#Ubuntu" title="Ubuntu" rel="1">Ubuntu</a> &nbsp;
  
    <a href="/tags/#precise" title="precise" rel="2">precise</a> &nbsp;
  
    <a href="/tags/#pangolin" title="pangolin" rel="1">pangolin</a> &nbsp;
  
    <a href="/tags/#12.04" title="12.04" rel="1">12.04</a> &nbsp;
  
    <a href="/tags/#clojure" title="clojure" rel="1">clojure</a> &nbsp;
  
    <a href="/tags/#leinginen" title="leinginen" rel="1">leinginen</a> &nbsp;
  
    <a href="/tags/#slime" title="slime" rel="1">slime</a> &nbsp;
  
    <a href="/tags/#swank" title="swank" rel="1">swank</a> &nbsp;
  
    <a href="/tags/#ubuntu" title="ubuntu" rel="1">ubuntu</a> &nbsp;
  
    <a href="/tags/#ruby" title="ruby" rel="1">ruby</a> &nbsp;
  
    <a href="/tags/#windows" title="windows" rel="1">windows</a> &nbsp;
  
    <a href="/tags/#ole" title="ole" rel="1">ole</a> &nbsp;
  
    <a href="/tags/#property" title="property" rel="1">property</a> &nbsp;
  
    <a href="/tags/#values" title="values" rel="1">values</a> &nbsp;
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2017" > <a href="/archives/#2017">2017</a></li>
  
  
  
  
  
  
  
  
  
  <li id="2016" > <a href="/archives/#2016">2016</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2014" > <a href="/archives/#2014">2014</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2013" > <a href="/archives/#2013">2013</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2012" > <a href="/archives/#2012">2012</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


</div>



  

  <footer class="site-footer">

  <p>Copyright &copy; <a href="/">An Ostler in IT</a></p>
  <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> 
  on 
  
  <a href="https://github.com/">Github</a>
  
  | Theme <a href="https://github.com/yulijia/freshman21/">Freshman21</a> Design by <a href="http://yulijia.net">Lijia Yu</a>
  | Adapted by Ian Rumford  


  <div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
    <a title="Back To Top"><img src="/images/topbutton.png"/></a>
  </div>

  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/totop.js"></script>  



</footer>


</div>

</body>

</html>
