<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width initial-scale=1">

<meta property="og:title" content="An Ostler in IT">
<title>An Ostler in IT</title>
<meta property="og:description" content="Adventures in self-publicity">
<meta property="og:url" content="http://www.rumford.name/">
<meta property="og:site_name" content="An Ostler in IT">
<meta property="og:locale" content="en_UK">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ianrumford">
<meta name="twitter:creator" content="@ianrumford">
<meta name="twitter:title" content="An Ostler in IT">
<meta name="twitter:description" content="Adventures in self-publicity">
<meta name="twitter:url" content="http://www.rumford.name/">

<meta name="keywords" content="IT Ostler Horses Courses">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://www.rumford.name/">
<link rel="alternate" type="application/atom+xml" title="An Ostler in IT" href="http://www.rumford.name/feed.xml" />

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script language="Javascript" type="text/javascript">
function search_google()
{
  var query = document.getElementById("google-search").value;
  window.open("http://google.com/search?q=" + query
      + "%20site:" + "http://www.rumford.name");
}
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script type='text/javascript'>
var blocklink = ['http://humanorightswatch.org','http://o-o-6-o-o.com','http://darodar.com','http://blackhatworth.com','http://hulfingtonpost.com','http://bestwebsitesawards.com','http://darodar.com','http://buttons-for-website.com','http://ilovevitaly.co','http://semalt.com','http://priceg.com','http://simple-share-buttons.com','http://googlsucks.com','http://4webmasters.org','http://aliexpress.com','http://addons.mozilla.org/en-US/firefox/addon/ilovevitaly/','http://free-share-buttons.com','http://buttons-for-your-website.com','http://theguardlan.com','http://buy-cheap-online.info','http://best-seo-offer.com','http://4webmasters.org','http://trafficmonetize.org','http://howtostopreferralspam.eu','http://ilovevitaly.com','http://sanjosestartups.com','http://free-social-buttons.com','http://best-seo-offer.com','http://guardlink.org','http://www.event-tracking.com','http://www3.free-social-buttons.com','http://www1.free-social-buttons.com','http://www2.free-social-buttons.com','http://websites-reviews.com','http://floating-share-buttons.com','http://satellite.maps.ilovevitaly.com','http://free-social-buttons.com','http://www.event-tracking.com','http://erot.co'];
for (var b = blocklink.length; b--;) {
  if (document.referrer.match(blocklink[b]))
    window.location = "http://www.google.com";
}
</script>



<link type="application/atom+xml" rel="alternate" href="http://www.rumford.name/atom.xml" title="An Ostler in IT" />
</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">An Ostler in IT</a></h1>
    <h3 class="site-meta">Horses for Courses</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/"></a>
        
        
        
        <a class="page-link" href="/feed.xml"></a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="home">
  <div class="post" itemscope itemtype="http://schema.org/BlogPosting" >

    

    <header class="post-header">
      <h1 itemprop="name" class="post-title">
        <a itemprop="url" class="post-link" href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html">Testing Individual Elixir Doctests</a>
      </h1>
      <meta itemprop="keywords" content="" />
      <p class="post-meta">
      Posted in
      
      <a href="/categories/#elixir">elixir</a>, 
      
      <a href="/categories/#doctest">doctest</a>, 
      
      <a href="/categories/#individual">individual</a>
      
      
      <time itemprop="datePublished" datetime="2017-11-20">
        on Nov 20, 2017
      </time>
      </p>
    </header>

    <article class="post-content" itemprop="articleBody">
      
      <p><a id="org76e213e"></a></p>

<h1 id="doctests-ftw">Doctests: FTW!</h1>

<p>I’ve been working on new releases of a couple of my <a href="https://hex.pm/users/ianrumford">published</a> <a href="https://hex.pm/">Hex</a>
packages recently, as well as some new packages that should be soon published
fairly soon.</p>

<p>All of them have <a href="http://elixir-lang.github.io/getting-started/mix-otp/docs-tests-and-with.html">doctests</a>, sometimes a lot of them.</p>

<p>I think <a href="http://elixir-lang.github.io/getting-started/mix-otp/docs-tests-and-with.html">doctests</a> are great; I’m a fan.  “But there’s a problem”</p>


      <p style="text-align: right"><a href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html">Read more</a></p>
      
    </article>
    <hr />

    

    <header class="post-header">
      <h1 itemprop="name" class="post-title">
        <a itemprop="url" class="post-link" href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html">Metaprogramming Without Macros</a>
      </h1>
      <meta itemprop="keywords" content="" />
      <p class="post-meta">
      Posted in
      
      <a href="/categories/#elixir">elixir</a>, 
      
      <a href="/categories/#metaprogramming">metaprogramming</a>, 
      
      <a href="/categories/#postwalk">postwalk</a>
      
      
      <time itemprop="datePublished" datetime="2017-05-17">
        on May 17, 2017
      </time>
      </p>
    </header>

    <article class="post-content" itemprop="articleBody">
      
      <blockquote>
  <p>TL;DR: Code is Data!</p>
</blockquote>

<h1 id="backstorya-idorgheadline1a">Backstory<a id="orgheadline1"></a></h1>

<p>Originally this post was part of another post.  But the whole post was getting too big, so I’ve pulled it out here.</p>

<p>Although really just <em>part one</em>, its really stand-alone and may be of more general interest.</p>

<p>The <a href="https://github.com/ianrumford/metaprogramming_without_macros_examples">repo</a> has the examples.</p>

<h1 id="metaprogramming-with-macrosa-idorgheadline2a">Metaprogramming with Macros<a id="orgheadline2"></a></h1>

<p>I guess anybody who knows anything, has read anything or used
<a href="http://elixir-lang.org/">Elixir</a> at all will be aware the core features of the language are implemented
as a collection of <a href="http://elixir-lang.org/getting-started/meta/macros.html">macros</a>  – the
<a href="http://elixir-lang.org/docs/v1.0/elixir/Kernel.SpecialForms.html">special forms</a>.</p>

<p>Elixir’s macro support is incredibly useful and I’d recommend anybody
interested in learning some of the <em>nitty-gritty</em> to read
<a href="https://twitter.com/chris_mccord">Chris’s</a> <a href="https://pragprog.com/book/cmelixir/metaprogramming-elixir">excellent
book</a>.  Alternatively, there are also many excellent blog articles out there (like <a href="http://www.theerlangelist.com/2014/06/understanding-elixir-macros-part-1.html">Sasa’s</a>), 
and I’ve even had a <a href="http://ianrumford.github.io/elixir/pipe/clojure/thread-first/macro/2016/07/24/writing-your-own-elixir-pipe-operator.html">go</a> myself.</p>

<p>At the heart of macros are <a href="http://elixir-lang.org/getting-started/meta/quote-and-unquote.html">quoted forms</a>,
Elixir’s name for its <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree</a> (<em>AST</em>) representation.</p>

<p>When you run a macro, Elixir passes the arguments as quoted form(s) and
expects quoted form(s) as the result (which will then be compiled). Inside the macro though, its just <em>regular Elixir code</em>, albeit manipulating ASTs.</p>

<p>I tend to think of the relationship (contract) between the Elixir compiler and a macro as 
simply this:</p>

<blockquote>
  <p>I’ll maybe pass you some asts, do what you want with them but give me back some asts and I’ll compile them for you.</p>
</blockquote>

<p>But macros are not the only or best answer to some metaprogramming needs.</p>


      <p style="text-align: right"><a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html">Read more</a></p>
      
    </article>
    <hr />

    

    <header class="post-header">
      <h1 itemprop="name" class="post-title">
        <a itemprop="url" class="post-link" href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html">Sharing and Reusing Elixir Callback Functions between Modules</a>
      </h1>
      <meta itemprop="keywords" content="" />
      <p class="post-meta">
      Posted in
      
      <a href="/categories/#elixir">elixir</a>, 
      
      <a href="/categories/#siariwyd">siariwyd</a>, 
      
      <a href="/categories/#callback">callback</a>, 
      
      <a href="/categories/#function">function</a>, 
      
      <a href="/categories/#share">share</a>, 
      
      <a href="/categories/#reuse">reuse</a>
      
      
      <time itemprop="datePublished" datetime="2016-11-17">
        on Nov 17, 2016
      </time>
      </p>
    </header>

    <article class="post-content" itemprop="articleBody">
      
      <blockquote>
  <p>TL;DR: Sharing and Reusing Functions in Elixir is easy. Unless its a Callback.</p>
</blockquote>

<h1 id="theres-a-problema-idorgheadline1a">There’s a problem?<a id="orgheadline1"></a></h1>

<p>Using a public <a href="http://elixir-lang.org/">Elixir</a> function defined in one module
(e.g. <em>DonorA</em>) in another (e.g. <em>Recipient1</em>)  is easy: just call it with the
fully qualified name:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">DonorA</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">donor_a_fun_j</span> <span class="k">do</span>
    <span class="ss">:donor_a_fun_j</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">defmodule</span> <span class="no">Recipient1</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">recipient_a_fun_p</span> <span class="k">do</span>
    <span class="no">DonorA</span><span class="o">.</span><span class="n">donor_a_fun_j</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Proof of the pudding:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">test_donor_a_recipient_1_donor_a_fun_j"</span> <span class="k">do</span>
  <span class="n">assert</span> <span class="ss">:donor_a_fun_j</span> <span class="o">=</span> <span class="no">Recipient1</span><span class="o">.</span><span class="n">recipient_a_fun_p</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><em>Fine. Good. Job Done. End of Post. Thanks for reading.</em></p>

<p>No wait …</p>


      <p style="text-align: right"><a href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html">Read more</a></p>
      
    </article>
    <hr />

    

    <header class="post-header">
      <h1 itemprop="name" class="post-title">
        <a itemprop="url" class="post-link" href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html">Pattern Matching to Polymorphism - an Unexpected Journey</a>
      </h1>
      <meta itemprop="keywords" content="" />
      <p class="post-meta">
      Posted in
      
      <a href="/categories/#elixir">elixir</a>, 
      
      <a href="/categories/#pattern">pattern</a>, 
      
      <a href="/categories/#matching">matching</a>, 
      
      <a href="/categories/#runtime">runtime</a>, 
      
      <a href="/categories/#polymorphism">polymorphism</a>
      
      
      <time itemprop="datePublished" datetime="2016-09-19">
        on Sep 19, 2016
      </time>
      </p>
    </header>

    <article class="post-content" itemprop="articleBody">
      
      <p>When I first started learning  <a href="http://elixir-lang.org/">Elixir</a>,  I didn’t begin to appreciate the power of pattern matching
until I’d read <a href="http://theerlangelist.com/">Sasa’s</a>
<a href="https://www.manning.com/books/elixir-in-action">book</a> and <a href="https://pragdave.me/">Dave’s</a>
<a href="https://pragprog.com/book/elixir/programming-elixir">book</a>. Chapter 5 in Dave’s book had some
really good prose explaining pattern matching the arguments of anonymous and
(Chapter 6) named functions.</p>

<p>But it took me a while to assimilate what the Elixir (and <a href="http://www.erlang.org/">Erlang</a>)
books were telling me, so I started writing my Elixir functions
rather ignorant of how I could better structure them.</p>

<p>But as ignorance was displaced by experience with Elixir, I started to use pattern
matching for functions all over the place, once I’d “seen” that many of
my functions were variations (<em>variants</em>) on the same theme, really families of functions 
with the same purpose.</p>

<p>After a while of using <em>bread’n’butter</em> function matching, I found I’d
developed a style of using pattern matching to create a <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a>
with its own set of <em>verbs</em>.</p>

<p>Then I’d write dsl programs using the <em>verbs</em>. Coffee anyone?</p>


      <p style="text-align: right"><a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html">Read more</a></p>
      
    </article>
    <hr />

    

    <header class="post-header">
      <h1 itemprop="name" class="post-title">
        <a itemprop="url" class="post-link" href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html">Adding a Map API to a GenServer or Module with Agent-held State</a>
      </h1>
      <meta itemprop="keywords" content="" />
      <p class="post-meta">
      Posted in
      
      <a href="/categories/#elixir">elixir</a>, 
      
      <a href="/categories/#map">map</a>, 
      
      <a href="/categories/#api">api</a>, 
      
      <a href="/categories/#genserver">genserver</a>, 
      
      <a href="/categories/#module">module</a>, 
      
      <a href="/categories/#agent">agent</a>, 
      
      <a href="/categories/#state">state</a>
      
      
      <time itemprop="datePublished" datetime="2016-09-13">
        on Sep 13, 2016
      </time>
      </p>
    </header>

    <article class="post-content" itemprop="articleBody">
      
      <blockquote>
  <p>TL;DR: A macro to generate a Map API for a GenServer’s state or a Module with Agent-held state</p>
</blockquote>

<h1 id="the-trouble-with-statea-idorgheadline1a">The Trouble with State<a id="orgheadline1"></a></h1>

<p>Modules often need to keep state and share it but, as <a href="http://elixir-lang.org/getting-started/mix-otp/agent.html">getting started</a> says</p>

<blockquote>
  <p>Elixir is an immutable language where nothing is shared by default.</p>
</blockquote>

<p>In Elixir there are two basic ways of sharing state: <a href="http://elixir-lang.org/getting-started/processes.html">processes</a> and <a href="http://elixir-lang.org/getting-started/mix-otp/ets.html">ETS</a> 
(which I wont consider further).</p>

<p>Arguably the most common way of implementing process-held state is
<a href="http://elixir-lang.org/getting-started/mix-otp/genserver.html">GenServer</a>. But for a module that does little
more than hold state, <a href="http://elixir-lang.org/getting-started/mix-otp/genserver.html">GenServer</a> can be overkill.
As an alternative, an <a href="http://elixir-lang.org/docs/stable/elixir/Agent.html">Agent</a> provides a simpler,
alternative way for a module to hold and manage its state.</p>

<p>But neither <a href="http://elixir-lang.org/getting-started/mix-otp/genserver.html">GenServer</a> nor <a href="http://elixir-lang.org/docs/stable/elixir/Agent.html">Agent</a> provide any built-in API calls to manage the <strong>content</strong> of the
state, not surprisingly as the state’s value can be anything.</p>

<p>More often than not though, I want the state to be a <a href="http://elixir-lang.org/docs/stable/elixir/Map.html">map</a>, and sometimes
with keys that are (sub)maps.  So I usually want to make Map-like API calls —
<em>get</em>, <em>put</em>, <em>take</em>, <em>update</em> etc — both for the state itself and
any submaps.</p>

<p>Previously, I’ve written the wrappers manually.
This is not hard  but is just a bit tedious to do given the possible
combinations of state wrappers, submap wrappers, arities, etc (lots
and lots of <em>cut’n’paste’edit</em>!).  So recently I’ve bitten the bullet
and written a first cut of a <a href="http://elixir-lang.org/getting-started/meta/macros.html">macro</a> to do the heavy lifting.</p>

<p>The interface I wanted for my applications’ modules was to simply <em>use</em>
the module (that I’ve called <strong>Amlapio</strong>) that makes the API
<strong>wrapper</strong> functions.</p>

<blockquote>
  <p>As many will already know <em>use</em> calls the <em>__using__</em> macro in the
module being used, and the code generated by <em>__using__</em> is injected
into the caller module.</p>
</blockquote>

<p>Here’s an example (from the repo’s tests) of a module using an
<a href="http://elixir-lang.org/docs/stable/elixir/Agent.html">Agent</a> to hold its state.</p>

<p>The wanted submap wrappers are defined by the <em>agent: [:buttons, :menus, :checkboxes]</em> option.</p>

<p>To generate state wrappers the submaps have been set to nil: <em>agent: nil</em></p>

<p>Generating wrappers for only a subset of Map functions can be given using the <em>funs</em>
options e.g, for the state wrappers, <em>funs: [:get, :put, :pop]</em></p>

<p>Finally, a <em>namer</em> function has been given to name the state wrappers.  It
is passed two arguments: the map name (e.g. <em>buttons</em> for a submap,
but <em>nil</em> for a state wrapper) and the Map function name (e.g. <em>pop</em>).</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">ExampleAgent1</span> <span class="k">do</span>

  <span class="c1"># generate wrappers for three submaps</span>
  <span class="kn">use</span> <span class="no">Amlapio</span><span class="p">,</span> <span class="ss">agent:</span> <span class="p">[</span><span class="ss">:buttons</span><span class="p">,</span> <span class="ss">:menus</span><span class="p">,</span> <span class="ss">:checkboxes</span><span class="p">]</span>

  <span class="c1"># generate *only* get, put and pop wrappers for the state itself and</span>
  <span class="c1"># use a namer function to name the wrappers "agent_state_get",</span>
  <span class="c1"># "agent_state_put" and "agent_state_pop"</span>
  <span class="kn">use</span> <span class="no">Amlapio</span><span class="p">,</span> <span class="ss">agent:</span> <span class="no">nil</span><span class="p">,</span> <span class="ss">funs:</span> <span class="p">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:put</span><span class="p">,</span> <span class="ss">:pop</span><span class="p">],</span>
    <span class="ss">namer:</span> <span class="k">fn</span> <span class="n">_map_name</span><span class="p">,</span> <span class="n">fun_name</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">agent_state_"</span><span class="p">,</span> <span class="n">to_string</span><span class="p">(</span><span class="n">fun_name</span><span class="p">)]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">to_atom</span>
  <span class="k">end</span>

  <span class="c1"># create the agent; note the default state is an empty map</span>
  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">state</span> <span class="p">\\</span> <span class="p">%{})</span> <span class="k">do</span>
    <span class="no">Agent</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">state</span> <span class="k">end</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>These tests from the repo show how the submap wrappers would be used,
pretty much how you’d expect.  (The repo has tests for the state wrappers as well.)</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="n">test</span> <span class="sd">"</span><span class="s2">agent_submap1"</span> <span class="k">do</span>

  <span class="n">buttons_state</span> <span class="o">=</span> <span class="p">%{</span><span class="m">1</span> <span class="o">=&gt;</span> <span class="ss">:button_back</span><span class="p">,</span> <span class="m">2</span> <span class="o">=&gt;</span> <span class="ss">:button_next</span><span class="p">,</span> <span class="m">3</span> <span class="o">=&gt;</span> <span class="ss">:button_exit</span><span class="p">}</span>
  <span class="n">menus_state</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">menu_a:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">menu_b:</span> <span class="ss">:two</span><span class="p">,</span> <span class="ss">menu_c:</span> <span class="sd">"</span><span class="s2">tre"</span><span class="p">}</span>
  <span class="n">checkboxes_state</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">checkbox_yesno:</span> <span class="p">[</span><span class="ss">:yes</span><span class="p">,</span> <span class="ss">:no</span><span class="p">],</span> <span class="ss">checkbox_bool:</span> <span class="p">[</span><span class="no">true</span><span class="p">,</span> <span class="no">false</span><span class="p">]}</span>
  <span class="n">agent_state</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">buttons:</span> <span class="n">buttons_state</span><span class="p">,</span> 
                  <span class="ss">menus:</span> <span class="n">menus_state</span><span class="p">,</span> <span class="ss">checkboxes:</span> <span class="n">checkboxes_state</span><span class="p">}</span>

  <span class="c1"># create the agent</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">agent</span><span class="p">}</span> <span class="o">=</span> <span class="no">ExampleAgent1</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">agent_state</span><span class="p">)</span>

  <span class="c1"># some usage examples</span>

  <span class="n">assert</span> <span class="ss">:button_back</span> <span class="o">==</span> <span class="n">agent</span> <span class="o">|&gt;</span> <span class="no">ExampleAgent1</span><span class="o">.</span><span class="n">buttons_get</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="n">assert</span> <span class="ss">:button_default</span> <span class="o">==</span> 
    <span class="n">agent</span> <span class="o">|&gt;</span> <span class="no">ExampleAgent1</span><span class="o">.</span><span class="n">buttons_get</span><span class="p">(</span><span class="m">99</span><span class="p">,</span> <span class="ss">:button_default</span><span class="p">)</span>

  <span class="n">assert</span> <span class="n">agent</span> <span class="o">==</span> <span class="n">agent</span> <span class="o">|&gt;</span> <span class="no">ExampleAgent1</span><span class="o">.</span><span class="n">menus_put</span><span class="p">(</span><span class="ss">:menu_d</span><span class="p">,</span> <span class="m">42</span><span class="p">)</span>
  <span class="n">assert</span> <span class="n">menus_state</span> <span class="o">|&gt;</span> <span class="no">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="ss">:menu_d</span><span class="p">,</span> <span class="m">42</span><span class="p">)</span> <span class="o">==</span> <span class="n">agent</span> <span class="o">|&gt;</span> <span class="no">ExampleAgent1</span><span class="o">.</span><span class="n">agent_state_get</span><span class="p">(</span><span class="ss">:menus</span><span class="p">)</span>

  <span class="n">assert</span> <span class="p">{[</span><span class="ss">:yes</span><span class="p">,</span> <span class="ss">:no</span><span class="p">],</span> <span class="n">agent</span><span class="p">}</span> <span class="o">==</span> 
    <span class="n">agent</span> <span class="o">|&gt;</span> <span class="no">ExampleAgent1</span><span class="o">.</span><span class="n">checkboxes_pop</span><span class="p">(</span><span class="ss">:checkbox_yesno</span><span class="p">)</span>

<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Creating wrappers for a GenServer’s state is very similar. However,
each wrapper has two “parts”: an <em>api</em> function and a <em>handle_call</em> function.</p>

<p>The <em>api</em> wrapper for e.g. `buttons_get/3` looks like this:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c1"># api wrapper for buttons_get</span>
<span class="k">def</span> <span class="n">buttons_get</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">button_name</span><span class="p">,</span> <span class="n">button_default</span> <span class="p">\\</span> <span class="no">nil</span><span class="p">)</span> <span class="k">do</span>
 <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">{</span><span class="ss">:buttons_get</span><span class="p">,</span> <span class="n">button_name</span><span class="p">,</span> <span class="n">button_default</span><span class="p">})</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>… while the matching <em>handle_call</em> looks like:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="k">def</span> <span class="n">handle_call</span><span class="p">({</span><span class="ss">:buttons_get</span><span class="p">,</span> <span class="n">button_name</span><span class="p">,</span> <span class="n">button_default</span><span class="p">},</span> <span class="n">_fromref</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">state</span> <span class="o">|&gt;</span> <span class="no">Map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:buttons</span><span class="p">,</span> <span class="p">%{})</span> <span class="o">|&gt;</span> <span class="no">Map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">button_name</span><span class="p">,</span> <span class="n">button_default</span><span class="p">)</span>
  <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Here’s example of generating wrappers for a GenServer.</p>

<blockquote>
  <p>Remember: all <em>handle_call</em> functions must be kept together in the source else the compiler will complain.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td class="code"><pre><span class="k">defmodule</span> <span class="no">ExampleGenServer1</span> <span class="k">do</span>

  <span class="c1"># its a genserver</span>
  <span class="kn">use</span> <span class="no">GenServer</span>

  <span class="c1"># generate API wrappers for three submaps</span>
  <span class="kn">use</span> <span class="no">Amlapio</span><span class="p">,</span> <span class="ss">genserver_api:</span> <span class="p">[</span><span class="ss">:buttons</span><span class="p">,</span> <span class="ss">:menus</span><span class="p">,</span> <span class="ss">:checkboxes</span><span class="p">]</span>

  <span class="c1"># generate *only* get, put, pop and take wrappers for the state itself and</span>
  <span class="c1"># use a namer function to name the wrappers "state_get",</span>
  <span class="c1"># "state_put", "state_pop", and "state_take"</span>
  <span class="kn">use</span> <span class="no">Amlapio</span><span class="p">,</span> <span class="ss">genserver_api:</span> <span class="no">nil</span><span class="p">,</span> <span class="ss">funs:</span> <span class="p">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:put</span><span class="p">,</span> <span class="ss">:pop</span><span class="p">,</span> <span class="ss">:take</span><span class="p">],</span>
    <span class="ss">namer:</span> <span class="k">fn</span> <span class="n">_map_name</span><span class="p">,</span> <span class="n">fun_name</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">state_"</span><span class="p">,</span> <span class="n">to_string</span><span class="p">(</span><span class="n">fun_name</span><span class="p">)]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">to_atom</span>
  <span class="k">end</span>

  <span class="c1"># create the genserver; note the default state is an empty map</span>
  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">state</span> <span class="p">\\</span> <span class="p">%{})</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># &lt;&lt; more functions&gt;&gt;</span>

  <span class="c1"># handle_calls start here</span>

  <span class="c1"># generate the handle_call functions for three submaps' wrappers</span>
  <span class="kn">use</span> <span class="no">Amlapio</span><span class="p">,</span> <span class="ss">genserver_handle_call:</span> <span class="p">[</span><span class="ss">:buttons</span><span class="p">,</span> <span class="ss">:menus</span><span class="p">,</span> <span class="ss">:checkboxes</span><span class="p">]</span>

  <span class="c1"># generate the handle_call functions for the state wrappers.</span>
  <span class="kn">use</span> <span class="no">Amlapio</span><span class="p">,</span> <span class="ss">genserver_handle_call:</span> <span class="no">nil</span><span class="p">,</span> <span class="ss">funs:</span> <span class="p">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:put</span><span class="p">,</span> <span class="ss">:pop</span><span class="p">,</span> <span class="ss">:take</span><span class="p">],</span>
    <span class="ss">namer:</span> <span class="k">fn</span> <span class="n">_map_name</span><span class="p">,</span> <span class="n">fun_name</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">state_"</span><span class="p">,</span> <span class="n">to_string</span><span class="p">(</span><span class="n">fun_name</span><span class="p">)]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">to_atom</span>
  <span class="k">end</span>

<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>There are tests got the GenServer example in the <a href="https://github.com/ianrumford/amlapio">repo</a> but
they look almost identical to the Agent example.</p>

<p>If you just want to give it a whirl, that
pretty much it. Its available on <a href="https://hex.pm/">Hex</a> and just needs to be
added to the dependencies in <em>mix.exs</em> in the usual way.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span><span class="ss">:amlapio</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 0.1.0"</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>But if you are interested in a high-level explanation of how I implemented <strong>Amlapio</strong>, read on.</p>


      <p style="text-align: right"><a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html">Read more</a></p>
      
    </article>
    <hr />

    

  </div>
</div>

    <section class="pager">
  
  
  <li class="next"><a href="/page2/" title="Older">Older &rarr;</a></li>
  
</section>

<script src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = '/page2/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>



  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Whistlejacket" src="/images/whistlejacket-circle-128px-2.png" alt="Whistlejacket"/>
  <span>Ian Rumford's whisperings</span>
  <br />

  

  You can contact me via: <br />

  
  <a href="mailto:ian@rumford.name" title="mailto: ian@rumford.name"><i class="fa fa-envelope-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://github.com/ianrumford" title="GithubID: ianrumford"><i class="fa fa-github-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://twitter.com/ianrumford" title="TwitterID: ianrumford"><i class="fa fa-twitter-square fa-3x"></i></a>
  

  

</div>

<div class="sidebar-module">
  <h4>Site Search</h4>
  <form onsubmit="search_google()" >
    <input type="text" id="google-search" placeholder="Google search" />
    <input type="submit" name="sa" value="Go" />
  </form>
</div>


<div class="sidebar-module"> <!-- sidebar-module-inset">-->
  <h4>Copyright Notice</h4>

  

  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
    <img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png">
  </a>
  <br />
  <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Attribution-NonCommercial-ShareAlike</a>

  

</div>


<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="/elixir/doctest/individual/2017/11/20/testing-individual-elixir-doctests.html" title="Testing Individual Elixir Doctests" rel="bookmark">Testing Individual Elixir Doctests</a>
  </li>
  
  <li>
  <a href="/elixir/metaprogramming/postwalk/2017/05/17/metaprogramming-without-macros.html" title="Metaprogramming Without Macros" rel="bookmark">Metaprogramming Without Macros</a>
  </li>
  
  <li>
  <a href="/elixir/siariwyd/callback/function/share/reuse/2016/11/17/siariwyd.html" title="Sharing and Reusing Elixir Callback Functions between Modules" rel="bookmark">Sharing and Reusing Elixir Callback Functions between Modules</a>
  </li>
  
  <li>
  <a href="/elixir/pattern/matching/runtime/polymorphism/2016/09/19/pattern-matching-to-polymorphism.html" title="Pattern Matching to Polymorphism - an Unexpected Journey" rel="bookmark">Pattern Matching to Polymorphism - an Unexpected Journey</a>
  </li>
  
  <li>
  <a href="/elixir/map/api/genserver/module/agent/state/2016/09/13/amlapio.html" title="Adding a Map API to a GenServer or Module with Agent-held State" rel="bookmark">Adding a Map API to a GenServer or Module with Agent-held State</a>
  </li>
  
</div>


<div class="sidebar-module">
  <h4>Tags</h4>
  
    <a href="/tags/#hello world" title="hello world" rel="1">hello world</a> &nbsp;
  
    <a href="/tags/#octopress" title="octopress" rel="1">octopress</a> &nbsp;
  
    <a href="/tags/#jekyll" title="jekyll" rel="1">jekyll</a> &nbsp;
  
    <a href="/tags/#blog" title="blog" rel="1">blog</a> &nbsp;
  
    <a href="/tags/#emacs" title="emacs" rel="2">emacs</a> &nbsp;
  
    <a href="/tags/#Ubuntu" title="Ubuntu" rel="1">Ubuntu</a> &nbsp;
  
    <a href="/tags/#precise" title="precise" rel="2">precise</a> &nbsp;
  
    <a href="/tags/#pangolin" title="pangolin" rel="1">pangolin</a> &nbsp;
  
    <a href="/tags/#12.04" title="12.04" rel="1">12.04</a> &nbsp;
  
    <a href="/tags/#clojure" title="clojure" rel="1">clojure</a> &nbsp;
  
    <a href="/tags/#leinginen" title="leinginen" rel="1">leinginen</a> &nbsp;
  
    <a href="/tags/#slime" title="slime" rel="1">slime</a> &nbsp;
  
    <a href="/tags/#swank" title="swank" rel="1">swank</a> &nbsp;
  
    <a href="/tags/#ubuntu" title="ubuntu" rel="1">ubuntu</a> &nbsp;
  
    <a href="/tags/#ruby" title="ruby" rel="1">ruby</a> &nbsp;
  
    <a href="/tags/#windows" title="windows" rel="1">windows</a> &nbsp;
  
    <a href="/tags/#ole" title="ole" rel="1">ole</a> &nbsp;
  
    <a href="/tags/#property" title="property" rel="1">property</a> &nbsp;
  
    <a href="/tags/#values" title="values" rel="1">values</a> &nbsp;
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2017" > <a href="/archives/#2017">2017</a></li>
  
  
  
  
  
  
  
  
  
  <li id="2016" > <a href="/archives/#2016">2016</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2014" > <a href="/archives/#2014">2014</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2013" > <a href="/archives/#2013">2013</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li id="2012" > <a href="/archives/#2012">2012</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


</div>



  

  <footer class="site-footer">

  <p>Copyright &copy; <a href="/">An Ostler in IT</a></p>
  <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> 
  on 
  
  <a href="https://github.com/">Github</a>
  
  | Theme <a href="https://github.com/yulijia/freshman21/">Freshman21</a> Design by <a href="http://yulijia.net">Lijia Yu</a>
  | Adapted by Ian Rumford  


  <div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
    <a title="Back To Top"><img src="/images/topbutton.png"/></a>
  </div>

  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/totop.js"></script>  



</footer>


</div>

</body>

</html>
